name: ğŸš€ çµ±ä¸€éƒ¨ç½²æµç¨‹

on:
  push:
    branches: [ main ]
    paths:
      - 'main.py'
      - 'telegram_main.py'
      - 'telegram_app.py'
      - 'app.py'
      - 'requirements*.txt'
      - 'zeabur.json'
      - '.github/workflows/unified-deploy.yml'
  workflow_dispatch:
    inputs:
      service_type:
        description: 'éƒ¨ç½²æœå‹™é¡å‹'
        required: true
        default: 'telegram-bot'
        type: choice
        options:
        - telegram-bot
        - line-bot
        - both
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
        - development
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½² (è·³éæª¢æŸ¥)'
        required: false
        default: false
        type: boolean
      deploy_strategy:
        description: 'éƒ¨ç½²ç­–ç•¥'
        required: false
        default: 'update-existing'
        type: choice
        options:
        - update-existing
        - create-new
        - blue-green

env:
  SERVICE_TYPE: ${{ github.event.inputs.service_type || 'telegram-bot' }}
  ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}
  DEPLOY_STRATEGY: ${{ github.event.inputs.deploy_strategy || 'update-existing' }}

jobs:
  detect-changes:
    name: ğŸ“Š è®Šæ›´æª¢æ¸¬å’Œæœå‹™é¸æ“‡
    runs-on: ubuntu-latest
    
    outputs:
      should_deploy_telegram: ${{ steps.detect.outputs.should_deploy_telegram }}
      should_deploy_line: ${{ steps.detect.outputs.should_deploy_line }}
      telegram_changes: ${{ steps.detect.outputs.telegram_changes }}
      line_changes: ${{ steps.detect.outputs.line_changes }}
      common_changes: ${{ steps.detect.outputs.common_changes }}
      
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: ğŸ•µï¸ åˆ†æè®Šæ›´çš„æ–‡ä»¶
      id: detect
      run: |
        echo "ğŸ•µï¸ åˆ†æè®Šæ›´çš„æ–‡ä»¶..."
        
        # ç²å–è®Šæ›´çš„æ–‡ä»¶åˆ—è¡¨
        if [ "${{ github.event_name }}" = "push" ]; then
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        else
          # æ‰‹å‹•è§¸ç™¼ï¼Œæª¢æŸ¥æœ€è¿‘çš„æäº¤
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
        fi
        
        echo "è®Šæ›´çš„æ–‡ä»¶:"
        echo "$CHANGED_FILES"
        
        # åˆ†ææ–‡ä»¶è®Šæ›´é¡å‹
        telegram_files=("main.py" "telegram_main.py" "telegram_app.py" "telegram_bot_handler.py" "requirements-telegram.txt")
        line_files=("app.py" "line_bot_handler.py" "requirements.txt" "requirements-line.txt")
        common_files=("config.py" "name_card_processor.py" "notion_manager.py" "batch_manager.py" "multi_card_processor.py" "user_interaction_handler.py" "address_normalizer.py")
        
        telegram_changed=false
        line_changed=false
        common_changed=false
        
        # æª¢æŸ¥ Telegram ç›¸é—œæ–‡ä»¶
        for file in "${telegram_files[@]}"; do
          if echo "$CHANGED_FILES" | grep -q "^$file$"; then
            telegram_changed=true
            echo "ğŸ“± Telegram æ–‡ä»¶è®Šæ›´: $file"
          fi
        done
        
        # æª¢æŸ¥ LINE ç›¸é—œæ–‡ä»¶
        for file in "${line_files[@]}"; do
          if echo "$CHANGED_FILES" | grep -q "^$file$"; then
            line_changed=true
            echo "ğŸ“ LINE æ–‡ä»¶è®Šæ›´: $file"
          fi
        done
        
        # æª¢æŸ¥å…±ç”¨æ–‡ä»¶
        for file in "${common_files[@]}"; do
          if echo "$CHANGED_FILES" | grep -q "^$file$"; then
            common_changed=true
            echo "ğŸ”— å…±ç”¨æ–‡ä»¶è®Šæ›´: $file"
          fi
        done
        
        # æ±ºå®šéƒ¨ç½²ç­–ç•¥
        should_deploy_telegram=false
        should_deploy_line=false
        
        case "${{ env.SERVICE_TYPE }}" in
          "telegram-bot")
            should_deploy_telegram=true
            ;;
          "line-bot")
            should_deploy_line=true
            ;;
          "both")
            should_deploy_telegram=true
            should_deploy_line=true
            ;;
          *)
            # è‡ªå‹•æª¢æ¸¬æ¨¡å¼
            if [ "$telegram_changed" = true ] || [ "$common_changed" = true ]; then
              should_deploy_telegram=true
            fi
            if [ "$line_changed" = true ] || [ "$common_changed" = true ]; then
              should_deploy_line=true
            fi
            ;;
        esac
        
        echo "should_deploy_telegram=$should_deploy_telegram" >> $GITHUB_OUTPUT
        echo "should_deploy_line=$should_deploy_line" >> $GITHUB_OUTPUT
        echo "telegram_changes=$telegram_changed" >> $GITHUB_OUTPUT
        echo "line_changes=$line_changed" >> $GITHUB_OUTPUT
        echo "common_changes=$common_changed" >> $GITHUB_OUTPUT
        
        echo ""
        echo "ğŸ“‹ éƒ¨ç½²æ±ºç­–:"
        echo "- Telegram Bot: $should_deploy_telegram"
        echo "- LINE Bot: $should_deploy_line"

  pre-deploy-checks:
    name: ğŸ” é éƒ¨ç½²æª¢æŸ¥
    runs-on: ubuntu-latest
    needs: detect-changes
    if: ${{ !github.event.inputs.force_deploy }}
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        
        # æ ¹æ“šéƒ¨ç½²é¡å‹å®‰è£ç›¸æ‡‰ä¾è³´
        if [ "${{ needs.detect-changes.outputs.should_deploy_telegram }}" = "true" ]; then
          echo "ğŸ“¦ å®‰è£ Telegram Bot ä¾è³´..."
          pip install -r requirements-telegram.txt
        fi
        
        if [ "${{ needs.detect-changes.outputs.should_deploy_line }}" = "true" ]; then
          echo "ğŸ“¦ å®‰è£ LINE Bot ä¾è³´..."
          pip install -r requirements.txt
        fi
        
    - name: ğŸ” èªæ³•å’Œçµæ§‹æª¢æŸ¥
      run: |
        echo "ğŸ” åŸ·è¡Œèªæ³•æª¢æŸ¥..."
        
        # æª¢æŸ¥å…±ç”¨æ ¸å¿ƒæ¨¡çµ„
        core_files=("config.py" "name_card_processor.py" "notion_manager.py" "batch_manager.py")
        for file in "${core_files[@]}"; do
          if [ -f "$file" ]; then
            python -m py_compile "$file"
            echo "âœ… $file èªæ³•æª¢æŸ¥é€šé"
          fi
        done
        
        # æª¢æŸ¥ Telegram Bot æ–‡ä»¶
        if [ "${{ needs.detect-changes.outputs.should_deploy_telegram }}" = "true" ]; then
          telegram_files=("main.py" "telegram_main.py" "telegram_app.py")
          for file in "${telegram_files[@]}"; do
            if [ -f "$file" ]; then
              python -m py_compile "$file"
              echo "âœ… Telegram: $file èªæ³•æª¢æŸ¥é€šé"
            fi
          done
        fi
        
        # æª¢æŸ¥ LINE Bot æ–‡ä»¶
        if [ "${{ needs.detect-changes.outputs.should_deploy_line }}" = "true" ]; then
          line_files=("app.py" "line_bot_handler.py")
          for file in "${line_files[@]}"; do
            if [ -f "$file" ]; then
              python -m py_compile "$file"
              echo "âœ… LINE: $file èªæ³•æª¢æŸ¥é€šé"
            fi
          done
        fi
        
    - name: ğŸ“‹ éƒ¨ç½²æ–‡ä»¶æª¢æŸ¥
      run: |
        echo "ğŸ“‹ æª¢æŸ¥éƒ¨ç½²é…ç½®æ–‡ä»¶..."
        
        # æª¢æŸ¥ zeabur.json
        if [ -f "zeabur.json" ]; then
          echo "âœ… zeabur.json å­˜åœ¨"
          python -m json.tool zeabur.json > /dev/null && echo "âœ… zeabur.json æ ¼å¼æ­£ç¢º"
        else
          echo "âš ï¸ zeabur.json ä¸å­˜åœ¨ï¼Œå°‡åœ¨éƒ¨ç½²æ™‚å‰µå»º"
        fi
        
        # æª¢æŸ¥ä¾è³´æ–‡ä»¶
        if [ "${{ needs.detect-changes.outputs.should_deploy_telegram }}" = "true" ]; then
          if [ -f "requirements-telegram.txt" ]; then
            echo "âœ… requirements-telegram.txt å­˜åœ¨"
          else
            echo "âŒ requirements-telegram.txt ç¼ºå¤±"
            exit 1
          fi
        fi
        
        if [ "${{ needs.detect-changes.outputs.should_deploy_line }}" = "true" ]; then
          if [ -f "requirements.txt" ]; then
            echo "âœ… requirements.txt å­˜åœ¨"
          else
            echo "âŒ requirements.txt ç¼ºå¤±"
            exit 1
          fi
        fi

  deploy-telegram-bot:
    name: ğŸ“± éƒ¨ç½² Telegram Bot
    runs-on: ubuntu-latest
    needs: [detect-changes, pre-deploy-checks]
    if: always() && needs.detect-changes.outputs.should_deploy_telegram == 'true' && (needs.pre-deploy-checks.result == 'success' || needs.pre-deploy-checks.result == 'skipped')
    
    environment: 
      name: ${{ env.ENVIRONMENT }}
      url: ${{ steps.deploy.outputs.telegram_url }}
      
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ å®‰è£ Zeabur CLI
      run: |
        echo "ğŸ“¦ å®‰è£ Zeabur CLI..."
        npm install -g @zeabur/cli@latest
        zeabur --version
        
    - name: ğŸ” é…ç½® Zeabur èªè­‰
      run: |
        echo "ğŸ” é…ç½® Zeabur èªè­‰..."
        echo "${{ secrets.ZEABUR_TOKEN }}" | zeabur auth login --token
        
    - name: ğŸ“ å‰µå»º Telegram Bot é…ç½®
      run: |
        echo "ğŸ“ å‰µå»º Telegram Bot éƒ¨ç½²é…ç½®..."
        
        SERVICE_NAME="namecard-telegram-bot"
        if [ "${{ env.ENVIRONMENT }}" != "production" ]; then
          SERVICE_NAME="namecard-telegram-bot-${{ env.ENVIRONMENT }}"
        fi
        
        cat > zeabur-telegram.json << EOF
        {
          "name": "$SERVICE_NAME",
          "build": {
            "command": "pip install -r requirements-telegram.txt"
          },
          "start": {
            "command": "python main.py"
          },
          "environment": {
            "PORT": "5003",
            "PYTHON_VERSION": "3.9",
            "FLASK_ENV": "${{ env.ENVIRONMENT }}",
            "PYTHONUNBUFFERED": "1",
            "SERVICE_TYPE": "telegram-bot"
          },
          "region": "hkg",
          "restart": "always"
        }
        EOF
        
        echo "âœ… Telegram Bot é…ç½®å·²å‰µå»º"
        cat zeabur-telegram.json
        
    - name: ğŸš€ éƒ¨ç½² Telegram Bot
      id: deploy
      run: |
        echo "ğŸš€ éƒ¨ç½² Telegram Bot åˆ° Zeabur..."
        
        # ä½¿ç”¨ Telegram Bot é…ç½®
        cp zeabur-telegram.json zeabur.json
        
        SERVICE_NAME="namecard-telegram-bot"
        if [ "${{ env.ENVIRONMENT }}" != "production" ]; then
          SERVICE_NAME="namecard-telegram-bot-${{ env.ENVIRONMENT }}"
        fi
        
        # éƒ¨ç½²ç­–ç•¥
        case "${{ env.DEPLOY_STRATEGY }}" in
          "create-new")
            echo "ğŸ“‹ å‰µå»ºæ–°æœå‹™..."
            zeabur deploy --name="$SERVICE_NAME" --create=true
            ;;
          "blue-green")
            echo "ğŸ“‹ è—ç¶ éƒ¨ç½²ç­–ç•¥..."
            # è—ç¶ éƒ¨ç½²é‚è¼¯ (ç°¡åŒ–ç‰ˆ)
            TEMP_SERVICE="${SERVICE_NAME}-temp"
            zeabur deploy --name="$TEMP_SERVICE" --create=true
            # é€™è£¡éœ€è¦é¡å¤–çš„æµé‡åˆ‡æ›é‚è¼¯
            ;;
          *)
            echo "ğŸ“‹ æ›´æ–°ç¾æœ‰æœå‹™..."
            zeabur deploy --name="$SERVICE_NAME" || {
              echo "âš ï¸ æ›´æ–°å¤±æ•—ï¼Œå˜—è©¦å‰µå»ºæ–°æœå‹™..."
              zeabur deploy --name="$SERVICE_NAME" --create=true
            }
            ;;
        esac
        
        # è¨­ç½®è¼¸å‡º
        TELEGRAM_URL="https://${SERVICE_NAME}.zeabur.app"
        echo "telegram_url=$TELEGRAM_URL" >> $GITHUB_OUTPUT
        echo "âœ… Telegram Bot éƒ¨ç½²å®Œæˆ: $TELEGRAM_URL"
        
    - name: ğŸ”§ è¨­ç½® Telegram Bot ç’°å¢ƒè®Šæ•¸
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_API_KEY_FALLBACK: ${{ secrets.GOOGLE_API_KEY_FALLBACK }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "ğŸ”§ è¨­ç½® Telegram Bot ç’°å¢ƒè®Šæ•¸..."
        
        SERVICE_NAME="namecard-telegram-bot"
        if [ "${{ env.ENVIRONMENT }}" != "production" ]; then
          SERVICE_NAME="namecard-telegram-bot-${{ env.ENVIRONMENT }}"
        fi
        
        # æ‰¹é‡è¨­ç½®ç’°å¢ƒè®Šæ•¸
        env_vars=(
          "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN"
          "GOOGLE_API_KEY=$GOOGLE_API_KEY"
          "GOOGLE_API_KEY_FALLBACK=$GOOGLE_API_KEY_FALLBACK"
          "NOTION_API_KEY=$NOTION_API_KEY"
          "NOTION_DATABASE_ID=$NOTION_DATABASE_ID"
          "PORT=5003"
          "FLASK_ENV=${{ env.ENVIRONMENT }}"
          "PYTHONUNBUFFERED=1"
        )
        
        for env_var in "${env_vars[@]}"; do
          key=$(echo "$env_var" | cut -d'=' -f1)
          value=$(echo "$env_var" | cut -d'=' -f2-)
          
          if [ -n "$value" ] && [ "$value" != "" ]; then
            if zeabur variable create --name="$SERVICE_NAME" -k "$key=$value" -y; then
              echo "âœ… $key è¨­ç½®æˆåŠŸ"
            else
              echo "âš ï¸ $key è¨­ç½®å¤±æ•—"
            fi
          fi
        done
        
    - name: ğŸ¥ Telegram Bot å¥åº·æª¢æŸ¥
      run: |
        echo "ğŸ¥ åŸ·è¡Œ Telegram Bot å¥åº·æª¢æŸ¥..."
        
        TELEGRAM_URL="${{ steps.deploy.outputs.telegram_url }}"
        
        # ç­‰å¾…æœå‹™å•Ÿå‹•
        echo "â³ ç­‰å¾… Telegram Bot å•Ÿå‹•..."
        sleep 45
        
        # å¥åº·æª¢æŸ¥
        for i in {1..6}; do
          echo "ğŸ” å¥åº·æª¢æŸ¥å˜—è©¦ $i/6..."
          
          if curl -f -s "$TELEGRAM_URL/health" > /dev/null; then
            echo "âœ… Telegram Bot å¥åº·æª¢æŸ¥é€šé"
            
            # æ¸¬è©¦ webhook ç«¯é»
            if curl -f -s "$TELEGRAM_URL/telegram-webhook" > /dev/null 2>&1; then
              echo "âœ… Telegram webhook ç«¯é»å¯ç”¨"
            else
              echo "âš ï¸ Telegram webhook ç«¯é»æ¸¬è©¦å¤±æ•— (å¯èƒ½éœ€è¦ POST)"
            fi
            
            break
          fi
          
          if [ $i -eq 6 ]; then
            echo "âŒ Telegram Bot å¥åº·æª¢æŸ¥æœ€çµ‚å¤±æ•—"
            exit 1
          fi
          
          echo "â³ ç­‰å¾… 15 ç§’å¾Œé‡è©¦..."
          sleep 15
        done

  deploy-line-bot:
    name: ğŸ“ éƒ¨ç½² LINE Bot
    runs-on: ubuntu-latest
    needs: [detect-changes, pre-deploy-checks]
    if: always() && needs.detect-changes.outputs.should_deploy_line == 'true' && (needs.pre-deploy-checks.result == 'success' || needs.pre-deploy-checks.result == 'skipped')
    
    environment: 
      name: ${{ env.ENVIRONMENT }}-line
      url: ${{ steps.deploy.outputs.line_url }}
      
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ å®‰è£ Zeabur CLI
      run: |
        echo "ğŸ“¦ å®‰è£ Zeabur CLI..."
        npm install -g @zeabur/cli@latest
        zeabur --version
        
    - name: ğŸ” é…ç½® Zeabur èªè­‰
      run: |
        echo "ğŸ” é…ç½® Zeabur èªè­‰..."
        echo "${{ secrets.ZEABUR_TOKEN }}" | zeabur auth login --token
        
    - name: ğŸ“ å‰µå»º LINE Bot é…ç½®
      run: |
        echo "ğŸ“ å‰µå»º LINE Bot éƒ¨ç½²é…ç½®..."
        
        SERVICE_NAME="namecard-line-bot"
        if [ "${{ env.ENVIRONMENT }}" != "production" ]; then
          SERVICE_NAME="namecard-line-bot-${{ env.ENVIRONMENT }}"
        fi
        
        cat > zeabur-line.json << EOF
        {
          "name": "$SERVICE_NAME",
          "build": {
            "command": "pip install -r requirements.txt"
          },
          "start": {
            "command": "python app.py"
          },
          "environment": {
            "PORT": "5002",
            "PYTHON_VERSION": "3.9",
            "FLASK_ENV": "${{ env.ENVIRONMENT }}",
            "PYTHONUNBUFFERED": "1",
            "SERVICE_TYPE": "line-bot"
          },
          "region": "hkg",
          "restart": "always"
        }
        EOF
        
        echo "âœ… LINE Bot é…ç½®å·²å‰µå»º"
        cat zeabur-line.json
        
    - name: ğŸš€ éƒ¨ç½² LINE Bot
      id: deploy
      run: |
        echo "ğŸš€ éƒ¨ç½² LINE Bot åˆ° Zeabur..."
        
        # ä½¿ç”¨ LINE Bot é…ç½®
        cp zeabur-line.json zeabur.json
        
        SERVICE_NAME="namecard-line-bot"
        if [ "${{ env.ENVIRONMENT }}" != "production" ]; then
          SERVICE_NAME="namecard-line-bot-${{ env.ENVIRONMENT }}"
        fi
        
        # éƒ¨ç½²
        zeabur deploy --name="$SERVICE_NAME" || {
          echo "âš ï¸ æ›´æ–°å¤±æ•—ï¼Œå˜—è©¦å‰µå»ºæ–°æœå‹™..."
          zeabur deploy --name="$SERVICE_NAME" --create=true
        }
        
        # è¨­ç½®è¼¸å‡º
        LINE_URL="https://${SERVICE_NAME}.zeabur.app"
        echo "line_url=$LINE_URL" >> $GITHUB_OUTPUT
        echo "âœ… LINE Bot éƒ¨ç½²å®Œæˆ: $LINE_URL"
        
    - name: ğŸ”§ è¨­ç½® LINE Bot ç’°å¢ƒè®Šæ•¸
      env:
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_API_KEY_FALLBACK: ${{ secrets.GOOGLE_API_KEY_FALLBACK }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "ğŸ”§ è¨­ç½® LINE Bot ç’°å¢ƒè®Šæ•¸..."
        
        SERVICE_NAME="namecard-line-bot"
        if [ "${{ env.ENVIRONMENT }}" != "production" ]; then
          SERVICE_NAME="namecard-line-bot-${{ env.ENVIRONMENT }}"
        fi
        
        # æ‰¹é‡è¨­ç½®ç’°å¢ƒè®Šæ•¸
        env_vars=(
          "LINE_CHANNEL_ACCESS_TOKEN=$LINE_CHANNEL_ACCESS_TOKEN"
          "LINE_CHANNEL_SECRET=$LINE_CHANNEL_SECRET"
          "GOOGLE_API_KEY=$GOOGLE_API_KEY"
          "GOOGLE_API_KEY_FALLBACK=$GOOGLE_API_KEY_FALLBACK"
          "NOTION_API_KEY=$NOTION_API_KEY"
          "NOTION_DATABASE_ID=$NOTION_DATABASE_ID"
          "PORT=5002"
          "FLASK_ENV=${{ env.ENVIRONMENT }}"
          "PYTHONUNBUFFERED=1"
        )
        
        for env_var in "${env_vars[@]}"; do
          key=$(echo "$env_var" | cut -d'=' -f1)
          value=$(echo "$env_var" | cut -d'=' -f2-)
          
          if [ -n "$value" ] && [ "$value" != "" ]; then
            if zeabur variable create --name="$SERVICE_NAME" -k "$key=$value" -y; then
              echo "âœ… $key è¨­ç½®æˆåŠŸ"
            else
              echo "âš ï¸ $key è¨­ç½®å¤±æ•—"
            fi
          fi
        done
        
    - name: ğŸ¥ LINE Bot å¥åº·æª¢æŸ¥
      run: |
        echo "ğŸ¥ åŸ·è¡Œ LINE Bot å¥åº·æª¢æŸ¥..."
        
        LINE_URL="${{ steps.deploy.outputs.line_url }}"
        
        # ç­‰å¾…æœå‹™å•Ÿå‹•
        echo "â³ ç­‰å¾… LINE Bot å•Ÿå‹•..."
        sleep 45
        
        # å¥åº·æª¢æŸ¥
        for i in {1..6}; do
          echo "ğŸ” å¥åº·æª¢æŸ¥å˜—è©¦ $i/6..."
          
          if curl -f -s "$LINE_URL/health" > /dev/null; then
            echo "âœ… LINE Bot å¥åº·æª¢æŸ¥é€šé"
            
            # æ¸¬è©¦ webhook ç«¯é»
            if curl -f -s "$LINE_URL/callback" > /dev/null 2>&1; then
              echo "âœ… LINE webhook ç«¯é»å¯ç”¨"
            else
              echo "âš ï¸ LINE webhook ç«¯é»æ¸¬è©¦å¤±æ•— (å¯èƒ½éœ€è¦ POST)"
            fi
            
            break
          fi
          
          if [ $i -eq 6 ]; then
            echo "âŒ LINE Bot å¥åº·æª¢æŸ¥æœ€çµ‚å¤±æ•—"
            exit 1
          fi
          
          echo "â³ ç­‰å¾… 15 ç§’å¾Œé‡è©¦..."
          sleep 15
        done

  post-deploy-validation:
    name: ğŸ§ª éƒ¨ç½²å¾Œé©—è­‰
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-telegram-bot, deploy-line-bot]
    if: always() && (needs.deploy-telegram-bot.result == 'success' || needs.deploy-line-bot.result == 'success')
    
    steps:
    - name: ğŸ§ª ç¶œåˆåŠŸèƒ½æ¸¬è©¦
      run: |
        echo "ğŸ§ª åŸ·è¡Œéƒ¨ç½²å¾Œç¶œåˆé©—è­‰..."
        
        # Telegram Bot é©—è­‰
        if [ "${{ needs.deploy-telegram-bot.result }}" = "success" ]; then
          TELEGRAM_URL="${{ needs.deploy-telegram-bot.outputs.telegram_url }}"
          echo "ğŸ“± æ¸¬è©¦ Telegram Bot: $TELEGRAM_URL"
          
          # æ¸¬è©¦ä¸»è¦ç«¯é»
          endpoints=("/health" "/test" "/telegram-webhook")
          for endpoint in "${endpoints[@]}"; do
            if curl -f -s "$TELEGRAM_URL$endpoint" > /dev/null 2>&1; then
              echo "âœ… Telegram$endpoint ç«¯é»æ­£å¸¸"
            else
              echo "âš ï¸ Telegram$endpoint ç«¯é»ç•°å¸¸"
            fi
          done
        fi
        
        # LINE Bot é©—è­‰
        if [ "${{ needs.deploy-line-bot.result }}" = "success" ]; then
          LINE_URL="${{ needs.deploy-line-bot.outputs.line_url }}"
          echo "ğŸ“ æ¸¬è©¦ LINE Bot: $LINE_URL"
          
          # æ¸¬è©¦ä¸»è¦ç«¯é»
          endpoints=("/health" "/test" "/callback")
          for endpoint in "${endpoints[@]}"; do
            if curl -f -s "$LINE_URL$endpoint" > /dev/null 2>&1; then
              echo "âœ… LINE$endpoint ç«¯é»æ­£å¸¸"
            else
              echo "âš ï¸ LINE$endpoint ç«¯é»ç•°å¸¸"
            fi
          done
        fi
        
        echo "âœ… éƒ¨ç½²å¾Œé©—è­‰å®Œæˆ"

  notify-completion:
    name: ğŸ“¢ éƒ¨ç½²å®Œæˆé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-telegram-bot, deploy-line-bot, post-deploy-validation]
    if: always()
    
    steps:
    - name: ğŸ“Š ç”Ÿæˆéƒ¨ç½²å ±å‘Š
      run: |
        echo "ğŸ“Š **çµ±ä¸€éƒ¨ç½²æµç¨‹å®Œæˆå ±å‘Š**"
        echo ""
        
        # éƒ¨ç½²ç‹€æ…‹ç¸½çµ
        TELEGRAM_STATUS="${{ needs.deploy-telegram-bot.result }}"
        LINE_STATUS="${{ needs.deploy-line-bot.result }}"
        VALIDATION_STATUS="${{ needs.post-deploy-validation.result }}"
        
        echo "ğŸ¯ **éƒ¨ç½²ç›®æ¨™:**"
        echo "- æœå‹™é¡å‹: ${{ env.SERVICE_TYPE }}"
        echo "- éƒ¨ç½²ç’°å¢ƒ: ${{ env.ENVIRONMENT }}"
        echo "- éƒ¨ç½²ç­–ç•¥: ${{ env.DEPLOY_STRATEGY }}"
        echo ""
        
        echo "ğŸ“‹ **éƒ¨ç½²çµæœ:**"
        
        if [ "${{ needs.detect-changes.outputs.should_deploy_telegram }}" = "true" ]; then
          if [ "$TELEGRAM_STATUS" = "success" ]; then
            echo "âœ… Telegram Bot: éƒ¨ç½²æˆåŠŸ"
            echo "   ğŸ“± URL: ${{ needs.deploy-telegram-bot.outputs.telegram_url }}"
          else
            echo "âŒ Telegram Bot: éƒ¨ç½²å¤±æ•—"
          fi
        else
          echo "â­ï¸ Telegram Bot: è·³ééƒ¨ç½²"
        fi
        
        if [ "${{ needs.detect-changes.outputs.should_deploy_line }}" = "true" ]; then
          if [ "$LINE_STATUS" = "success" ]; then
            echo "âœ… LINE Bot: éƒ¨ç½²æˆåŠŸ"
            echo "   ğŸ“ URL: ${{ needs.deploy-line-bot.outputs.line_url }}"
          else
            echo "âŒ LINE Bot: éƒ¨ç½²å¤±æ•—"
          fi
        else
          echo "â­ï¸ LINE Bot: è·³ééƒ¨ç½²"
        fi
        
        if [ "$VALIDATION_STATUS" = "success" ]; then
          echo "âœ… éƒ¨ç½²å¾Œé©—è­‰: é€šé"
        elif [ "$VALIDATION_STATUS" = "failure" ]; then
          echo "âš ï¸ éƒ¨ç½²å¾Œé©—è­‰: å¤±æ•—"
        else
          echo "â­ï¸ éƒ¨ç½²å¾Œé©—è­‰: è·³é"
        fi
        
        echo ""
        echo "ğŸ“‹ **å¾ŒçºŒæ­¥é©Ÿ:**"
        
        if [ "${{ needs.deploy-telegram-bot.result }}" = "success" ]; then
          echo "ğŸ“± **Telegram Bot:**"
          echo "1. è¨­ç½® Webhook URL: ${{ needs.deploy-telegram-bot.outputs.telegram_url }}/telegram-webhook"
          echo "2. æ¸¬è©¦ Bot åŠŸèƒ½"
          echo ""
        fi
        
        if [ "${{ needs.deploy-line-bot.result }}" = "success" ]; then
          echo "ğŸ“ **LINE Bot:**"
          echo "1. æ›´æ–° LINE Developers Console Webhook URL"
          echo "2. è¨­ç½®ç‚º: ${{ needs.deploy-line-bot.outputs.line_url }}/callback"
          echo "3. æ¸¬è©¦ LINE Bot åŠŸèƒ½"
          echo ""
        fi
        
        echo "ğŸ”— **ç›¸é—œé€£çµ:**"
        echo "- [Zeabur Dashboard](https://dash.zeabur.com/)"
        echo "- [æŸ¥çœ‹éƒ¨ç½²æ—¥èªŒ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        
        if [ "${{ needs.deploy-telegram-bot.result }}" = "success" ]; then
          echo "- [Telegram Bot API](https://core.telegram.org/bots/api)"
        fi
        
        if [ "${{ needs.deploy-line-bot.result }}" = "success" ]; then
          echo "- [LINE Developers Console](https://developers.line.biz/console/)"
        fi