name: éƒ¨ç½² Telegram Bot åˆ° Zeabur

on:
  push:
    branches: [ main ]
    paths:
      - 'main.py'
      - 'telegram_main.py'
      - 'telegram_app.py'
      - 'telegram_bot_handler.py'
      - 'requirements-telegram.txt'
      - '.github/workflows/deploy-telegram-bot.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½² (è·³éé æª¢æŸ¥)'
        required: false
        default: false
        type: boolean

jobs:
  pre-deploy-checks:
    name: ğŸ“‹ é éƒ¨ç½²æª¢æŸ¥
    runs-on: ubuntu-latest
    if: ${{ !inputs.force_deploy }}
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        pip install -r requirements-telegram.txt
        
    - name: ğŸ” èªæ³•æª¢æŸ¥
      run: |
        echo "æª¢æŸ¥ Telegram Bot èªæ³•..."
        python -m py_compile main.py
        python -m py_compile telegram_main.py
        python -m py_compile telegram_app.py
        python -m py_compile telegram_bot_handler.py
        echo "âœ… èªæ³•æª¢æŸ¥é€šé"
        
    - name: ğŸ§ª æ ¸å¿ƒæ¨¡çµ„é©—è­‰
      run: |
        echo "é©—è­‰æ ¸å¿ƒæ¨¡çµ„..."
        python -c "
        import sys
        sys.path.append('.')
        try:
            # æ¸¬è©¦ç¨ç«‹å…¥å£
            import telegram_main
            # æ¸¬è©¦æ ¸å¿ƒæ¨¡çµ„
            from config import Config
            from telegram_bot_handler import TelegramBotHandler
            print('âœ… æ ¸å¿ƒæ¨¡çµ„è¼‰å…¥æˆåŠŸ')
        except ImportError as e:
            if 'linebot' in str(e).lower():
                print(f'âŒ LINE Bot ä¾è³´éŒ¯èª¤: {e}')
                sys.exit(1)
            else:
                print(f'âš ï¸ ä¾è³´æ¨¡çµ„ç¼ºå¤± (éƒ¨ç½²æ™‚æœƒå®‰è£): {e}')
        except Exception as e:
            print(f'âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—: {e}')
            sys.exit(1)
        "
        
    - name: ğŸ“ æª¢æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "æª¢æŸ¥å¿…è¦æ–‡ä»¶..."
        required_files=(
          "main.py"
          "telegram_main.py"
          "telegram_app.py"
          "telegram_bot_handler.py" 
          "requirements-telegram.txt"
          "name_card_processor.py"
          "notion_manager.py"
          "batch_manager.py"
          "multi_card_processor.py"
          "user_interaction_handler.py"
          "address_normalizer.py"
          "config.py"
        )
        
        for file in "${required_files[@]}"; do
          if [[ -f "$file" ]]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done

  deploy-telegram-bot:
    name: ğŸš€ éƒ¨ç½² Telegram Bot
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    if: always() && (needs.pre-deploy-checks.result == 'success' || needs.pre-deploy-checks.result == 'skipped')
    
    environment: ${{ inputs.environment || 'production' }}
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ å®‰è£ Zeabur CLI
      run: |
        echo "å®‰è£ Zeabur CLI..."
        npm install -g @zeabur/cli
        zeabur --version
        
    - name: ğŸ” é…ç½® Zeabur èªè­‰
      run: |
        echo "é…ç½® Zeabur èªè­‰..."
        echo "${{ secrets.ZEABUR_TOKEN }}" | zeabur auth login --token
        
    - name: ğŸ“ å‰µå»º Telegram Bot éƒ¨ç½²é…ç½®
      run: |
        echo "å‰µå»º Telegram Bot å°ˆç”¨éƒ¨ç½²é…ç½®..."
        cat > zeabur-telegram.json << EOF
        {
          "name": "namecard-telegram-bot",
          "type": "python",
          "source": {
            "type": "git",
            "url": "${{ github.server_url }}/${{ github.repository }}",
            "branch": "${{ github.ref_name }}"
          },
          "build": {
            "commands": [
              "pip install --upgrade pip",
              "pip install -r requirements-telegram.txt"
            ]
          },
          "start": {
            "command": "python main.py"
          },
          "environment": {
            "PYTHON_VERSION": "3.9",
            "PORT": "5003",
            "FLASK_ENV": "production"
          },
          "regions": ["hkg"],
          "scaling": {
            "minInstances": 1,
            "maxInstances": 2
          }
        }
        EOF
        
    - name: ğŸ¯ å‰µå»ºæˆ–æ›´æ–° Zeabur å°ˆæ¡ˆ
      run: |
        echo "ç®¡ç† Zeabur å°ˆæ¡ˆ..."
        
        # å˜—è©¦å‰µå»ºæ–°å°ˆæ¡ˆï¼Œå¦‚æœå·²å­˜åœ¨å‰‡æ›´æ–°
        if zeabur project create namecard-telegram-bot 2>/dev/null; then
          echo "âœ… å‰µå»ºæ–°å°ˆæ¡ˆ: namecard-telegram-bot"
        else
          echo "ğŸ“ å°ˆæ¡ˆå·²å­˜åœ¨ï¼Œå°‡é€²è¡Œæ›´æ–°"
        fi
        
        # è¨­ç½®å°ˆæ¡ˆç‚ºç•¶å‰å°ˆæ¡ˆ
        zeabur project use namecard-telegram-bot
        
    - name: ğŸ”§ å‰µå»ºæˆ–æ›´æ–°æœå‹™
      run: |
        echo "ç®¡ç† Zeabur æœå‹™..."
        
        # å‰µå»ºæœå‹™ï¼Œå¦‚æœå·²å­˜åœ¨å‰‡æ›´æ–°
        if zeabur service create telegram-bot --type python 2>/dev/null; then
          echo "âœ… å‰µå»ºæ–°æœå‹™: telegram-bot"
        else
          echo "ğŸ“ æœå‹™å·²å­˜åœ¨ï¼Œå°‡é€²è¡Œæ›´æ–°"
        fi
        
    - name: âš™ï¸ è¨­ç½®ç’°å¢ƒè®Šæ•¸
      run: |
        echo "è¨­ç½® Telegram Bot ç’°å¢ƒè®Šæ•¸..."
        
        # è¨­ç½®æ‰€æœ‰å¿…è¦çš„ç’°å¢ƒè®Šæ•¸
        zeabur env set TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
        zeabur env set GOOGLE_API_KEY="${{ secrets.GOOGLE_API_KEY }}"
        zeabur env set GOOGLE_API_KEY_FALLBACK="${{ secrets.GOOGLE_API_KEY_FALLBACK }}"
        zeabur env set NOTION_API_KEY="${{ secrets.NOTION_API_KEY }}"
        zeabur env set NOTION_DATABASE_ID="${{ secrets.NOTION_DATABASE_ID }}"
        zeabur env set GEMINI_MODEL="gemini-2.5-pro"
        zeabur env set PORT="5003"
        zeabur env set FLASK_DEBUG="false"
        zeabur env set FLASK_ENV="production"
        
        echo "âœ… ç’°å¢ƒè®Šæ•¸è¨­ç½®å®Œæˆ"
        
    - name: ğŸš€ éƒ¨ç½²æœå‹™
      run: |
        echo "éƒ¨ç½² Telegram Bot åˆ° Zeabur..."
        
        # åŸ·è¡Œéƒ¨ç½²
        zeabur deploy --service telegram-bot \
          --source . \
          --build-command "pip install -r requirements-telegram.txt" \
          --start-command "python main.py"
          
        echo "âœ… éƒ¨ç½²å®Œæˆ"
        
    - name: â³ ç­‰å¾…æœå‹™å•Ÿå‹•
      run: |
        echo "ç­‰å¾… Telegram Bot æœå‹™å•Ÿå‹•..."
        sleep 60
        
    - name: ğŸ” å¥åº·æª¢æŸ¥
      run: |
        echo "åŸ·è¡Œ Telegram Bot å¥åº·æª¢æŸ¥..."
        
        # ç²å–éƒ¨ç½² URL
        DEPLOY_URL=$(zeabur service info telegram-bot --format json | jq -r '.url // empty')
        
        if [[ -z "$DEPLOY_URL" ]]; then
          echo "âš ï¸ ç„¡æ³•ç²å–éƒ¨ç½² URLï¼Œè·³éå¥åº·æª¢æŸ¥"
          exit 0
        fi
        
        echo "ğŸŒ Telegram Bot URL: $DEPLOY_URL"
        
        # å¥åº·æª¢æŸ¥
        max_retries=5
        retry_count=0
        
        while [[ $retry_count -lt $max_retries ]]; do
          if curl -f -s "$DEPLOY_URL/health" > /dev/null; then
            echo "âœ… Telegram Bot å¥åº·æª¢æŸ¥é€šé"
            break
          else
            retry_count=$((retry_count + 1))
            echo "â³ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œé‡è©¦ $retry_count/$max_retries..."
            sleep 10
          fi
        done
        
        if [[ $retry_count -eq $max_retries ]]; then
          echo "âŒ Telegram Bot å¥åº·æª¢æŸ¥æœ€çµ‚å¤±æ•—"
          exit 1
        fi
        
    - name: ğŸ§ª éƒ¨ç½²å¾Œæ¸¬è©¦
      run: |
        echo "åŸ·è¡Œ Telegram Bot éƒ¨ç½²å¾Œæ¸¬è©¦..."
        
        # ç²å–éƒ¨ç½² URL
        DEPLOY_URL=$(zeabur service info telegram-bot --format json | jq -r '.url // empty')
        
        if [[ -z "$DEPLOY_URL" ]]; then
          echo "âš ï¸ ç„¡æ³•ç²å–éƒ¨ç½² URLï¼Œè·³éæ¸¬è©¦"
          exit 0
        fi
        
        # æ¸¬è©¦ä¸»è¦ç«¯é»
        echo "ğŸ” æ¸¬è©¦å¥åº·æª¢æŸ¥ç«¯é»..."
        curl -f "$DEPLOY_URL/health" || exit 1
        
        echo "ğŸ” æ¸¬è©¦æœå‹™ç‹€æ…‹ç«¯é»..."
        curl -f "$DEPLOY_URL/test" || exit 1
        
        echo "ğŸ” æ¸¬è©¦ webhook ç«¯é»..."
        curl -f -X POST "$DEPLOY_URL/telegram-webhook" \
          -H "Content-Type: application/json" \
          -d '{}' || echo "é æœŸçš„ 400 éŒ¯èª¤"
        
        echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šé"
        
    - name: ğŸ“¤ éƒ¨ç½²çµæœé€šçŸ¥
      run: |
        echo "ğŸ“Š Telegram Bot éƒ¨ç½²çµæœ:"
        echo "ğŸ“… éƒ¨ç½²æ™‚é–“: $(date)"
        echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
        echo "ğŸ“ æäº¤: ${{ github.sha }}"
        echo "ğŸ‘¤ è§¸ç™¼è€…: ${{ github.actor }}"
        echo "ğŸ·ï¸ ç’°å¢ƒ: ${{ inputs.environment || 'production' }}"
        
        # ç²å–éƒ¨ç½² URL
        DEPLOY_URL=$(zeabur service info telegram-bot --format json | jq -r '.url // empty' 2>/dev/null || echo "ç„¡æ³•ç²å–")
        echo "ğŸŒ Telegram Bot URL: $DEPLOY_URL"
        
        echo ""
        echo "ğŸ‰ Telegram Bot éƒ¨ç½²æˆåŠŸï¼"
        echo ""
        echo "ğŸ“± ä¸‹ä¸€æ­¥ï¼š"
        echo "1. æ›´æ–° Telegram Bot webhook URL:"
        echo "   curl -X POST \"https://api.telegram.org/bot<BOT_TOKEN>/setWebhook\" -d \"url=$DEPLOY_URL/telegram-webhook\""
        echo "2. æ¸¬è©¦ Bot åŠŸèƒ½æ˜¯å¦æ­£å¸¸"
        echo "3. ç›£æ§æ‡‰ç”¨æ—¥èªŒå’ŒéŒ¯èª¤"

  cleanup:
    name: ğŸ§¹ æ¸…ç†
    runs-on: ubuntu-latest
    needs: [deploy-telegram-bot]
    if: always()
    
    steps:
    - name: ğŸ—‘ï¸ æ¸…ç†è‡¨æ™‚æ–‡ä»¶
      run: |
        echo "æ¸…ç†éƒ¨ç½²éç¨‹ä¸­çš„è‡¨æ™‚æ–‡ä»¶..."
        rm -f zeabur-telegram.json
        echo "âœ… æ¸…ç†å®Œæˆ"