name: éƒ¨ç½² Telegram Bot åˆ° Zeabur

on:
  push:
    branches: [ main ]
    paths:
      - 'src/namecard/api/telegram_bot/**'
      - 'deployment/environments/production/requirements-telegram.txt'
      - '.github/workflows/deploy-telegram-bot.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½² (è·³éé æª¢æŸ¥)'
        required: false
        default: false
        type: boolean

jobs:
  pre-deploy-checks:
    name: ğŸ“‹ é éƒ¨ç½²æª¢æŸ¥
    runs-on: ubuntu-latest
    if: ${{ !inputs.force_deploy }}
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        pip install -r deployment/environments/production/requirements-telegram.txt
        
    - name: ğŸ” èªæ³•æª¢æŸ¥
      run: |
        echo "æª¢æŸ¥ Telegram Bot èªæ³•..."
        python -m py_compile src/namecard/api/telegram_bot/app.py
        python -m py_compile src/namecard/api/telegram_bot/main.py
        python -m py_compile src/namecard/api/telegram_bot/telegram_main.py
        echo "âœ… èªæ³•æª¢æŸ¥é€šé"
        
    - name: ğŸ§ª æ ¸å¿ƒæ¨¡çµ„é©—è­‰
      run: |
        echo "é©—è­‰æ ¸å¿ƒæ¨¡çµ„..."
        python -c "
        import sys
        sys.path.append('.')
        sys.path.append('src')
        try:
            # æ¸¬è©¦æ ¸å¿ƒæ¨¡çµ„
            from config import Config
            from src.namecard.infrastructure.messaging.telegram_client import TelegramBotHandler
            print('âœ… æ ¸å¿ƒæ¨¡çµ„è¼‰å…¥æˆåŠŸ')
        except ImportError as e:
            if 'linebot' in str(e).lower():
                print(f'âŒ LINE Bot ä¾è³´éŒ¯èª¤: {e}')
                sys.exit(1)
            else:
                print(f'âš ï¸ ä¾è³´æ¨¡çµ„ç¼ºå¤± (éƒ¨ç½²æ™‚æœƒå®‰è£): {e}')
        except Exception as e:
            print(f'âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—: {e}')
            sys.exit(1)
        "
        
    - name: ğŸ“ æª¢æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "æª¢æŸ¥å¿…è¦æ–‡ä»¶..."
        required_files=(
          "src/namecard/api/telegram_bot/app.py"
          "src/namecard/api/telegram_bot/main.py"
          "src/namecard/api/telegram_bot/telegram_main.py"
          "src/namecard/infrastructure/messaging/telegram_client.py" 
          "deployment/environments/production/requirements-telegram.txt"
          "src/namecard/infrastructure/ai/card_processor.py"
          "src/namecard/infrastructure/storage/notion_client.py"
          "src/namecard/core/services/batch_service.py"
          "src/namecard/core/services/multi_card_service.py"
          "src/namecard/core/services/interaction_service.py"
          "src/namecard/core/services/address_service.py"
          "config/base.py"
        )
        
        for file in "${required_files[@]}"; do
          if [[ -f "$file" ]]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done

  deploy-telegram-bot:
    name: ğŸš€ éƒ¨ç½² Telegram Bot
    runs-on: ubuntu-latest
    needs: [pre-deploy-checks]
    if: always() && (needs.pre-deploy-checks.result == 'success' || needs.pre-deploy-checks.result == 'skipped')
    
    environment: ${{ inputs.environment || 'production' }}
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ› ï¸ å®‰è£ Zeabur CLI
      run: |
        echo "å®‰è£ Zeabur CLI..."
        npm install -g @zeabur/cli
        zeabur --version
        
    - name: ğŸ” é…ç½® Zeabur èªè­‰
      run: |
        echo "é…ç½® Zeabur èªè­‰..."
        export ZEABUR_TOKEN="${{ secrets.ZEABUR_TOKEN }}"
        
    - name: ğŸš€ éƒ¨ç½²åˆ° Zeabur
      env:
        ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_API_KEY_FALLBACK: ${{ secrets.GOOGLE_API_KEY_FALLBACK }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "éƒ¨ç½² Telegram Bot åˆ° Zeabur..."
        
        # ä½¿ç”¨ç’°å¢ƒè®Šæ•¸èªè­‰å’Œéƒ¨ç½²ï¼Œé¡¯ç¤ºè©³ç´°è¼¸å‡º
        echo "ğŸ” é–‹å§‹éƒ¨ç½²ï¼Œé¡¯ç¤ºè©³ç´°æ—¥èªŒ..."
        zeabur deploy --environment production --verbose || {
          echo "âŒ éƒ¨ç½²å‘½ä»¤å¤±æ•—ï¼Œå˜—è©¦åŸºæœ¬éƒ¨ç½²..."
          zeabur deploy --environment production
        }
        
        echo "âš™ï¸ è¨­ç½®ç’°å¢ƒè®Šæ•¸åˆ° Zeabur æœå‹™..."
        
        # ä½¿ç”¨ zeabur variable set è¨­ç½®ç’°å¢ƒè®Šæ•¸
        zeabur variable set TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
        zeabur variable set GOOGLE_API_KEY="${{ secrets.GOOGLE_API_KEY }}"
        zeabur variable set GOOGLE_API_KEY_FALLBACK="${{ secrets.GOOGLE_API_KEY_FALLBACK }}"
        zeabur variable set NOTION_API_KEY="${{ secrets.NOTION_API_KEY }}"
        zeabur variable set NOTION_DATABASE_ID="${{ secrets.NOTION_DATABASE_ID }}"
        zeabur variable set GEMINI_MODEL="gemini-2.5-pro"
        zeabur variable set PORT="5003"
        zeabur variable set FLASK_ENV="production"
        zeabur variable set PYTHONUNBUFFERED="1"
        zeabur variable set SERVICE_TYPE="telegram-bot"
        
        echo "ğŸ”„ é‡æ–°éƒ¨ç½²ä»¥å¥—ç”¨ç’°å¢ƒè®Šæ•¸..."
        zeabur redeploy
        
        echo "âœ… éƒ¨ç½²å’Œç’°å¢ƒè®Šæ•¸è¨­ç½®å®Œæˆ"
        
    - name: â³ ç­‰å¾…æœå‹™å•Ÿå‹•
      run: |
        echo "ç­‰å¾… Telegram Bot æœå‹™å•Ÿå‹•..."
        sleep 60
        
    - name: ğŸ” å¥åº·æª¢æŸ¥
      env:
        ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
      run: |
        echo "åŸ·è¡Œ Telegram Bot å¥åº·æª¢æŸ¥..."
        
        # ç²å–éƒ¨ç½² URLï¼ˆä½¿ç”¨ Zeabur CLIï¼‰
        DEPLOY_URL=$(zeabur domain list 2>/dev/null | grep -o 'https://[^[:space:]]*' | head -1 || echo "")
        
        # å¦‚æœé‚„æ˜¯æ²’æœ‰ URLï¼Œå˜—è©¦ä½¿ç”¨å°ˆæ¡ˆåç¨±æ§‹å»º URL
        if [[ -z "$DEPLOY_URL" ]]; then
          DEPLOY_URL="https://namecard-app.zeabur.app"
          echo "âš ï¸ ä½¿ç”¨é è¨­ URL: $DEPLOY_URL"
        fi
        
        echo "ğŸŒ Telegram Bot URL: $DEPLOY_URL"
        
        # å¥åº·æª¢æŸ¥
        max_retries=10
        retry_count=0
        
        while [[ $retry_count -lt $max_retries ]]; do
          echo "â³ å¥åº·æª¢æŸ¥å˜—è©¦ $((retry_count + 1))/$max_retries..."
          
          if curl -f -s --max-time 30 "$DEPLOY_URL/health" > /dev/null; then
            echo "âœ… Telegram Bot å¥åº·æª¢æŸ¥é€šé"
            
            # é¡¯ç¤ºå¥åº·æª¢æŸ¥è©³ç´°è³‡è¨Š
            HEALTH_INFO=$(curl -s "$DEPLOY_URL/health" 2>/dev/null || echo "ç„¡æ³•ç²å–å¥åº·è³‡è¨Š")
            echo "ğŸ“Š å¥åº·æª¢æŸ¥è©³æƒ…: $HEALTH_INFO"
            break
          else
            retry_count=$((retry_count + 1))
            echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œç­‰å¾… 15 ç§’å¾Œé‡è©¦..."
            sleep 15
          fi
        done
        
        if [[ $retry_count -eq $max_retries ]]; then
          echo "âŒ Telegram Bot å¥åº·æª¢æŸ¥æœ€çµ‚å¤±æ•—"
          echo "ğŸ” å˜—è©¦ç²å–æœå‹™ç‹€æ…‹..."
          zeabur service list || echo "ç„¡æ³•ç²å–æœå‹™åˆ—è¡¨"
          echo "ğŸ’¾ å„²å­˜éƒ¨ç½² URL ä¾›æ‰‹å‹•æª¢æŸ¥: $DEPLOY_URL"
          # ä¸è®“å¥åº·æª¢æŸ¥å¤±æ•—é˜»æ­¢æ•´å€‹éƒ¨ç½²æµç¨‹
          echo "âš ï¸ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œä½†éƒ¨ç½²å¯èƒ½ä»ç„¶æˆåŠŸ"
        fi
        
    - name: ğŸ§ª éƒ¨ç½²å¾Œæ¸¬è©¦
      env:
        ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
      run: |
        echo "åŸ·è¡Œ Telegram Bot éƒ¨ç½²å¾Œæ¸¬è©¦..."
        
        # ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•ç²å–éƒ¨ç½² URL
        DEPLOY_URL=$(zeabur domain list 2>/dev/null | grep -o 'https://[^[:space:]]*' | head -1 || echo "")
        
        if [[ -z "$DEPLOY_URL" ]]; then
          DEPLOY_URL="https://namecard-app.zeabur.app"
          echo "âš ï¸ ä½¿ç”¨é è¨­ URL: $DEPLOY_URL"
        fi
        
        echo "ğŸ” æ¸¬è©¦ä¸»è¦ç«¯é»..."
        
        # æ¸¬è©¦å¥åº·æª¢æŸ¥ç«¯é»
        echo "ğŸ“¡ æ¸¬è©¦å¥åº·æª¢æŸ¥ç«¯é»..."
        if curl -f -s --max-time 10 "$DEPLOY_URL/health"; then
          echo "âœ… å¥åº·æª¢æŸ¥ç«¯é»æ­£å¸¸"
        else
          echo "âš ï¸ å¥åº·æª¢æŸ¥ç«¯é»ç„¡å›æ‡‰"
        fi
        
        # æ¸¬è©¦æœå‹™ç‹€æ…‹ç«¯é»
        echo "ğŸ“¡ æ¸¬è©¦æœå‹™ç‹€æ…‹ç«¯é»..."
        if curl -f -s --max-time 10 "$DEPLOY_URL/test"; then
          echo "âœ… æœå‹™ç‹€æ…‹ç«¯é»æ­£å¸¸"
        else
          echo "âš ï¸ æœå‹™ç‹€æ…‹ç«¯é»ç„¡å›æ‡‰"
        fi
        
        # æ¸¬è©¦ webhook ç«¯é» (é æœŸæœƒè¿”å›éŒ¯èª¤ï¼Œé€™æ˜¯æ­£å¸¸çš„)
        echo "ğŸ“¡ æ¸¬è©¦ telegram-webhook ç«¯é»..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST "$DEPLOY_URL/telegram-webhook" \
          -H "Content-Type: application/json" \
          -d '{}' || echo "000")
        
        if [[ "$HTTP_CODE" == "400" ]]; then
          echo "âœ… Webhook ç«¯é»æ­£å¸¸ (é æœŸçš„ 400 éŒ¯èª¤)"
        else
          echo "âš ï¸ Webhook ç«¯é»å›æ‡‰ç¢¼: $HTTP_CODE"
        fi
        
        echo "ğŸ“‹ æ¸¬è©¦å®Œæˆï¼Œéƒ¨ç½² URL: $DEPLOY_URL"
        
    - name: ğŸ“¤ éƒ¨ç½²çµæœé€šçŸ¥
      env:
        ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}
      run: |
        echo "ğŸ“Š Telegram Bot éƒ¨ç½²çµæœ:"
        echo "ğŸ“… éƒ¨ç½²æ™‚é–“: $(date)"
        echo "ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}"
        echo "ğŸ“ æäº¤: ${{ github.sha }}"
        echo "ğŸ‘¤ è§¸ç™¼è€…: ${{ github.actor }}"
        echo "ğŸ·ï¸ ç’°å¢ƒ: ${{ inputs.environment || 'production' }}"
        
        # ç²å–éƒ¨ç½² URL
        DEPLOY_URL=$(zeabur domain list 2>/dev/null | grep -o 'https://[^[:space:]]*' | head -1 || echo "https://namecard-app.zeabur.app")
        echo "ğŸŒ Telegram Bot URL: $DEPLOY_URL"
        
        # é¡¯ç¤ºç’°å¢ƒè®Šæ•¸è¨­ç½®ç‹€æ…‹
        echo "âš™ï¸ ç’°å¢ƒè®Šæ•¸è¨­ç½®ç‹€æ…‹:"
        zeabur variable list 2>/dev/null || echo "ç„¡æ³•ç²å–ç’°å¢ƒè®Šæ•¸åˆ—è¡¨"
        
        echo ""
        echo "ğŸ‰ Telegram Bot éƒ¨ç½²æµç¨‹å®Œæˆï¼"
        echo ""
        echo "ğŸ“± ä¸‹ä¸€æ­¥ï¼š"
        echo "1. è¨­ç½® Telegram Bot webhook URL:"
        echo "   curl -X POST \"https://api.telegram.org/bot\$TELEGRAM_BOT_TOKEN/setWebhook\" \\"
        echo "        -d \"url=$DEPLOY_URL/telegram-webhook\""
        echo ""
        echo "2. é©—è­‰ webhook è¨­ç½®:"
        echo "   curl \"https://api.telegram.org/bot\$TELEGRAM_BOT_TOKEN/getWebhookInfo\""
        echo ""
        echo "3. æ¸¬è©¦ Bot åŠŸèƒ½:"
        echo "   - åœ¨ Telegram ä¸­ç™¼é€ /start çµ¦ä½ çš„ Bot"
        echo "   - ç™¼é€åç‰‡ç…§ç‰‡æ¸¬è©¦ AI è­˜åˆ¥åŠŸèƒ½"
        echo ""
        echo "4. ç›£æ§æ‡‰ç”¨:"
        echo "   - å¥åº·æª¢æŸ¥: $DEPLOY_URL/health"
        echo "   - æœå‹™ç‹€æ…‹: $DEPLOY_URL/test"

  cleanup:
    name: ğŸ§¹ æ¸…ç†
    runs-on: ubuntu-latest
    needs: [deploy-telegram-bot]
    if: always()
    
    steps:
    - name: ğŸ—‘ï¸ æ¸…ç†è‡¨æ™‚æ–‡ä»¶
      run: |
        echo "æ¸…ç†éƒ¨ç½²éç¨‹ä¸­çš„è‡¨æ™‚æ–‡ä»¶..."
        rm -f zeabur-telegram.json
        echo "âœ… æ¸…ç†å®Œæˆ"