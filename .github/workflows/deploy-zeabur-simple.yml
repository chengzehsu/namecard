name: ğŸš€ ç°¡åŒ– Zeabur éƒ¨ç½²

on:
  push:
    branches: [ main ]
    paths:
      - 'telegram_app.py'
      - 'requirements-telegram.txt'
      - 'zeabur.json'
      - '.github/workflows/deploy-zeabur-simple.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½²'
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ° Zeabur
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        pip install -r requirements-telegram.txt
        
    - name: ğŸ” åŸºæœ¬æ¸¬è©¦
      run: |
        echo "åŸ·è¡ŒåŸºæœ¬èªæ³•æª¢æŸ¥..."
        python -m py_compile telegram_app.py
        python -m py_compile config.py
        echo "âœ… èªæ³•æª¢æŸ¥é€šé"
        
    - name: ğŸ“ å‰µå»ºéƒ¨ç½²é…ç½®
      run: |
        echo "å‰µå»º Zeabur éƒ¨ç½²é…ç½®..."
        
        # å‰µå»º zeabur.json (å¦‚æœä¸å­˜åœ¨æˆ–éœ€è¦æ›´æ–°)
        cat > zeabur.json << 'EOF'
        {
          "name": "namecard-telegram-bot",
          "build": {
            "command": "pip install -r requirements-telegram.txt"
          },
          "start": {
            "command": "python telegram_app.py"
          },
          "environment": {
            "PORT": "5003",
            "PYTHON_VERSION": "3.9"
          }
        }
        EOF
        
        echo "âœ… éƒ¨ç½²é…ç½®å·²å‰µå»º"
        
    - name: ğŸŒ éƒ¨ç½²æç¤º
      run: |
        echo "ğŸ“‹ Zeabur éƒ¨ç½²æº–å‚™å®Œæˆï¼"
        echo ""
        echo "ğŸ”§ æ‰‹å‹•éƒ¨ç½²æ­¥é©Ÿï¼š"
        echo "1. å‰å¾€ https://dash.zeabur.com"
        echo "2. ç™»å…¥ä¸¦å‰µå»ºæ–°å°ˆæ¡ˆ"
        echo "3. é€£æ¥æ­¤ GitHub å€‰åº«"
        echo "4. é¸æ“‡ 'namecard' å€‰åº«"
        echo "5. Zeabur æœƒè‡ªå‹•æª¢æ¸¬åˆ° zeabur.json é…ç½®"
        echo "6. è¨­ç½®ç’°å¢ƒè®Šæ•¸ (è¦‹ä¸‹æ–¹æ¸…å–®)"
        echo "7. é»æ“Šéƒ¨ç½²"
        echo ""
        echo "ğŸ”‘ éœ€è¦è¨­ç½®çš„ç’°å¢ƒè®Šæ•¸ï¼š"
        echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}"
        echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}"
        echo "GOOGLE_API_KEY_FALLBACK=${{ secrets.GOOGLE_API_KEY_FALLBACK }}"
        echo "NOTION_API_KEY=${{ secrets.NOTION_API_KEY }}"
        echo "NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }}"
        echo ""
        echo "âœ… æ‰€æœ‰æ–‡ä»¶å·²æº–å‚™å®Œæˆï¼Œå¯ä»¥é€²è¡Œéƒ¨ç½²"

    - name: ğŸ“¤ æäº¤é…ç½®æ›´æ–°
      run: |
        # å¦‚æœ zeabur.json æœ‰è®Šæ›´ï¼Œæäº¤å®ƒ
        if ! git diff --quiet zeabur.json 2>/dev/null; then
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add zeabur.json
          git commit -m "update: æ›´æ–° Zeabur éƒ¨ç½²é…ç½®" || echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
          git push || echo "æ¨é€å¤±æ•—æˆ–æ²’æœ‰è®Šæ›´"
        else
          echo "zeabur.json æ²’æœ‰è®Šæ›´"
        fi