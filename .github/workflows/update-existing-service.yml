name: ğŸ”„ æ›´æ–°ç¾æœ‰æœå‹™ç‚º Telegram Bot

on:
  workflow_dispatch:
    inputs:
      confirm_update:
        description: 'ç¢ºèªæ›´æ–°ç¾æœ‰æœå‹™ (namecard-app.zeabur.app)'
        required: true
        default: 'confirm'
        type: string

jobs:
  update-service:
    name: ğŸ”„ æ›´æ–°ç¾æœ‰ Zeabur æœå‹™
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm_update == 'confirm'
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        pip install -r requirements-telegram.txt
        
    - name: ğŸ” é©—è­‰ Telegram Bot æ–‡ä»¶
      run: |
        echo "ğŸ” é©—è­‰ Telegram Bot æ‰€éœ€æ–‡ä»¶..."
        
        # æª¢æŸ¥å¿…è¦æ–‡ä»¶
        required_files=("main.py" "telegram_app.py" "requirements-telegram.txt")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        
        # é©—è­‰èªæ³•
        python -m py_compile main.py
        python -m py_compile telegram_app.py
        echo "âœ… èªæ³•æª¢æŸ¥é€šé"
        
    - name: ğŸ“ å»ºç«‹ç›´æ¥éƒ¨ç½²é…ç½®
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_API_KEY_FALLBACK: ${{ secrets.GOOGLE_API_KEY_FALLBACK }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "ğŸ“ å»ºç«‹æœå‹™æ›´æ–°é…ç½®..."
        
        # å»ºç«‹ Zeabur éƒ¨ç½²æª”æ¡ˆï¼Œå°ˆé–€ç”¨æ–¼æ›´æ–°ç¾æœ‰æœå‹™
        cat > zeabur-update.json << 'EOF'
        {
          "build": {
            "command": "pip install -r requirements-telegram.txt"
          },
          "start": {
            "command": "python main.py"
          },
          "environment": {
            "PORT": "5003",
            "PYTHON_VERSION": "3.9",
            "FLASK_ENV": "production",
            "PYTHONUNBUFFERED": "1",
            "SERVICE_TYPE": "telegram-bot"
          }
        }
        EOF
        
        echo "âœ… æ›´æ–°é…ç½®å·²å»ºç«‹"
        cat zeabur-update.json
        
    - name: ğŸš€ è§¸ç™¼æœå‹™é‡æ–°éƒ¨ç½²
      run: |
        echo "ğŸš€ è§¸ç™¼ç¾æœ‰æœå‹™é‡æ–°éƒ¨ç½²..."
        
        # å»ºç«‹æ™‚é–“æˆ³è§¸ç™¼æª”æ¡ˆ
        echo "# å¼·åˆ¶é‡æ–°éƒ¨ç½²è§¸ç™¼å™¨" > .deploy-trigger
        echo "TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)" >> .deploy-trigger
        echo "SERVICE=telegram-bot" >> .deploy-trigger
        echo "ENTRY_POINT=main.py" >> .deploy-trigger
        echo "PORT=5003" >> .deploy-trigger
        
        # æ›´æ–° zeabur.json ç‚ºæœ€çµ‚é…ç½®
        cp zeabur-update.json zeabur.json
        
        echo "âœ… é…ç½®æª”æ¡ˆå·²æ›´æ–°ï¼Œæº–å‚™æ¨é€è®Šæ›´..."
        
    - name: ğŸ“¤ æ¨é€é…ç½®è®Šæ›´
      run: |
        echo "ğŸ“¤ æ¨é€æœå‹™é…ç½®è®Šæ›´..."
        
        # è¨­å®š Git é…ç½®
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action Bot"
        
        # æ·»åŠ è®Šæ›´çš„æª”æ¡ˆ
        git add zeabur.json .deploy-trigger zeabur-update.json
        
        # æäº¤è®Šæ›´
        git commit -m "update: å¼·åˆ¶æ›´æ–°ç¾æœ‰æœå‹™ç‚º Telegram Bot

- æ›´æ–° zeabur.json é…ç½®ç‚º Telegram Bot
- ä½¿ç”¨ main.py ä½œç‚ºå…¥å£é»
- å»ºç«‹éƒ¨ç½²è§¸ç™¼å™¨å¼·åˆ¶é‡å»º
- æ™‚é–“æˆ³: $(date -u +%Y%m%d_%H%M%S)

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>" || echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
        
        # æ¨é€è®Šæ›´
        git push || echo "æ¨é€å¤±æ•—æˆ–æ²’æœ‰è®Šæ›´"
        
        echo "âœ… é…ç½®è®Šæ›´å·²æ¨é€"
        
    - name: ğŸ¥ ç­‰å¾…ä¸¦é©—è­‰æœå‹™æ›´æ–°
      run: |
        echo "ğŸ¥ ç­‰å¾…æœå‹™æ›´æ–°ä¸¦é©—è­‰..."
        
        # ç­‰å¾…æœå‹™é‡å•Ÿ
        echo "â³ ç­‰å¾… 60 ç§’è®“æœå‹™é‡æ–°éƒ¨ç½²..."
        sleep 60
        
        # æª¢æŸ¥æœå‹™ç‹€æ…‹
        SERVICE_URL="https://namecard-app.zeabur.app"
        
        echo "ğŸ” æ¸¬è©¦æœå‹™å¥åº·ç‹€æ…‹..."
        for i in {1..10}; do
          echo "å˜—è©¦ $i/10..."
          
          if curl -f -s "$SERVICE_URL/health" > /dev/null; then
            echo "âœ… æœå‹™å¥åº·æª¢æŸ¥é€šé"
            
            # æª¢æŸ¥æ˜¯å¦æ˜¯ Telegram Bot
            health_response=$(curl -s "$SERVICE_URL/health")
            echo "å¥åº·æª¢æŸ¥å›æ‡‰: $health_response"
            
            # æª¢æŸ¥ Telegram webhook ç«¯é»
            if curl -f -s "$SERVICE_URL/telegram-webhook" > /dev/null; then
              echo "âœ… Telegram webhook ç«¯é»å¯ç”¨"
              echo "ğŸ‰ Telegram Bot æœå‹™æ›´æ–°æˆåŠŸï¼"
              echo ""
              echo "ğŸ“± **æœå‹™è³‡è¨Š:**"
              echo "- ğŸ”— æœå‹™ URL: $SERVICE_URL"
              echo "- ğŸ¥ å¥åº·æª¢æŸ¥: $SERVICE_URL/health"
              echo "- ğŸ“ Webhook: $SERVICE_URL/telegram-webhook"
              echo ""
              echo "ğŸ“‹ **å¾ŒçºŒæ­¥é©Ÿ:**"
              echo "1. è¨­å®š Telegram Bot Webhook URL"
              echo "2. æ¸¬è©¦ Telegram Bot åŠŸèƒ½"
              echo "3. é©—è­‰åç‰‡è­˜åˆ¥åŠŸèƒ½"
              
              exit 0
            else
              echo "âš ï¸ Telegram webhook ç«¯é»å°šæœªå¯ç”¨"
            fi
          else
            echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—"
          fi
          
          echo "â³ ç­‰å¾… 10 ç§’å¾Œé‡è©¦..."
          sleep 10
        done
        
        echo "âš ï¸ æœå‹™æ›´æ–°é©—è­‰æœªå®Œå…¨æˆåŠŸï¼Œä½†éƒ¨ç½²æµç¨‹å·²å®Œæˆ"
        echo "è«‹æ‰‹å‹•æª¢æŸ¥æœå‹™ç‹€æ…‹: $SERVICE_URL"
        
    - name: ğŸ“‹ æ›´æ–°ç¸½çµ
      if: always()
      run: |
        echo "ğŸ“‹ **Telegram Bot æœå‹™æ›´æ–°ç¸½çµ**"
        echo ""
        echo "âœ… **å®Œæˆçš„æ­¥é©Ÿ:**"
        echo "- æ›´æ–° zeabur.json é…ç½®"
        echo "- è¨­å®š Telegram Bot å…¥å£é» (main.py)"
        echo "- æ¨é€é…ç½®è®Šæ›´è§¸ç™¼é‡æ–°éƒ¨ç½²"
        echo "- ç­‰å¾…æœå‹™é‡æ–°å•Ÿå‹•"
        echo ""
        echo "ğŸ”— **æœå‹™è³‡è¨Š:**"
        echo "- ä¸»è¦ URL: https://namecard-app.zeabur.app"
        echo "- å¥åº·æª¢æŸ¥: https://namecard-app.zeabur.app/health"
        echo "- Telegram Webhook: https://namecard-app.zeabur.app/telegram-webhook"
        echo ""
        echo "ğŸ“‹ **å¾ŒçºŒå‹•ä½œ:**"
        echo "1. ç­‰å¾… 2-3 åˆ†é˜è®“æœå‹™å®Œå…¨å•Ÿå‹•"
        echo "2. è¨ªå•å¥åº·æª¢æŸ¥ç«¯é»ç¢ºèªæœå‹™ç‹€æ…‹"
        echo "3. è¨­å®š Telegram Bot Webhook"
        echo "4. æ¸¬è©¦ Telegram Bot åŠŸèƒ½"
        echo ""
        echo "ğŸ”§ **Telegram Webhook è¨­å®šæŒ‡ä»¤:**"
        echo 'curl -X POST "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook" -d "url=https://namecard-app.zeabur.app/telegram-webhook"'