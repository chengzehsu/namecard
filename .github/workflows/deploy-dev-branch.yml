name: ğŸš€ é–‹ç™¼åˆ†æ”¯å¿«é€Ÿéƒ¨ç½²

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'è¦éƒ¨ç½²çš„åˆ†æ”¯åç¨±'
        required: true
        default: 'dev-deploy'
        type: string
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - development
      auto_commit:
        description: 'è‡ªå‹•æäº¤æœª commit çš„è®Šæ›´'
        required: false
        default: true
        type: boolean
      cleanup_branch:
        description: 'éƒ¨ç½²å¾Œæ¸…ç†è‡¨æ™‚åˆ†æ”¯'
        required: false
        default: true
        type: boolean

env:
  BRANCH_NAME: ${{ github.event.inputs.branch_name }}
  TARGET_ENV: ${{ github.event.inputs.environment }}

jobs:
  prepare-deploy:
    name: ğŸ“‹ æº–å‚™éƒ¨ç½²ç’°å¢ƒ
    runs-on: ubuntu-latest
    
    outputs:
      deploy_branch: ${{ steps.branch-prep.outputs.deploy_branch }}
      has_changes: ${{ steps.check-changes.outputs.has_changes }}
      
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ“Š æª¢æŸ¥æœª commit è®Šæ›´
      id: check-changes
      run: |
        echo "æª¢æŸ¥å·¥ä½œç›®éŒ„ç‹€æ…‹..."
        git status --porcelain
        
        if [[ -n $(git status --porcelain) ]]; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "âš ï¸ ç™¼ç¾æœª commit çš„è®Šæ›´"
          git status --porcelain
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âœ… å·¥ä½œç›®éŒ„ä¹¾æ·¨"
        fi
        
    - name: ğŸŒ¿ æº–å‚™éƒ¨ç½²åˆ†æ”¯
      id: branch-prep
      run: |
        DEPLOY_BRANCH="${BRANCH_NAME:-dev-deploy-$(date +%Y%m%d-%H%M%S)}"
        echo "deploy_branch=$DEPLOY_BRANCH" >> $GITHUB_OUTPUT
        
        echo "ğŸ“‹ éƒ¨ç½²åˆ†æ”¯é…ç½®:"
        echo "- åˆ†æ”¯åç¨±: $DEPLOY_BRANCH"
        echo "- ç›®æ¨™ç’°å¢ƒ: $TARGET_ENV"
        echo "- è‡ªå‹•æäº¤: ${{ github.event.inputs.auto_commit }}"
        
        # æª¢æŸ¥åˆ†æ”¯æ˜¯å¦å·²å­˜åœ¨
        if git show-ref --verify --quiet refs/heads/$DEPLOY_BRANCH; then
          echo "âš ï¸ åˆ†æ”¯ $DEPLOY_BRANCH å·²å­˜åœ¨ï¼Œå°‡ä½¿ç”¨ç¾æœ‰åˆ†æ”¯"
        else
          echo "âœ… å°‡å‰µå»ºæ–°åˆ†æ”¯ $DEPLOY_BRANCH"
        fi

  create-deploy-branch:
    name: ğŸŒ¿ å‰µå»ºéƒ¨ç½²åˆ†æ”¯
    runs-on: ubuntu-latest
    needs: prepare-deploy
    if: github.event.inputs.auto_commit == 'true' && needs.prepare-deploy.outputs.has_changes == 'true'
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: âš™ï¸ Git é…ç½®
      run: |
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action Deploy Bot"
        
    - name: ğŸŒ¿ å‰µå»ºä¸¦åˆ‡æ›åˆ°éƒ¨ç½²åˆ†æ”¯
      run: |
        DEPLOY_BRANCH="${{ needs.prepare-deploy.outputs.deploy_branch }}"
        
        # å‰µå»ºæ–°åˆ†æ”¯ (å¦‚æœä¸å­˜åœ¨)
        if ! git show-ref --verify --quiet refs/heads/$DEPLOY_BRANCH; then
          git checkout -b $DEPLOY_BRANCH
          echo "âœ… å‰µå»ºæ–°åˆ†æ”¯: $DEPLOY_BRANCH"
        else
          git checkout $DEPLOY_BRANCH
          echo "âœ… åˆ‡æ›åˆ°ç¾æœ‰åˆ†æ”¯: $DEPLOY_BRANCH"
        fi
        
    - name: ğŸ“¦ æäº¤æœª commit çš„è®Šæ›´
      run: |
        # æ·»åŠ æ‰€æœ‰è®Šæ›´
        git add .
        
        # æª¢æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„è®Šæ›´
        if git diff --staged --quiet; then
          echo "âœ… æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
        else
          echo "ğŸ“¦ æäº¤è®Šæ›´åˆ°éƒ¨ç½²åˆ†æ”¯..."
          
          git commit -m "deploy: è‡ªå‹•æäº¤æœª commit è®Šæ›´ç”¨æ–¼éƒ¨ç½²

ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:
- ç›®æ¨™ç’°å¢ƒ: ${{ env.TARGET_ENV }}
- éƒ¨ç½²æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
- è§¸ç™¼è€…: ${{ github.actor }}
- å·¥ä½œæµ: ${{ github.workflow }}

ğŸ¤– æ­¤æäº¤ç”± GitHub Actions è‡ªå‹•å‰µå»º
ç”¨æ–¼å¿«é€Ÿéƒ¨ç½²æœªæäº¤çš„é–‹ç™¼ä»£ç¢¼åˆ°æ¸¬è©¦ç’°å¢ƒ

Co-Authored-By: GitHub Actions Deploy Bot <action@github.com>"

          echo "âœ… è®Šæ›´å·²æäº¤åˆ°åˆ†æ”¯: ${{ needs.prepare-deploy.outputs.deploy_branch }}"
        fi
        
    - name: ğŸš€ æ¨é€éƒ¨ç½²åˆ†æ”¯
      run: |
        DEPLOY_BRANCH="${{ needs.prepare-deploy.outputs.deploy_branch }}"
        
        echo "ğŸš€ æ¨é€åˆ†æ”¯åˆ°é ç«¯..."
        git push origin $DEPLOY_BRANCH
        
        echo "âœ… éƒ¨ç½²åˆ†æ”¯å·²æ¨é€: $DEPLOY_BRANCH"

  deploy-to-zeabur:
    name: ğŸš€ éƒ¨ç½²åˆ° Zeabur
    runs-on: ubuntu-latest
    needs: [prepare-deploy, create-deploy-branch]
    if: always() && needs.prepare-deploy.result == 'success'
    
    environment: 
      name: ${{ github.event.inputs.environment || 'staging' }}
      
    steps:
    - name: ğŸ”„ æª¢å‡ºéƒ¨ç½²åˆ†æ”¯
      uses: actions/checkout@v4
      with:
        ref: ${{ needs.prepare-deploy.outputs.deploy_branch }}
        fetch-depth: 0
        
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        pip install -r requirements-telegram.txt
        
    - name: ğŸ” é éƒ¨ç½²æª¢æŸ¥
      run: |
        echo "ğŸ” åŸ·è¡Œé éƒ¨ç½²æª¢æŸ¥..."
        
        # èªæ³•æª¢æŸ¥
        python -m py_compile main.py
        python -m py_compile telegram_app.py
        python -m py_compile config.py
        echo "âœ… èªæ³•æª¢æŸ¥é€šé"
        
        # æª¢æŸ¥å¿…è¦æ–‡ä»¶
        required_files=("main.py" "telegram_app.py" "requirements-telegram.txt" "zeabur.json")
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        
    - name: ğŸ› ï¸ å®‰è£ Zeabur CLI
      run: |
        echo "ğŸ“¦ å®‰è£ Zeabur CLI..."
        npm install -g @zeabur/cli@latest
        zeabur --version
        
    - name: ğŸ” é…ç½® Zeabur èªè­‰
      run: |
        echo "ğŸ” é…ç½® Zeabur èªè­‰..."
        echo "${{ secrets.ZEABUR_TOKEN }}" | zeabur auth login --token
        
    - name: ğŸ“ å‰µå»ºé–‹ç™¼ç’°å¢ƒé…ç½®
      run: |
        echo "ğŸ“ å‰µå»ºé–‹ç™¼ç’°å¢ƒéƒ¨ç½²é…ç½®..."
        
        # ç‚ºé–‹ç™¼ç’°å¢ƒå‰µå»ºç‰¹æ®Šé…ç½®
        ENV_SUFFIX=""
        if [ "${{ env.TARGET_ENV }}" = "staging" ]; then
          ENV_SUFFIX="-staging"
        elif [ "${{ env.TARGET_ENV }}" = "development" ]; then
          ENV_SUFFIX="-dev"
        fi
        
        cat > zeabur-dev.json << EOF
        {
          "name": "namecard-telegram-bot${ENV_SUFFIX}",
          "build": {
            "command": "pip install -r requirements-telegram.txt"
          },
          "start": {
            "command": "python main.py"
          },
          "environment": {
            "PORT": "5003",
            "PYTHON_VERSION": "3.9",
            "FLASK_ENV": "${{ env.TARGET_ENV }}",
            "PYTHONUNBUFFERED": "1",
            "SERVICE_TYPE": "telegram-bot",
            "DEPLOY_BRANCH": "${{ needs.prepare-deploy.outputs.deploy_branch }}",
            "DEPLOY_TIME": "$(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          }
        }
        EOF
        
        echo "âœ… é–‹ç™¼ç’°å¢ƒé…ç½®å·²å‰µå»º"
        cat zeabur-dev.json
        
    - name: ğŸš€ éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ°é–‹ç™¼ç’°å¢ƒ..."
        
        # ä½¿ç”¨é–‹ç™¼ç’°å¢ƒé…ç½®éƒ¨ç½²
        cp zeabur-dev.json zeabur.json
        
        # éƒ¨ç½²
        zeabur deploy --name="namecard-telegram-bot-${{ env.TARGET_ENV }}" || {
          echo "âš ï¸ ç›´æ¥éƒ¨ç½²å¤±æ•—ï¼Œå˜—è©¦å‰µå»ºæ–°æœå‹™..."
          zeabur deploy --create=true --name="namecard-telegram-bot-${{ env.TARGET_ENV }}"
        }
        
        echo "âœ… éƒ¨ç½²å®Œæˆ"
        
    - name: ğŸ”§ è¨­ç½®ç’°å¢ƒè®Šæ•¸
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_API_KEY_FALLBACK: ${{ secrets.GOOGLE_API_KEY_FALLBACK }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "ğŸ”§ è¨­ç½®é–‹ç™¼ç’°å¢ƒè®Šæ•¸..."
        
        SERVICE_NAME="namecard-telegram-bot-${{ env.TARGET_ENV }}"
        
        # è¨­ç½®æ‰€æœ‰ç’°å¢ƒè®Šæ•¸
        env_vars=(
          "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN"
          "GOOGLE_API_KEY=$GOOGLE_API_KEY"
          "GOOGLE_API_KEY_FALLBACK=$GOOGLE_API_KEY_FALLBACK"
          "NOTION_API_KEY=$NOTION_API_KEY"
          "NOTION_DATABASE_ID=$NOTION_DATABASE_ID"
          "PORT=5003"
          "FLASK_ENV=${{ env.TARGET_ENV }}"
          "PYTHONUNBUFFERED=1"
        )
        
        for env_var in "${env_vars[@]}"; do
          key=$(echo "$env_var" | cut -d'=' -f1)
          value=$(echo "$env_var" | cut -d'=' -f2-)
          
          if [ -n "$value" ]; then
            zeabur variable create --name="$SERVICE_NAME" -k "$key=$value" -y || {
              echo "âš ï¸ è¨­ç½® $key å¤±æ•—ï¼Œä½†ç¹¼çºŒåŸ·è¡Œ"
            }
          fi
        done
        
        echo "âœ… ç’°å¢ƒè®Šæ•¸è¨­ç½®å®Œæˆ"
        
    - name: ğŸ¥ å¥åº·æª¢æŸ¥
      run: |
        echo "ğŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥..."
        
        # ç­‰å¾…æœå‹™å•Ÿå‹•
        sleep 30
        
        # å˜—è©¦ç²å–æœå‹™ URL
        SERVICE_URL=$(zeabur service list | grep -o 'https://[^[:space:]]*' | head -1 || echo "")
        
        if [ -n "$SERVICE_URL" ]; then
          echo "ğŸŒ æœå‹™ URL: $SERVICE_URL"
          
          # å¥åº·æª¢æŸ¥
          for i in {1..5}; do
            if curl -f -s "$SERVICE_URL/health" > /dev/null; then
              echo "âœ… å¥åº·æª¢æŸ¥é€šé"
              break
            fi
            echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹•... ($i/5)"
            sleep 10
          done
        else
          echo "âš ï¸ ç„¡æ³•ç²å–æœå‹™ URLï¼Œè«‹æ‰‹å‹•æª¢æŸ¥éƒ¨ç½²ç‹€æ…‹"
        fi

  cleanup:
    name: ğŸ§¹ æ¸…ç†è‡¨æ™‚åˆ†æ”¯
    runs-on: ubuntu-latest
    needs: [prepare-deploy, deploy-to-zeabur]
    if: always() && github.event.inputs.cleanup_branch == 'true' && needs.prepare-deploy.outputs.deploy_branch != 'main'
    
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ—‘ï¸ æ¸…ç†éƒ¨ç½²åˆ†æ”¯
      run: |
        DEPLOY_BRANCH="${{ needs.prepare-deploy.outputs.deploy_branch }}"
        
        if [ "$DEPLOY_BRANCH" != "main" ] && [ "$DEPLOY_BRANCH" != "develop" ]; then
          echo "ğŸ—‘ï¸ æ¸…ç†è‡¨æ™‚éƒ¨ç½²åˆ†æ”¯: $DEPLOY_BRANCH"
          
          # åˆªé™¤æœ¬åœ°åˆ†æ”¯
          git branch -D $DEPLOY_BRANCH 2>/dev/null || echo "æœ¬åœ°åˆ†æ”¯ä¸å­˜åœ¨"
          
          # åˆªé™¤é ç«¯åˆ†æ”¯
          git push origin --delete $DEPLOY_BRANCH 2>/dev/null || echo "é ç«¯åˆ†æ”¯ä¸å­˜åœ¨"
          
          echo "âœ… è‡¨æ™‚åˆ†æ”¯æ¸…ç†å®Œæˆ"
        else
          echo "âš ï¸ è·³éæ¸…ç†ä¸»è¦åˆ†æ”¯: $DEPLOY_BRANCH"
        fi

  notify-completion:
    name: ğŸ“¢ éƒ¨ç½²å®Œæˆé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [prepare-deploy, deploy-to-zeabur, cleanup]
    if: always()
    
    steps:
    - name: ğŸ“Š éƒ¨ç½²çµæœå ±å‘Š
      run: |
        echo "ğŸ“Š **é–‹ç™¼åˆ†æ”¯éƒ¨ç½²çµæœå ±å‘Š**"
        echo ""
        
        DEPLOY_STATUS="${{ needs.deploy-to-zeabur.result }}"
        CLEANUP_STATUS="${{ needs.cleanup.result }}"
        
        if [ "$DEPLOY_STATUS" = "success" ]; then
          echo "ğŸ‰ **éƒ¨ç½²æˆåŠŸ!**"
          echo "âœ… é–‹ç™¼åˆ†æ”¯å·²æˆåŠŸéƒ¨ç½²åˆ° ${{ env.TARGET_ENV }} ç’°å¢ƒ"
        else
          echo "âŒ **éƒ¨ç½²å¤±æ•—**"
          echo "è«‹æª¢æŸ¥éƒ¨ç½²æ—¥èªŒæ’æŸ¥å•é¡Œ"
        fi
        
        echo ""
        echo "ğŸ“‹ **éƒ¨ç½²è©³æƒ…:**"
        echo "- ğŸŒ¿ éƒ¨ç½²åˆ†æ”¯: ${{ needs.prepare-deploy.outputs.deploy_branch }}"
        echo "- ğŸ·ï¸ ç›®æ¨™ç’°å¢ƒ: ${{ env.TARGET_ENV }}"
        echo "- ğŸ‘¤ è§¸ç™¼è€…: ${{ github.actor }}"
        echo "- ğŸ“… éƒ¨ç½²æ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        
        if [ "${{ github.event.inputs.cleanup_branch }}" = "true" ]; then
          if [ "$CLEANUP_STATUS" = "success" ]; then
            echo "- ğŸ§¹ è‡¨æ™‚åˆ†æ”¯: å·²æ¸…ç†"
          else
            echo "- ğŸ§¹ è‡¨æ™‚åˆ†æ”¯: æ¸…ç†å¤±æ•—æˆ–è·³é"
          fi
        else
          echo "- ğŸ§¹ è‡¨æ™‚åˆ†æ”¯: ä¿ç•™ (${{ needs.prepare-deploy.outputs.deploy_branch }})"
        fi
        
        echo ""
        echo "ğŸ”— **ç›¸é—œé€£çµ:**"
        echo "- [Zeabur Dashboard](https://dash.zeabur.com/)"
        echo "- [æŸ¥çœ‹éƒ¨ç½²æ—¥èªŒ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"