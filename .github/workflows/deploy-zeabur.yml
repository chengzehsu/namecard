name: 部署到 Zeabur

on:
  # 手動觸發或在有 ZEABUR_TOKEN 時自動部署
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'CLAUDE.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/deploy-zeabur.yml'
  
  # 手動觸發部署
  workflow_dispatch:
    inputs:
      environment:
        description: '部署環境'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      
      force_deploy:
        description: '強制部署 (跳過測試)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.9'
  ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}

jobs:
  # 預部署檢查 (可選跳過)
  pre-deploy-checks:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.force_deploy != 'true'
    
    steps:
    - name: Checkout 代碼
      uses: actions/checkout@v4
      
    - name: 設置 Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: 安裝依賴
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: 快速語法檢查
      run: |
        echo "🔍 執行快速語法檢查..."
        python -m py_compile app.py
        python -c "import app; print('✅ app.py 語法正確')"
        
    - name: 檢查必要文件
      run: |
        echo "📋 檢查部署必要文件..."
        
        # 檢查必要文件
        files=("app.py" "requirements.txt" "config.py")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "✅ $file 存在"
          else
            echo "❌ $file 缺失"
            exit 1
          fi
        done
        
        # 檢查 requirements.txt 內容
        echo "📦 檢查 Python 依賴:"
        cat requirements.txt
        
        echo "✅ 部署檢查完成"

  # 部署到 Zeabur
  deploy-to-zeabur:
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: always() && (needs.pre-deploy-checks.result == 'success' || needs.pre-deploy-checks.result == 'skipped' || github.event_name == 'push')
    
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.app_url }}
    
    steps:
    - name: Checkout 代碼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Zeabur 可能需要完整的 Git 歷史
        
    - name: 檢查 Zeabur Token
      run: |
        if [ -z "$ZEABUR_TOKEN" ]; then
          echo "❌ ZEABUR_TOKEN 未設置"
          echo "請在 GitHub Secrets 中設置 ZEABUR_TOKEN"
          echo "獲取方式: https://dash.zeabur.com/account/developer"
          exit 1
        else
          echo "✅ Zeabur Token 已設置"
        fi
        
    - name: 安裝 Zeabur CLI
      run: |
        echo "📦 安裝 Zeabur CLI..."
        curl -fsSL https://zeabur.com/install.sh | bash
        
        # 添加到 PATH
        echo "$HOME/.zeabur/bin" >> $GITHUB_PATH
        
        # 驗證安裝
        $HOME/.zeabur/bin/zeabur --version
        
    - name: 配置 Zeabur 認證
      run: |
        echo "🔐 配置 Zeabur 認證..."
        echo "$ZEABUR_TOKEN" | $HOME/.zeabur/bin/zeabur auth login --token
        echo "✅ Zeabur 認證成功"
        
    - name: 創建部署配置
      run: |
        echo "⚙️ 創建 Zeabur 部署配置..."
        
        # 創建 zeabur.json 配置文件
        cat > zeabur.json << END_OF_CONFIG
        {
          "name": "namecard-line-bot",
          "type": "python",
          "buildCommand": "pip install -r requirements.txt",
          "startCommand": "python app.py",
          "environment": {
            "PYTHON_VERSION": "3.9",
            "PORT": "5002"
          },
          "regions": ["hkg"],
          "scaling": {
            "minInstances": 1,
            "maxInstances": 2
          }
        }
        END_OF_CONFIG
        
        echo "✅ 配置文件已創建"
        cat zeabur.json
        
    - name: 部署到 Zeabur
      id: deploy
      run: |
        echo "🚀 開始部署到 Zeabur..."
        
        PROJECT_NAME="namecard-line-bot"
        SERVICE_NAME="namecard-app"
        
        # 檢查專案是否存在，不存在則創建
        if ! $HOME/.zeabur/bin/zeabur project list | grep -q "$PROJECT_NAME"; then
          echo "📁 創建新專案: $PROJECT_NAME"
          $HOME/.zeabur/bin/zeabur project create "$PROJECT_NAME"
        else
          echo "✅ 專案已存在: $PROJECT_NAME"
        fi
        
        # 部署服務
        echo "🔧 部署服務..."
        DEPLOY_OUTPUT=$($HOME/.zeabur/bin/zeabur service deploy \
          --project="$PROJECT_NAME" \
          --service="$SERVICE_NAME" \
          --source=. \
          --type=python 2>&1)
        
        echo "$DEPLOY_OUTPUT"
        
        # 提取部署 URL (假設輸出包含 URL)
        APP_URL=$(echo "$DEPLOY_OUTPUT" | grep -oP 'https://[^\s]+' | head -1)
        
        if [ -n "$APP_URL" ]; then
          echo "✅ 部署成功!"
          echo "🔗 應用 URL: $APP_URL"
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
        else
          echo "⚠️ 部署完成，但無法提取 URL"
          echo "請前往 Zeabur Dashboard 查看: https://dash.zeabur.com/"
          echo "app_url=https://dash.zeabur.com/" >> $GITHUB_OUTPUT
        fi
        
    - name: 設置環境變數
      env:
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "🔧 設置 Zeabur 環境變數..."
        
        PROJECT_NAME="namecard-line-bot"
        SERVICE_NAME="namecard-app"
        
        # 設置所有必要的環境變數
        env_vars=(
          "LINE_CHANNEL_ACCESS_TOKEN=$LINE_CHANNEL_ACCESS_TOKEN"
          "LINE_CHANNEL_SECRET=$LINE_CHANNEL_SECRET"
          "GOOGLE_API_KEY=$GOOGLE_API_KEY"
          "NOTION_API_KEY=$NOTION_API_KEY"
          "NOTION_DATABASE_ID=$NOTION_DATABASE_ID"
          "PORT=5002"
          "FLASK_ENV=production"
        )
        
        for env_var in "${env_vars[@]}"; do
          key=$(echo "$env_var" | cut -d'=' -f1)
          value=$(echo "$env_var" | cut -d'=' -f2-)
          
          if [ -n "$value" ] && [ "$value" != "" ]; then
            echo "🔑 設置環境變數: $key"
            $HOME/.zeabur/bin/zeabur env set \
              --project="$PROJECT_NAME" \
              --service="$SERVICE_NAME" \
              "$key" "$value" || echo "⚠️ 設置 $key 失敗"
          else
            echo "⚠️ 跳過空值環境變數: $key"
          fi
        done
        
        echo "✅ 環境變數設置完成"
        
    - name: 健康檢查
      if: steps.deploy.outputs.app_url != ''
      run: |
        echo "🏥 執行部署後健康檢查..."
        
        APP_URL="${{ steps.deploy.outputs.app_url }}"
        
        # 等待服務啟動
        echo "⏳ 等待服務啟動 (30秒)..."
        sleep 30
        
        # 嘗試健康檢查
        for i in {1..5}; do
          echo "🔍 健康檢查嘗試 $i/5..."
          
          if curl -f -s "$APP_URL/health" > /dev/null; then
            echo "✅ 健康檢查通過!"
            echo "🎉 應用已成功部署並運行"
            
            # 顯示應用信息
            echo ""
            echo "📱 **部署完成信息:**"
            echo "- 🔗 應用 URL: $APP_URL"
            echo "- 🏥 健康檢查: $APP_URL/health"
            echo "- 🧪 測試端點: $APP_URL/test"
            echo "- 📞 Webhook URL: $APP_URL/callback"
            
            exit 0
          fi
          
          echo "⏳ 等待 10 秒後重試..."
          sleep 10
        done
        
        echo "⚠️ 健康檢查失敗，但不影響部署流程"
        echo "請手動檢查應用狀態: $APP_URL"
        
    - name: 更新 LINE Webhook URL 提醒
      if: steps.deploy.outputs.app_url != ''
      run: |
        echo "📢 重要提醒: 更新 LINE Bot Webhook URL"
        echo ""
        echo "請前往 LINE Developers Console 更新 Webhook URL:"
        echo "🔗 新的 Webhook URL: ${{ steps.deploy.outputs.app_url }}/callback"
        echo ""
        echo "步驟:"
        echo "1. 前往 https://developers.line.biz/console/"
        echo "2. 選擇您的 Channel"
        echo "3. 前往 Messaging API 標籤"
        echo "4. 更新 Webhook URL 為: ${{ steps.deploy.outputs.app_url }}/callback"
        echo "5. 啟用 'Use webhook'"
        echo "6. 測試 webhook 連接"

  # 部署後測試
  post-deploy-tests:
    runs-on: ubuntu-latest
    needs: deploy-to-zeabur
    if: needs.deploy-to-zeabur.outputs.app_url != ''
    
    steps:
    - name: 部署後端點測試
      run: |
        echo "🧪 執行部署後測試..."
        
        APP_URL="${{ needs.deploy-to-zeabur.outputs.app_url }}"
        
        # 測試健康端點
        echo "🏥 測試健康檢查端點..."
        if curl -f -s "$APP_URL/health"; then
          echo "✅ 健康檢查端點正常"
        else
          echo "❌ 健康檢查端點異常"
        fi
        
        # 測試回調端點
        echo "📞 測試回調端點..."
        if curl -f -s "$APP_URL/callback"; then
          echo "✅ 回調端點可訪問"
        else
          echo "❌ 回調端點不可訪問"
        fi
        
        echo "✅ 部署後測試完成"

  # 通知部署結果
  notify-deployment:
    runs-on: ubuntu-latest
    needs: [deploy-to-zeabur, post-deploy-tests]
    if: always()
    
    steps:
    - name: 部署結果通知
      run: |
        DEPLOY_STATUS="${{ needs.deploy-to-zeabur.result }}"
        TEST_STATUS="${{ needs.post-deploy-tests.result }}"
        APP_URL="${{ needs.deploy-to-zeabur.outputs.app_url }}"
        
        echo "📊 **Zeabur 部署結果報告**"
        echo ""
        
        if [ "$DEPLOY_STATUS" = "success" ]; then
          echo "🎉 **部署成功!**"
          echo "✅ 應用已成功部署到 Zeabur"
          
          if [ -n "$APP_URL" ]; then
            echo "🔗 **應用 URL:** $APP_URL"
            echo "📞 **Webhook URL:** $APP_URL/callback"
          fi
          
          echo ""
          echo "📋 **後續步驟:**"
          echo "1. 更新 LINE Bot Webhook URL"
          echo "2. 測試 LINE Bot 功能"
          echo "3. 檢查應用日誌"
          
        else
          echo "❌ **部署失敗**"
          echo "請檢查部署日誌排查問題"
        fi
        
        if [ "$TEST_STATUS" = "success" ]; then
          echo "✅ 部署後測試通過"
        elif [ "$TEST_STATUS" = "failure" ]; then
          echo "⚠️ 部署後測試失敗"
        fi
        
        echo ""
        echo "🔗 **相關連結:**"
        echo "- [Zeabur Dashboard](https://dash.zeabur.com/)"
        echo "- [查看部署日誌](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        echo "- [LINE Developers Console](https://developers.line.biz/console/)"