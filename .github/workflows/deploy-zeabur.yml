name: éƒ¨ç½²åˆ° Zeabur

on:
  # æ‰‹å‹•è§¸ç™¼æˆ–åœ¨æœ‰ ZEABUR_TOKEN æ™‚è‡ªå‹•éƒ¨ç½²
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'CLAUDE.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/deploy-zeabur.yml'
  
  # æ‰‹å‹•è§¸ç™¼éƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½² (è·³éæ¸¬è©¦)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.9'
  ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}

jobs:
  # é éƒ¨ç½²æª¢æŸ¥ (å¯é¸è·³é)
  pre-deploy-checks:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.force_deploy != 'true'
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: å¿«é€Ÿèªæ³•æª¢æŸ¥
      run: |
        echo "ğŸ” åŸ·è¡Œå¿«é€Ÿèªæ³•æª¢æŸ¥..."
        python -m py_compile app.py
        python -c "import app; print('âœ… app.py èªæ³•æ­£ç¢º')"
        
    - name: æª¢æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "ğŸ“‹ æª¢æŸ¥éƒ¨ç½²å¿…è¦æ–‡ä»¶..."
        
        # æª¢æŸ¥å¿…è¦æ–‡ä»¶
        files=("app.py" "requirements.txt" "config.py")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        
        # æª¢æŸ¥ requirements.txt å…§å®¹
        echo "ğŸ“¦ æª¢æŸ¥ Python ä¾è³´:"
        cat requirements.txt
        
        echo "âœ… éƒ¨ç½²æª¢æŸ¥å®Œæˆ"

  # éƒ¨ç½²åˆ° Zeabur
  deploy-to-zeabur:
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: always() && (needs.pre-deploy-checks.result == 'success' || needs.pre-deploy-checks.result == 'skipped' || github.event_name == 'push')
    
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.app_url }}
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Zeabur å¯èƒ½éœ€è¦å®Œæ•´çš„ Git æ­·å²
        
    - name: æª¢æŸ¥ Zeabur Token
      run: |
        if [ -z "$ZEABUR_TOKEN" ]; then
          echo "âŒ ZEABUR_TOKEN æœªè¨­ç½®"
          echo "è«‹åœ¨ GitHub Secrets ä¸­è¨­ç½® ZEABUR_TOKEN"
          echo "ç²å–æ–¹å¼: https://dash.zeabur.com/account/developer"
          exit 1
        else
          echo "âœ… Zeabur Token å·²è¨­ç½®"
        fi
        
    - name: å®‰è£ Zeabur CLI
      run: |
        echo "ğŸ“¦ å®‰è£ Zeabur CLI..."
        curl -fsSL https://zeabur.com/install.sh | bash
        
        # æ·»åŠ åˆ° PATH
        echo "$HOME/.zeabur/bin" >> $GITHUB_PATH
        
        # é©—è­‰å®‰è£
        $HOME/.zeabur/bin/zeabur --version
        
    - name: é…ç½® Zeabur èªè­‰
      run: |
        echo "ğŸ” é…ç½® Zeabur èªè­‰..."
        echo "$ZEABUR_TOKEN" | $HOME/.zeabur/bin/zeabur auth login --token
        echo "âœ… Zeabur èªè­‰æˆåŠŸ"
        
    - name: å‰µå»ºéƒ¨ç½²é…ç½®
      run: |
        echo "âš™ï¸ å‰µå»º Zeabur éƒ¨ç½²é…ç½®..."
        
        # å‰µå»º zeabur.json é…ç½®æ–‡ä»¶
        cat > zeabur.json << END_OF_CONFIG
        {
          "name": "namecard-line-bot",
          "type": "python",
          "buildCommand": "pip install -r requirements.txt",
          "startCommand": "python app.py",
          "environment": {
            "PYTHON_VERSION": "3.9",
            "PORT": "5002"
          },
          "regions": ["hkg"],
          "scaling": {
            "minInstances": 1,
            "maxInstances": 2
          }
        }
        END_OF_CONFIG
        
        echo "âœ… é…ç½®æ–‡ä»¶å·²å‰µå»º"
        cat zeabur.json
        
    - name: éƒ¨ç½²åˆ° Zeabur
      id: deploy
      run: |
        echo "ğŸš€ é–‹å§‹éƒ¨ç½²åˆ° Zeabur..."
        
        PROJECT_NAME="namecard-line-bot"
        SERVICE_NAME="namecard-app"
        
        # æª¢æŸ¥å°ˆæ¡ˆæ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å‰‡å‰µå»º
        if ! $HOME/.zeabur/bin/zeabur project list | grep -q "$PROJECT_NAME"; then
          echo "ğŸ“ å‰µå»ºæ–°å°ˆæ¡ˆ: $PROJECT_NAME"
          $HOME/.zeabur/bin/zeabur project create "$PROJECT_NAME"
        else
          echo "âœ… å°ˆæ¡ˆå·²å­˜åœ¨: $PROJECT_NAME"
        fi
        
        # éƒ¨ç½²æœå‹™
        echo "ğŸ”§ éƒ¨ç½²æœå‹™..."
        DEPLOY_OUTPUT=$($HOME/.zeabur/bin/zeabur service deploy \
          --project="$PROJECT_NAME" \
          --service="$SERVICE_NAME" \
          --source=. \
          --type=python 2>&1)
        
        echo "$DEPLOY_OUTPUT"
        
        # æå–éƒ¨ç½² URL (å‡è¨­è¼¸å‡ºåŒ…å« URL)
        APP_URL=$(echo "$DEPLOY_OUTPUT" | grep -oP 'https://[^\s]+' | head -1)
        
        if [ -n "$APP_URL" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸ!"
          echo "ğŸ”— æ‡‰ç”¨ URL: $APP_URL"
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ éƒ¨ç½²å®Œæˆï¼Œä½†ç„¡æ³•æå– URL"
          echo "è«‹å‰å¾€ Zeabur Dashboard æŸ¥çœ‹: https://dash.zeabur.com/"
          echo "app_url=https://dash.zeabur.com/" >> $GITHUB_OUTPUT
        fi
        
    - name: è¨­ç½®ç’°å¢ƒè®Šæ•¸
      env:
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "ğŸ”§ è¨­ç½® Zeabur ç’°å¢ƒè®Šæ•¸..."
        
        PROJECT_NAME="namecard-line-bot"
        SERVICE_NAME="namecard-app"
        
        # è¨­ç½®æ‰€æœ‰å¿…è¦çš„ç’°å¢ƒè®Šæ•¸
        env_vars=(
          "LINE_CHANNEL_ACCESS_TOKEN=$LINE_CHANNEL_ACCESS_TOKEN"
          "LINE_CHANNEL_SECRET=$LINE_CHANNEL_SECRET"
          "GOOGLE_API_KEY=$GOOGLE_API_KEY"
          "NOTION_API_KEY=$NOTION_API_KEY"
          "NOTION_DATABASE_ID=$NOTION_DATABASE_ID"
          "PORT=5002"
          "FLASK_ENV=production"
        )
        
        for env_var in "${env_vars[@]}"; do
          key=$(echo "$env_var" | cut -d'=' -f1)
          value=$(echo "$env_var" | cut -d'=' -f2-)
          
          if [ -n "$value" ] && [ "$value" != "" ]; then
            echo "ğŸ”‘ è¨­ç½®ç’°å¢ƒè®Šæ•¸: $key"
            $HOME/.zeabur/bin/zeabur env set \
              --project="$PROJECT_NAME" \
              --service="$SERVICE_NAME" \
              "$key" "$value" || echo "âš ï¸ è¨­ç½® $key å¤±æ•—"
          else
            echo "âš ï¸ è·³éç©ºå€¼ç’°å¢ƒè®Šæ•¸: $key"
          fi
        done
        
        echo "âœ… ç’°å¢ƒè®Šæ•¸è¨­ç½®å®Œæˆ"
        
    - name: å¥åº·æª¢æŸ¥
      if: steps.deploy.outputs.app_url != ''
      run: |
        echo "ğŸ¥ åŸ·è¡Œéƒ¨ç½²å¾Œå¥åº·æª¢æŸ¥..."
        
        APP_URL="${{ steps.deploy.outputs.app_url }}"
        
        # ç­‰å¾…æœå‹™å•Ÿå‹•
        echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹• (30ç§’)..."
        sleep 30
        
        # å˜—è©¦å¥åº·æª¢æŸ¥
        for i in {1..5}; do
          echo "ğŸ” å¥åº·æª¢æŸ¥å˜—è©¦ $i/5..."
          
          if curl -f -s "$APP_URL/health" > /dev/null; then
            echo "âœ… å¥åº·æª¢æŸ¥é€šé!"
            echo "ğŸ‰ æ‡‰ç”¨å·²æˆåŠŸéƒ¨ç½²ä¸¦é‹è¡Œ"
            
            # é¡¯ç¤ºæ‡‰ç”¨ä¿¡æ¯
            echo ""
            echo "ğŸ“± **éƒ¨ç½²å®Œæˆä¿¡æ¯:**"
            echo "- ğŸ”— æ‡‰ç”¨ URL: $APP_URL"
            echo "- ğŸ¥ å¥åº·æª¢æŸ¥: $APP_URL/health"
            echo "- ğŸ§ª æ¸¬è©¦ç«¯é»: $APP_URL/test"
            echo "- ğŸ“ Webhook URL: $APP_URL/callback"
            
            exit 0
          fi
          
          echo "â³ ç­‰å¾… 10 ç§’å¾Œé‡è©¦..."
          sleep 10
        done
        
        echo "âš ï¸ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿éƒ¨ç½²æµç¨‹"
        echo "è«‹æ‰‹å‹•æª¢æŸ¥æ‡‰ç”¨ç‹€æ…‹: $APP_URL"
        
    - name: æ›´æ–° LINE Webhook URL æé†’
      if: steps.deploy.outputs.app_url != ''
      run: |
        echo "ğŸ“¢ é‡è¦æé†’: æ›´æ–° LINE Bot Webhook URL"
        echo ""
        echo "è«‹å‰å¾€ LINE Developers Console æ›´æ–° Webhook URL:"
        echo "ğŸ”— æ–°çš„ Webhook URL: ${{ steps.deploy.outputs.app_url }}/callback"
        echo ""
        echo "æ­¥é©Ÿ:"
        echo "1. å‰å¾€ https://developers.line.biz/console/"
        echo "2. é¸æ“‡æ‚¨çš„ Channel"
        echo "3. å‰å¾€ Messaging API æ¨™ç±¤"
        echo "4. æ›´æ–° Webhook URL ç‚º: ${{ steps.deploy.outputs.app_url }}/callback"
        echo "5. å•Ÿç”¨ 'Use webhook'"
        echo "6. æ¸¬è©¦ webhook é€£æ¥"

  # éƒ¨ç½²å¾Œæ¸¬è©¦
  post-deploy-tests:
    runs-on: ubuntu-latest
    needs: deploy-to-zeabur
    if: needs.deploy-to-zeabur.outputs.app_url != ''
    
    steps:
    - name: éƒ¨ç½²å¾Œç«¯é»æ¸¬è©¦
      run: |
        echo "ğŸ§ª åŸ·è¡Œéƒ¨ç½²å¾Œæ¸¬è©¦..."
        
        APP_URL="${{ needs.deploy-to-zeabur.outputs.app_url }}"
        
        # æ¸¬è©¦å¥åº·ç«¯é»
        echo "ğŸ¥ æ¸¬è©¦å¥åº·æª¢æŸ¥ç«¯é»..."
        if curl -f -s "$APP_URL/health"; then
          echo "âœ… å¥åº·æª¢æŸ¥ç«¯é»æ­£å¸¸"
        else
          echo "âŒ å¥åº·æª¢æŸ¥ç«¯é»ç•°å¸¸"
        fi
        
        # æ¸¬è©¦å›èª¿ç«¯é»
        echo "ğŸ“ æ¸¬è©¦å›èª¿ç«¯é»..."
        if curl -f -s "$APP_URL/callback"; then
          echo "âœ… å›èª¿ç«¯é»å¯è¨ªå•"
        else
          echo "âŒ å›èª¿ç«¯é»ä¸å¯è¨ªå•"
        fi
        
        echo "âœ… éƒ¨ç½²å¾Œæ¸¬è©¦å®Œæˆ"

  # é€šçŸ¥éƒ¨ç½²çµæœ
  notify-deployment:
    runs-on: ubuntu-latest
    needs: [deploy-to-zeabur, post-deploy-tests]
    if: always()
    
    steps:
    - name: éƒ¨ç½²çµæœé€šçŸ¥
      run: |
        DEPLOY_STATUS="${{ needs.deploy-to-zeabur.result }}"
        TEST_STATUS="${{ needs.post-deploy-tests.result }}"
        APP_URL="${{ needs.deploy-to-zeabur.outputs.app_url }}"
        
        echo "ğŸ“Š **Zeabur éƒ¨ç½²çµæœå ±å‘Š**"
        echo ""
        
        if [ "$DEPLOY_STATUS" = "success" ]; then
          echo "ğŸ‰ **éƒ¨ç½²æˆåŠŸ!**"
          echo "âœ… æ‡‰ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ° Zeabur"
          
          if [ -n "$APP_URL" ]; then
            echo "ğŸ”— **æ‡‰ç”¨ URL:** $APP_URL"
            echo "ğŸ“ **Webhook URL:** $APP_URL/callback"
          fi
          
          echo ""
          echo "ğŸ“‹ **å¾ŒçºŒæ­¥é©Ÿ:**"
          echo "1. æ›´æ–° LINE Bot Webhook URL"
          echo "2. æ¸¬è©¦ LINE Bot åŠŸèƒ½"
          echo "3. æª¢æŸ¥æ‡‰ç”¨æ—¥èªŒ"
          
        else
          echo "âŒ **éƒ¨ç½²å¤±æ•—**"
          echo "è«‹æª¢æŸ¥éƒ¨ç½²æ—¥èªŒæ’æŸ¥å•é¡Œ"
        fi
        
        if [ "$TEST_STATUS" = "success" ]; then
          echo "âœ… éƒ¨ç½²å¾Œæ¸¬è©¦é€šé"
        elif [ "$TEST_STATUS" = "failure" ]; then
          echo "âš ï¸ éƒ¨ç½²å¾Œæ¸¬è©¦å¤±æ•—"
        fi
        
        echo ""
        echo "ğŸ”— **ç›¸é—œé€£çµ:**"
        echo "- [Zeabur Dashboard](https://dash.zeabur.com/)"
        echo "- [æŸ¥çœ‹éƒ¨ç½²æ—¥èªŒ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        echo "- [LINE Developers Console](https://developers.line.biz/console/)"