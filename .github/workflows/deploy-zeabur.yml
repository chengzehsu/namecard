name: éƒ¨ç½²åˆ° Zeabur

on:
  # æ‰‹å‹•è§¸ç™¼æˆ–åœ¨æœ‰ ZEABUR_TOKEN æ™‚è‡ªå‹•éƒ¨ç½²
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'CLAUDE.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/deploy-zeabur.yml'
  
  # æ‰‹å‹•è§¸ç™¼éƒ¨ç½²
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      
      force_deploy:
        description: 'å¼·åˆ¶éƒ¨ç½² (è·³éæ¸¬è©¦)'
        required: false
        type: boolean
        default: false

env:
  PYTHON_VERSION: '3.9'
  ZEABUR_TOKEN: ${{ secrets.ZEABUR_TOKEN }}

jobs:
  # é éƒ¨ç½²æª¢æŸ¥ (å¯é¸è·³é)
  pre-deploy-checks:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.force_deploy != 'true'
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r deployment/environments/production/requirements-telegram.txt
        
    - name: å¿«é€Ÿèªæ³•æª¢æŸ¥
      run: |
        echo "ğŸ” åŸ·è¡Œå¿«é€Ÿèªæ³•æª¢æŸ¥..."
        python -m py_compile main.py
        echo "âœ… main.py èªæ³•æª¢æŸ¥é€šé"
        
        python -m py_compile src/namecard/api/telegram_bot/telegram_main.py
        echo "âœ… telegram_main.py èªæ³•æª¢æŸ¥é€šé"
        
        # æª¢æŸ¥ä¸»è¦æ¨¡çµ„æ˜¯å¦å¯ä»¥ç·¨è­¯
        python -m py_compile config/base.py
        python -m py_compile src/namecard/infrastructure/ai/card_processor.py
        python -m py_compile src/namecard/infrastructure/storage/notion_client.py
        echo "âœ… æ ¸å¿ƒæ¨¡çµ„èªæ³•æª¢æŸ¥é€šé"
        
    - name: æª¢æŸ¥å¿…è¦æ–‡ä»¶
      run: |
        echo "ğŸ“‹ æª¢æŸ¥éƒ¨ç½²å¿…è¦æ–‡ä»¶..."
        
        # æª¢æŸ¥å¿…è¦æ–‡ä»¶
        files=("main.py" "src/namecard/api/telegram_bot/telegram_main.py" "deployment/environments/production/requirements-telegram.txt" "config/base.py")
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        
        # æª¢æŸ¥ requirements-telegram.txt å…§å®¹
        echo "ğŸ“¦ æª¢æŸ¥ Python ä¾è³´:"
        cat deployment/environments/production/requirements-telegram.txt
        
        echo "âœ… éƒ¨ç½²æª¢æŸ¥å®Œæˆ"

  # éƒ¨ç½²åˆ° Zeabur
  deploy-to-zeabur:
    runs-on: ubuntu-latest
    needs: pre-deploy-checks
    if: always() && (needs.pre-deploy-checks.result == 'success' || needs.pre-deploy-checks.result == 'skipped' || github.event_name == 'push')
    
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: ${{ steps.deploy.outputs.app_url }}
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Zeabur å¯èƒ½éœ€è¦å®Œæ•´çš„ Git æ­·å²
        
    - name: æª¢æŸ¥ Zeabur Token
      run: |
        if [ -z "$ZEABUR_TOKEN" ]; then
          echo "âŒ ZEABUR_TOKEN æœªè¨­ç½®"
          echo "è«‹åœ¨ GitHub Secrets ä¸­è¨­ç½® ZEABUR_TOKEN"
          echo "ç²å–æ–¹å¼: https://dash.zeabur.com/account/developer"
          exit 1
        else
          echo "âœ… Zeabur Token å·²è¨­ç½®"
        fi
        
    - name: å®‰è£ Zeabur CLI
      run: |
        echo "ğŸ“¦ å®‰è£ Zeabur CLI..."
        
        # å‰µå»ºç›®éŒ„
        mkdir -p $HOME/.zeabur/bin
        
        # ä¸‹è¼‰ä¸¦å®‰è£ Zeabur CLI (ç›´æ¥ä¸‹è¼‰äºŒé€²åˆ¶æ–‡ä»¶)
        ZEABUR_VERSION="0.5.4"
        curl -sSL "https://github.com/zeabur/cli/releases/download/v${ZEABUR_VERSION}/zeabur_${ZEABUR_VERSION}_linux_amd64" -o $HOME/.zeabur/bin/zeabur
        chmod +x $HOME/.zeabur/bin/zeabur
        
        # æ·»åŠ åˆ° PATH
        echo "$HOME/.zeabur/bin" >> $GITHUB_PATH
        
        # é©—è­‰å®‰è£
        $HOME/.zeabur/bin/zeabur version
        
    - name: é…ç½® Zeabur èªè­‰
      run: |
        echo "ğŸ” é…ç½® Zeabur èªè­‰..."
        if $HOME/.zeabur/bin/zeabur auth login --token "$ZEABUR_TOKEN"; then
          echo "âœ… Zeabur èªè­‰æˆåŠŸ"
        else
          echo "âŒ Zeabur èªè­‰å¤±æ•—"
          exit 1
        fi
        
    - name: å‰µå»ºéƒ¨ç½²é…ç½®
      run: |
        echo "âš™ï¸ å‰µå»º Zeabur éƒ¨ç½²é…ç½®..."
        
        # å‰µå»º zeabur.json é…ç½®æ–‡ä»¶ (Telegram Bot)
        cat > zeabur.json << END_OF_CONFIG
        {
          "name": "namecard-telegram-bot",
          "type": "python",
          "buildCommand": "pip install -r deployment/environments/production/requirements-telegram.txt",
          "startCommand": "python main.py",
          "environment": {
            "PYTHON_VERSION": "3.9",
            "PORT": "5003",
            "FLASK_ENV": "production",
            "PYTHONUNBUFFERED": "1"
          },
          "regions": ["hkg"],
          "scaling": {
            "minInstances": 1,
            "maxInstances": 2
          }
        }
        END_OF_CONFIG
        
        echo "âœ… é…ç½®æ–‡ä»¶å·²å‰µå»º"
        cat zeabur.json
        
    - name: éƒ¨ç½²åˆ° Zeabur
      id: deploy
      run: |
        echo "ğŸš€ é–‹å§‹éƒ¨ç½²åˆ° Zeabur (æ›´æ–°ç¾æœ‰æœå‹™)..."
        
        # ä½¿ç”¨ç¾æœ‰çš„å°ˆæ¡ˆå’Œæœå‹™åç¨±
        PROJECT_NAME="namecard"
        SERVICE_NAME="namecard-app"
        
        echo "ğŸ“‹ ç›®æ¨™é…ç½®:"
        echo "- å°ˆæ¡ˆ: $PROJECT_NAME"
        echo "- æœå‹™: $SERVICE_NAME" 
        echo "- URL: https://namecard-app.zeabur.app"
        echo "- æ‡‰ç”¨é¡å‹: Telegram Bot (main.py)"
        
        # æª¢æŸ¥å°ˆæ¡ˆæ˜¯å¦å­˜åœ¨
        echo "ğŸ“‹ åˆ—å‡ºæ‰€æœ‰å°ˆæ¡ˆ:"
        $HOME/.zeabur/bin/zeabur project list
        
        if ! $HOME/.zeabur/bin/zeabur project list | grep -q "$PROJECT_NAME"; then
          echo "âŒ å°ˆæ¡ˆä¸å­˜åœ¨: $PROJECT_NAME"
          echo "è«‹ç¢ºèªå°ˆæ¡ˆåç¨±æˆ–æ‰‹å‹•å‰µå»ºå°ˆæ¡ˆ"
          exit 1
        else
          echo "âœ… å°ˆæ¡ˆå·²å­˜åœ¨: $PROJECT_NAME"
        fi
        
        # éƒ¨ç½²åˆ°ç¾æœ‰æœå‹™ (ä½¿ç”¨æ­£ç¢ºçš„ zeabur deploy å‘½ä»¤)
        echo "ğŸ”§ æ›´æ–°ç¾æœ‰æœå‹™åˆ° Telegram Bot..."
        echo "ğŸ“‹ ä½¿ç”¨ zeabur deploy å‘½ä»¤éƒ¨ç½²..."
        
        DEPLOY_OUTPUT=$($HOME/.zeabur/bin/zeabur deploy \
          --name="$SERVICE_NAME" \
          --create=false 2>&1)
        
        echo "$DEPLOY_OUTPUT"
        
        # æª¢æŸ¥éƒ¨ç½²æ˜¯å¦æˆåŠŸ
        if [ $? -eq 0 ]; then
          echo "âœ… éƒ¨ç½²å‘½ä»¤åŸ·è¡ŒæˆåŠŸ"
        else
          echo "âŒ éƒ¨ç½²å‘½ä»¤åŸ·è¡Œå¤±æ•—"
          exit 1
        fi
        
        # ä½¿ç”¨å·²çŸ¥çš„ URL
        APP_URL="https://namecard-app.zeabur.app"
        echo "âœ… éƒ¨ç½²å®Œæˆ!"
        echo "ğŸ”— æ‡‰ç”¨ URL: $APP_URL"
        echo "ğŸ“ æœå‹™å·²æ›´æ–°ç‚º Telegram Bot é…ç½®"
        echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
        
    - name: è¨­ç½®ç’°å¢ƒè®Šæ•¸
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        GOOGLE_API_KEY_FALLBACK: ${{ secrets.GOOGLE_API_KEY_FALLBACK }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "ğŸ”§ è¨­ç½® Zeabur ç’°å¢ƒè®Šæ•¸..."
        
        PROJECT_NAME="namecard"
        SERVICE_NAME="namecard-app"
        
        # è¨­ç½®æ‰€æœ‰å¿…è¦çš„ç’°å¢ƒè®Šæ•¸
        env_vars=(
          "TELEGRAM_BOT_TOKEN=$TELEGRAM_BOT_TOKEN"
          "GOOGLE_API_KEY=$GOOGLE_API_KEY"
          "GOOGLE_API_KEY_FALLBACK=$GOOGLE_API_KEY_FALLBACK"
          "NOTION_API_KEY=$NOTION_API_KEY"
          "NOTION_DATABASE_ID=$NOTION_DATABASE_ID"
          "PORT=5003"
          "FLASK_ENV=production"
          "PYTHONUNBUFFERED=1"
        )
        
        failed_vars=0
        for env_var in "${env_vars[@]}"; do
          key=$(echo "$env_var" | cut -d'=' -f1)
          value=$(echo "$env_var" | cut -d'=' -f2-)
          
          if [ -n "$value" ] && [ "$value" != "" ]; then
            echo "ğŸ”‘ è¨­ç½®ç’°å¢ƒè®Šæ•¸: $key"
            if $HOME/.zeabur/bin/zeabur variable create \
              --name="$SERVICE_NAME" \
              -k "$key=$value" \
              -y; then
              echo "âœ… $key è¨­ç½®æˆåŠŸ"
            else
              echo "âŒ è¨­ç½® $key å¤±æ•—"
              failed_vars=$((failed_vars + 1))
            fi
          else
            echo "âš ï¸ è·³éç©ºå€¼ç’°å¢ƒè®Šæ•¸: $key"
          fi
        done
        
        if [ $failed_vars -gt 0 ]; then
          echo "âŒ æœ‰ $failed_vars å€‹ç’°å¢ƒè®Šæ•¸è¨­ç½®å¤±æ•—"
          echo "âš ï¸ ç¹¼çºŒéƒ¨ç½²ï¼Œä½†å¯èƒ½æœƒæœ‰å•é¡Œ"
        fi
        
        echo "âœ… ç’°å¢ƒè®Šæ•¸è¨­ç½®å®Œæˆ"
        
    - name: å¥åº·æª¢æŸ¥
      if: steps.deploy.outputs.app_url != ''
      run: |
        echo "ğŸ¥ åŸ·è¡Œéƒ¨ç½²å¾Œå¥åº·æª¢æŸ¥..."
        
        APP_URL="${{ steps.deploy.outputs.app_url }}"
        
        # ç­‰å¾…æœå‹™å•Ÿå‹•
        echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹• (30ç§’)..."
        sleep 30
        
        # å˜—è©¦å¥åº·æª¢æŸ¥
        for i in {1..5}; do
          echo "ğŸ” å¥åº·æª¢æŸ¥å˜—è©¦ $i/5..."
          
          if curl -f -s "$APP_URL/health" > /dev/null; then
            echo "âœ… å¥åº·æª¢æŸ¥é€šé!"
            echo "ğŸ‰ æ‡‰ç”¨å·²æˆåŠŸéƒ¨ç½²ä¸¦é‹è¡Œ"
            
            # é¡¯ç¤ºæ‡‰ç”¨ä¿¡æ¯
            echo ""
            echo "ğŸ“± **éƒ¨ç½²å®Œæˆä¿¡æ¯:**"
            echo "- ğŸ”— æ‡‰ç”¨ URL: $APP_URL"
            echo "- ğŸ¥ å¥åº·æª¢æŸ¥: $APP_URL/health"
            echo "- ğŸ§ª æ¸¬è©¦ç«¯é»: $APP_URL/test"
            echo "- ğŸ“ Webhook URL: $APP_URL/telegram-webhook"
            
            exit 0
          fi
          
          echo "â³ ç­‰å¾… 10 ç§’å¾Œé‡è©¦..."
          sleep 10
        done
        
        echo "âš ï¸ å¥åº·æª¢æŸ¥å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿éƒ¨ç½²æµç¨‹"
        echo "è«‹æ‰‹å‹•æª¢æŸ¥æ‡‰ç”¨ç‹€æ…‹: $APP_URL"
        
    - name: æ›´æ–° Telegram Bot Webhook URL æé†’
      if: steps.deploy.outputs.app_url != ''
      run: |
        echo "ğŸ“¢ é‡è¦æé†’: è¨­ç½® Telegram Bot Webhook URL"
        echo ""
        echo "è«‹ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤è¨­ç½® Telegram Bot Webhook:"
        echo "ğŸ”— æ–°çš„ Webhook URL: ${{ steps.deploy.outputs.app_url }}/telegram-webhook"
        echo ""
        echo "æ­¥é©Ÿ:"
        echo "1. ä½¿ç”¨ curl æˆ– Postman åŸ·è¡Œä»¥ä¸‹è«‹æ±‚:"
        echo "POST https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook"
        echo "Body: {\"url\": \"${{ steps.deploy.outputs.app_url }}/telegram-webhook\"}"
        echo ""
        echo "2. æˆ–åœ¨ç€è¦½å™¨ä¸­è¨ªå•:"
        echo "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/setWebhook?url=${{ steps.deploy.outputs.app_url }}/telegram-webhook"
        echo ""
        echo "3. é©—è­‰ webhook è¨­ç½®:"
        echo "https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getWebhookInfo"

  # éƒ¨ç½²å¾Œæ¸¬è©¦
  post-deploy-tests:
    runs-on: ubuntu-latest
    needs: deploy-to-zeabur
    if: needs.deploy-to-zeabur.outputs.app_url != ''
    
    steps:
    - name: éƒ¨ç½²å¾Œç«¯é»æ¸¬è©¦
      run: |
        echo "ğŸ§ª åŸ·è¡Œéƒ¨ç½²å¾Œæ¸¬è©¦..."
        
        APP_URL="${{ needs.deploy-to-zeabur.outputs.app_url }}"
        
        # æ¸¬è©¦å¥åº·ç«¯é»
        echo "ğŸ¥ æ¸¬è©¦å¥åº·æª¢æŸ¥ç«¯é»..."
        if curl -f -s "$APP_URL/health"; then
          echo "âœ… å¥åº·æª¢æŸ¥ç«¯é»æ­£å¸¸"
        else
          echo "âŒ å¥åº·æª¢æŸ¥ç«¯é»ç•°å¸¸"
        fi
        
        # æ¸¬è©¦ Telegram webhook ç«¯é»
        echo "ğŸ“ æ¸¬è©¦ Telegram webhook ç«¯é»..."
        if curl -f -s "$APP_URL/telegram-webhook"; then
          echo "âœ… Telegram webhook ç«¯é»å¯è¨ªå•"
        else
          echo "âŒ Telegram webhook ç«¯é»ä¸å¯è¨ªå• (å¯èƒ½éœ€è¦ POST è«‹æ±‚)"
        fi
        
        echo "âœ… éƒ¨ç½²å¾Œæ¸¬è©¦å®Œæˆ"

  # é€šçŸ¥éƒ¨ç½²çµæœ
  notify-deployment:
    runs-on: ubuntu-latest
    needs: [deploy-to-zeabur, post-deploy-tests]
    if: always()
    
    steps:
    - name: éƒ¨ç½²çµæœé€šçŸ¥
      run: |
        DEPLOY_STATUS="${{ needs.deploy-to-zeabur.result }}"
        TEST_STATUS="${{ needs.post-deploy-tests.result }}"
        APP_URL="${{ needs.deploy-to-zeabur.outputs.app_url }}"
        
        echo "ğŸ“Š **Zeabur éƒ¨ç½²çµæœå ±å‘Š**"
        echo ""
        
        if [ "$DEPLOY_STATUS" = "success" ]; then
          echo "ğŸ‰ **éƒ¨ç½²æˆåŠŸ!**"
          echo "âœ… æ‡‰ç”¨å·²æˆåŠŸéƒ¨ç½²åˆ° Zeabur"
          
          if [ -n "$APP_URL" ]; then
            echo "ğŸ”— **æ‡‰ç”¨ URL:** $APP_URL"
            echo "ğŸ“ **Webhook URL:** $APP_URL/telegram-webhook"
          fi
          
          echo ""
          echo "ğŸ“‹ **å¾ŒçºŒæ­¥é©Ÿ:**"
          echo "1. è¨­ç½® Telegram Bot Webhook URL"
          echo "2. æ¸¬è©¦ Telegram Bot åŠŸèƒ½"
          echo "3. æª¢æŸ¥æ‡‰ç”¨æ—¥èªŒ"
          
        else
          echo "âŒ **éƒ¨ç½²å¤±æ•—**"
          echo "è«‹æª¢æŸ¥éƒ¨ç½²æ—¥èªŒæ’æŸ¥å•é¡Œ"
        fi
        
        if [ "$TEST_STATUS" = "success" ]; then
          echo "âœ… éƒ¨ç½²å¾Œæ¸¬è©¦é€šé"
        elif [ "$TEST_STATUS" = "failure" ]; then
          echo "âš ï¸ éƒ¨ç½²å¾Œæ¸¬è©¦å¤±æ•—"
        fi
        
        echo ""
        echo "ğŸ”— **ç›¸é—œé€£çµ:**"
        echo "- [Zeabur Dashboard](https://dash.zeabur.com/)"
        echo "- [æŸ¥çœ‹éƒ¨ç½²æ—¥èªŒ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        echo "- [Telegram Bot API](https://core.telegram.org/bots/api)"