name: æ•´åˆæ¸¬è©¦ - Webhook & API é€£æ¥é©—è­‰

on:
  # æ¯æ—¥è‡ªå‹•æ¸¬è©¦ (UTC æ™‚é–“ 02:00ï¼Œå°ç£æ™‚é–“ 10:00)
  schedule:
    - cron: '0 2 * * *'
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      test_scope:
        description: 'é¸æ“‡æ¸¬è©¦ç¯„åœ'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - webhook
        - notion
        - gemini
        - basic
      
      webhook_url:
        description: 'æ¸¬è©¦ç”¨çš„ Webhook URL (å¯é¸)'
        required: false
        type: string

  # æ¯é€±å®Œæ•´æ¸¬è©¦ (é€±ä¸€)
  schedule:
    - cron: '0 1 * * 1'

env:
  PYTHON_VERSION: '3.9'

jobs:
  # åŸºæœ¬åŠŸèƒ½æ¸¬è©¦
  basic-tests:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'basic' || github.event_name == 'schedule'
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest requests
        
    - name: åŸºæœ¬æ¨¡çµ„å°å…¥æ¸¬è©¦
      run: |
        echo "ğŸ§ª æ¸¬è©¦åŸºæœ¬æ¨¡çµ„å°å…¥..."
        
        python -c "
        import sys
        import os
        print('Python ç‰ˆæœ¬:', sys.version)
        print('ç•¶å‰å·¥ä½œç›®éŒ„:', os.getcwd())
        
        # æ¸¬è©¦åŸºæœ¬æ¨¡çµ„
        try:
            import config
            print('âœ… config æ¨¡çµ„å°å…¥æˆåŠŸ')
        except Exception as e:
            print(f'âŒ config æ¨¡çµ„å°å…¥å¤±æ•—: {e}')
            # åœ¨ CI ç’°å¢ƒä¸­å¯èƒ½ç¼ºå°‘ç’°å¢ƒè®Šæ•¸ï¼Œé€™æ˜¯æ­£å¸¸çš„
            print('âš ï¸ é€™åœ¨ CI ç’°å¢ƒä¸­æ˜¯æ­£å¸¸çš„ï¼Œå› ç‚ºæ²’æœ‰è¨­ç½®å¯¦éš›çš„ API keys')
        
        try:
            from batch_manager import BatchManager
            batch_manager = BatchManager()
            print('âœ… BatchManager åˆå§‹åŒ–æˆåŠŸ')
        except Exception as e:
            print(f'âŒ BatchManager åˆå§‹åŒ–å¤±æ•—: {e}')
            sys.exit(1)
        
        print('âœ… åŸºæœ¬æ¨¡çµ„æ¸¬è©¦å®Œæˆ')
        "
        
    - name: é…ç½®é©—è­‰æ¸¬è©¦
      env:
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "ğŸ” æ¸¬è©¦é…ç½®é©—è­‰..."
        
        python -c "
        import os
        
        required_vars = [
            'LINE_CHANNEL_ACCESS_TOKEN',
            'LINE_CHANNEL_SECRET',
            'GOOGLE_API_KEY', 
            'NOTION_API_KEY',
            'NOTION_DATABASE_ID'
        ]
        
        missing_vars = []
        for var in required_vars:
            value = os.getenv(var)
            if not value:
                missing_vars.append(var)
            else:
                print(f'âœ… {var}: {"*" * min(10, len(value))}...')
        
        if missing_vars:
            print(f'âŒ ç¼ºå°‘ç’°å¢ƒè®Šæ•¸: {", ".join(missing_vars)}')
            print('è«‹åœ¨ GitHub Secrets ä¸­è¨­ç½®æ‰€æœ‰å¿…è¦çš„ API keys')
        else:
            print('âœ… æ‰€æœ‰å¿…è¦çš„ç’°å¢ƒè®Šæ•¸éƒ½å·²è¨­ç½®')
        "

  # Webhook æ¸¬è©¦
  webhook-tests:
    runs-on: ubuntu-latest
    needs: basic-tests
    if: github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'webhook' || github.event_name == 'schedule'
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest requests
        
    - name: å•Ÿå‹• Flask æ‡‰ç”¨ (å¾Œå°)
      env:
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
        LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "ğŸš€ å•Ÿå‹• Flask æ‡‰ç”¨é€²è¡Œæ¸¬è©¦..."
        
        # å¾Œå°å•Ÿå‹•æ‡‰ç”¨
        python app.py &
        APP_PID=$!
        echo "APP_PID=$APP_PID" >> $GITHUB_ENV
        
        # ç­‰å¾…æ‡‰ç”¨å•Ÿå‹•
        sleep 10
        
        # æª¢æŸ¥æ‡‰ç”¨æ˜¯å¦é‹è¡Œ
        if ps -p $APP_PID > /dev/null 2>&1; then
          echo "âœ… Flask æ‡‰ç”¨æˆåŠŸå•Ÿå‹• (PID: $APP_PID)"
        else
          echo "âŒ Flask æ‡‰ç”¨å•Ÿå‹•å¤±æ•—"
          exit 1
        fi
        
    - name: å¥åº·æª¢æŸ¥æ¸¬è©¦
      run: |
        echo "ğŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥æ¸¬è©¦..."
        
        # ç­‰å¾…æœå‹™å®Œå…¨å•Ÿå‹•
        sleep 5
        
        # æ¸¬è©¦å¥åº·æª¢æŸ¥ç«¯é»
        response=$(curl -s -w "%{http_code}" -o /tmp/health.json http://localhost:5002/health)
        
        if [ "$response" = "200" ]; then
          echo "âœ… å¥åº·æª¢æŸ¥ç«¯é»æ­£å¸¸"
          echo "å›æ‡‰å…§å®¹:"
          cat /tmp/health.json
        else
          echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•— (HTTP $response)"
          cat /tmp/health.json
          exit 1
        fi
        
    - name: æœå‹™æ¸¬è©¦ç«¯é»æª¢æŸ¥
      run: |
        echo "ğŸ”§ åŸ·è¡Œæœå‹™æ¸¬è©¦ç«¯é»æª¢æŸ¥..."
        
        # æ¸¬è©¦æœå‹™æ¸¬è©¦ç«¯é»
        response=$(curl -s -w "%{http_code}" -o /tmp/test.json http://localhost:5002/test)
        
        if [ "$response" = "200" ]; then
          echo "âœ… æœå‹™æ¸¬è©¦ç«¯é»æ­£å¸¸"
          echo "å›æ‡‰å…§å®¹:"
          cat /tmp/test.json | python -m json.tool
        else
          echo "âŒ æœå‹™æ¸¬è©¦ç«¯é»å¤±æ•— (HTTP $response)"
          cat /tmp/test.json
          # ä¸è¨­ç‚ºå¤±æ•—ï¼Œå› ç‚ºå¯èƒ½éœ€è¦æœ‰æ•ˆçš„ API keys
        fi
        
    - name: Callback ç«¯é»æ¸¬è©¦
      run: |
        echo "ğŸ“ åŸ·è¡Œ Callback ç«¯é»æ¸¬è©¦..."
        
        # æ¸¬è©¦ GET /callback
        response=$(curl -s -w "%{http_code}" -o /tmp/callback_get.json http://localhost:5002/callback)
        
        if [ "$response" = "200" ]; then
          echo "âœ… GET /callback ç«¯é»æ­£å¸¸"
          cat /tmp/callback_get.json
        else
          echo "âŒ GET /callback ç«¯é»å¤±æ•— (HTTP $response)"
          cat /tmp/callback_get.json
        fi
        
        # æ¸¬è©¦ POST /callback (æ²’æœ‰æœ‰æ•ˆç°½åï¼Œé æœŸå¤±æ•—)
        echo "ğŸ“¡ æ¸¬è©¦ POST /callback (é æœŸæœƒå› ç‚ºç°½åé©—è­‰å¤±æ•—)..."
        response=$(curl -s -w "%{http_code}" -X POST \
          -H "Content-Type: application/json" \
          -d '{"test": "data"}' \
          http://localhost:5002/callback)
        
        if [ "$response" = "400" ]; then
          echo "âœ… POST /callback æ­£ç¢ºæ‹’çµ•ç„¡æ•ˆè«‹æ±‚ (HTTP 400)"
        else
          echo "âš ï¸ POST /callback å›æ‡‰ç•°å¸¸ (HTTP $response)"
        fi
        
    - name: æ¸…ç†é€²ç¨‹
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†èƒŒæ™¯é€²ç¨‹..."
        if [ ! -z "$APP_PID" ]; then
          kill $APP_PID || true
          echo "âœ… Flask æ‡‰ç”¨å·²åœæ­¢"
        fi

  # Notion API é€£æ¥æ¸¬è©¦
  notion-tests:
    runs-on: ubuntu-latest
    needs: basic-tests
    if: github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'notion' || github.event_name == 'schedule'
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Notion é€£æ¥æ¸¬è©¦
      env:
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
      run: |
        echo "ğŸ“„ åŸ·è¡Œ Notion API é€£æ¥æ¸¬è©¦..."
        
        python -c "
        import os
        import sys
        
        # æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
        notion_key = os.getenv('NOTION_API_KEY')
        notion_db = os.getenv('NOTION_DATABASE_ID')
        
        if not notion_key or not notion_db:
            print('âš ï¸ Notion ç’°å¢ƒè®Šæ•¸æœªè¨­ç½®ï¼Œè·³éæ¸¬è©¦')
            sys.exit(0)
        
        try:
            from notion_manager import NotionManager
            
            # åˆå§‹åŒ– Notion ç®¡ç†å™¨
            notion_manager = NotionManager()
            print('âœ… NotionManager åˆå§‹åŒ–æˆåŠŸ')
            
            # æ¸¬è©¦é€£æ¥
            test_result = notion_manager.test_connection()
            
            if test_result.get('success'):
                print('âœ… Notion é€£æ¥æ¸¬è©¦æˆåŠŸ')
                print(f'è³‡æ–™åº«ä¿¡æ¯: {test_result.get("message", "N/A")}')
            else:
                print(f'âŒ Notion é€£æ¥æ¸¬è©¦å¤±æ•—: {test_result.get("error", "Unknown error")}')
                sys.exit(1)
                
        except Exception as e:
            print(f'âŒ Notion æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {e}')
            sys.exit(1)
        "

  # Google Gemini API æ¸¬è©¦
  gemini-tests:
    runs-on: ubuntu-latest
    needs: basic-tests
    if: github.event.inputs.test_scope == 'all' || github.event.inputs.test_scope == 'gemini' || github.event_name == 'schedule'
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Google Gemini API æ¸¬è©¦
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      run: |
        echo "ğŸ§  åŸ·è¡Œ Google Gemini API æ¸¬è©¦..."
        
        python -c "
        import os
        import sys
        
        # æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
        google_key = os.getenv('GOOGLE_API_KEY')
        
        if not google_key:
            print('âš ï¸ Google API key æœªè¨­ç½®ï¼Œè·³éæ¸¬è©¦')
            sys.exit(0)
        
        try:
            from name_card_processor import NameCardProcessor
            
            # åˆå§‹åŒ–è™•ç†å™¨
            processor = NameCardProcessor()
            print('âœ… NameCardProcessor åˆå§‹åŒ–æˆåŠŸ')
            
            # æ³¨æ„ï¼šé€™è£¡ä¸é€²è¡Œå¯¦éš›çš„ API èª¿ç”¨æ¸¬è©¦
            # å› ç‚ºéœ€è¦å¯¦éš›çš„åœ–ç‰‡æ•¸æ“šï¼Œä¸”æœƒæ¶ˆè€— API é…é¡
            print('âœ… Google Gemini API é…ç½®é©—è­‰é€šé')
            print('âš ï¸ å¯¦éš› API èª¿ç”¨æ¸¬è©¦éœ€è¦åœ–ç‰‡æ•¸æ“šï¼Œåœ¨æ­¤è·³é')
            
        except Exception as e:
            print(f'âŒ Google Gemini æ¸¬è©¦éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤: {e}')
            # ä¸è¨­ç‚ºå¤±æ•—ï¼Œå› ç‚ºå¯èƒ½æ˜¯ API é…é¡å•é¡Œ
            print('âš ï¸ æ¸¬è©¦å¤±æ•—ï¼Œä½†ä¸å½±éŸ¿æ•´é«”æµç¨‹')
        "

  # ç”Ÿæˆæ¸¬è©¦å ±å‘Š
  test-report:
    runs-on: ubuntu-latest
    needs: [basic-tests, webhook-tests, notion-tests, gemini-tests]
    if: always()
    
    steps:
    - name: ç”Ÿæˆæ¸¬è©¦å ±å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆæ•´åˆæ¸¬è©¦å ±å‘Š..."
        
        # æª¢æŸ¥å„å€‹æ¸¬è©¦å·¥ä½œçš„ç‹€æ…‹
        BASIC_STATUS="${{ needs.basic-tests.result }}"
        WEBHOOK_STATUS="${{ needs.webhook-tests.result }}"
        NOTION_STATUS="${{ needs.notion-tests.result }}"
        GEMINI_STATUS="${{ needs.gemini-tests.result }}"
        
        echo "## ğŸ§ª æ•´åˆæ¸¬è©¦å ±å‘Š"
        echo "**åŸ·è¡Œæ™‚é–“:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo ""
        
        echo "### æ¸¬è©¦çµæœæ‘˜è¦"
        echo "| æ¸¬è©¦é …ç›® | ç‹€æ…‹ | çµæœ |"
        echo "|---------|------|------|"
        
        # åŸºæœ¬æ¸¬è©¦
        case "$BASIC_STATUS" in
          "success") echo "| åŸºæœ¬åŠŸèƒ½æ¸¬è©¦ | âœ… | é€šé |" ;;
          "failure") echo "| åŸºæœ¬åŠŸèƒ½æ¸¬è©¦ | âŒ | å¤±æ•— |" ;;
          "skipped") echo "| åŸºæœ¬åŠŸèƒ½æ¸¬è©¦ | â­ï¸ | è·³é |" ;;
          *) echo "| åŸºæœ¬åŠŸèƒ½æ¸¬è©¦ | â“ | æœªçŸ¥ |" ;;
        esac
        
        # Webhook æ¸¬è©¦
        case "$WEBHOOK_STATUS" in
          "success") echo "| Webhook æ¸¬è©¦ | âœ… | é€šé |" ;;
          "failure") echo "| Webhook æ¸¬è©¦ | âŒ | å¤±æ•— |" ;;
          "skipped") echo "| Webhook æ¸¬è©¦ | â­ï¸ | è·³é |" ;;
          *) echo "| Webhook æ¸¬è©¦ | â“ | æœªçŸ¥ |" ;;
        esac
        
        # Notion æ¸¬è©¦
        case "$NOTION_STATUS" in
          "success") echo "| Notion API æ¸¬è©¦ | âœ… | é€šé |" ;;
          "failure") echo "| Notion API æ¸¬è©¦ | âŒ | å¤±æ•— |" ;;
          "skipped") echo "| Notion API æ¸¬è©¦ | â­ï¸ | è·³é |" ;;
          *) echo "| Notion API æ¸¬è©¦ | â“ | æœªçŸ¥ |" ;;
        esac
        
        # Gemini æ¸¬è©¦
        case "$GEMINI_STATUS" in
          "success") echo "| Gemini AI æ¸¬è©¦ | âœ… | é€šé |" ;;
          "failure") echo "| Gemini AI æ¸¬è©¦ | âŒ | å¤±æ•— |" ;;
          "skipped") echo "| Gemini AI æ¸¬è©¦ | â­ï¸ | è·³é |" ;;
          *) echo "| Gemini AI æ¸¬è©¦ | â“ | æœªçŸ¥ |" ;;
        esac
        
        echo ""
        echo "### ğŸ“‹ å»ºè­°äº‹é …"
        
        if [ "$BASIC_STATUS" != "success" ]; then
          echo "- âš ï¸ åŸºæœ¬åŠŸèƒ½æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä»£ç¢¼å’Œä¾è³´"
        fi
        
        if [ "$WEBHOOK_STATUS" != "success" ]; then
          echo "- âš ï¸ Webhook æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Flask æ‡‰ç”¨é…ç½®"
        fi
        
        if [ "$NOTION_STATUS" != "success" ]; then
          echo "- âš ï¸ Notion API æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key å’Œè³‡æ–™åº« ID"
        fi
        
        if [ "$GEMINI_STATUS" != "success" ]; then
          echo "- âš ï¸ Gemini AI æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Google API Key"
        fi
        
        echo ""
        echo "### ğŸ”— ç›¸é—œé€£çµ"
        echo "- [æŸ¥çœ‹å®Œæ•´æ—¥èªŒ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        echo "- [å°ˆæ¡ˆæ–‡æª”](./CLAUDE.md)"
        echo "- [GitHub Actions è¨­ç½®æŒ‡å—](./GITHUB_ACTIONS_SETUP.md)"
        
        # åˆ¤æ–·æ•´é«”çµæœ
        if [ "$BASIC_STATUS" = "success" ]; then
          echo ""
          echo "ğŸ‰ **æ•´åˆæ¸¬è©¦åŸºæœ¬å®Œæˆ**"
          exit 0
        else
          echo ""
          echo "âŒ **æ•´åˆæ¸¬è©¦å¤±æ•—**"
          exit 1
        fi