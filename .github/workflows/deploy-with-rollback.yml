name: ğŸ”„ æ™ºèƒ½éƒ¨ç½²èˆ‡è‡ªå‹•å›æ»¾

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: 'æœå‹™åç¨±'
        required: true
        default: 'namecard-telegram-bot'
        type: choice
        options:
        - namecard-telegram-bot
        - namecard-line-bot
      environment:
        description: 'ç›®æ¨™ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      enable_rollback:
        description: 'å•Ÿç”¨è‡ªå‹•å›æ»¾'
        required: false
        default: true
        type: boolean
      health_check_timeout:
        description: 'å¥åº·æª¢æŸ¥è¶…æ™‚ (ç§’)'
        required: false
        default: '300'
        type: string
      rollback_strategy:
        description: 'å›æ»¾ç­–ç•¥'
        required: false
        default: 'previous-version'
        type: choice
        options:
        - previous-version
        - stable-backup
        - manual-intervention

env:
  SERVICE_NAME: ${{ github.event.inputs.service_name }}
  ENVIRONMENT: ${{ github.event.inputs.environment }}
  HEALTH_CHECK_TIMEOUT: ${{ github.event.inputs.health_check_timeout }}
  ROLLBACK_STRATEGY: ${{ github.event.inputs.rollback_strategy }}

jobs:
  pre-deployment-backup:
    name: ğŸ“¦ é éƒ¨ç½²å‚™ä»½
    runs-on: ubuntu-latest
    
    outputs:
      backup_created: ${{ steps.backup.outputs.backup_created }}
      backup_url: ${{ steps.backup.outputs.backup_url }}
      backup_version: ${{ steps.backup.outputs.backup_version }}
      current_commit: ${{ steps.backup.outputs.current_commit }}
      
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ› ï¸ å®‰è£ Zeabur CLI
      run: |
        echo "ğŸ“¦ å®‰è£ Zeabur CLI..."
        npm install -g @zeabur/cli@latest
        zeabur --version
        
    - name: ğŸ” é…ç½® Zeabur èªè­‰
      run: |
        echo "ğŸ” é…ç½® Zeabur èªè­‰..."
        echo "${{ secrets.ZEABUR_TOKEN }}" | zeabur auth login --token
        
    - name: ğŸ“Š ç²å–ç•¶å‰éƒ¨ç½²ä¿¡æ¯
      id: current-info
      run: |
        echo "ğŸ“Š ç²å–ç•¶å‰éƒ¨ç½²ä¿¡æ¯..."
        
        # å˜—è©¦ç²å–ç•¶å‰æœå‹™ä¿¡æ¯
        if zeabur service info "${{ env.SERVICE_NAME }}" --format json > service_info.json 2>/dev/null; then
          echo "âœ… æ‰¾åˆ°ç¾æœ‰æœå‹™: ${{ env.SERVICE_NAME }}"
          
          # è§£ææœå‹™ä¿¡æ¯
          CURRENT_URL=$(jq -r '.url // empty' service_info.json)
          CURRENT_STATUS=$(jq -r '.status // empty' service_info.json)
          
          echo "current_url=$CURRENT_URL" >> $GITHUB_OUTPUT
          echo "current_status=$CURRENT_STATUS" >> $GITHUB_OUTPUT
          echo "service_exists=true" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ ç•¶å‰æœå‹™ç‹€æ…‹:"
          echo "- URL: $CURRENT_URL"
          echo "- ç‹€æ…‹: $CURRENT_STATUS"
        else
          echo "âš ï¸ æœå‹™ä¸å­˜åœ¨æˆ–ç„¡æ³•è¨ªå•: ${{ env.SERVICE_NAME }}"
          echo "service_exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ¥ ç•¶å‰æœå‹™å¥åº·æª¢æŸ¥
      id: current-health
      run: |
        if [ "${{ steps.current-info.outputs.service_exists }}" = "true" ]; then
          CURRENT_URL="${{ steps.current-info.outputs.current_url }}"
          
          if [ -n "$CURRENT_URL" ]; then
            echo "ğŸ¥ æª¢æŸ¥ç•¶å‰æœå‹™å¥åº·ç‹€æ…‹..."
            
            if curl -f -s "$CURRENT_URL/health" > /dev/null; then
              echo "âœ… ç•¶å‰æœå‹™å¥åº·æ­£å¸¸"
              echo "current_healthy=true" >> $GITHUB_OUTPUT
              
              # ç²å–å¥åº·æª¢æŸ¥éŸ¿æ‡‰è©³æƒ…
              HEALTH_RESPONSE=$(curl -s "$CURRENT_URL/health" | jq -r '.' 2>/dev/null || echo "ç„¡æ³•è§£æ")
              echo "å¥åº·æª¢æŸ¥éŸ¿æ‡‰: $HEALTH_RESPONSE"
            else
              echo "âŒ ç•¶å‰æœå‹™å¥åº·æª¢æŸ¥å¤±æ•—"
              echo "current_healthy=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ ç„¡æ³•ç²å–ç•¶å‰æœå‹™ URL"
            echo "current_healthy=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "â­ï¸ æ²’æœ‰ç¾æœ‰æœå‹™ï¼Œè·³éå¥åº·æª¢æŸ¥"
          echo "current_healthy=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ“¦ å‰µå»ºéƒ¨ç½²å‚™ä»½
      id: backup
      run: |
        echo "ğŸ“¦ å‰µå»ºéƒ¨ç½²å‚™ä»½..."
        
        CURRENT_COMMIT=$(git rev-parse HEAD)
        BACKUP_TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
        BACKUP_VERSION="backup-${BACKUP_TIMESTAMP}-${CURRENT_COMMIT:0:7}"
        
        echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
        echo "backup_version=$BACKUP_VERSION" >> $GITHUB_OUTPUT
        
        if [ "${{ steps.current-info.outputs.service_exists }}" = "true" ]; then
          echo "âœ… å‰µå»ºç•¶å‰éƒ¨ç½²çš„å‚™ä»½è¨˜éŒ„"
          
          # å‰µå»ºå‚™ä»½ä¿¡æ¯æ–‡ä»¶
          cat > deployment-backup.json << EOF
        {
          "backup_version": "$BACKUP_VERSION",
          "original_service": "${{ env.SERVICE_NAME }}",
          "original_url": "${{ steps.current-info.outputs.current_url }}",
          "original_status": "${{ steps.current-info.outputs.current_status }}",
          "healthy_before_deploy": "${{ steps.current-health.outputs.current_healthy }}",
          "commit_hash": "$CURRENT_COMMIT",
          "backup_timestamp": "$BACKUP_TIMESTAMP",
          "environment": "${{ env.ENVIRONMENT }}"
        }
        EOF
        
          echo "backup_created=true" >> $GITHUB_OUTPUT
          echo "backup_url=${{ steps.current-info.outputs.current_url }}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ å‚™ä»½ä¿¡æ¯:"
          cat deployment-backup.json
        else
          echo "âš ï¸ æ²’æœ‰ç¾æœ‰æœå‹™ï¼Œç„¡éœ€å‚™ä»½"
          echo "backup_created=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ“ å­˜å„²å‚™ä»½ä¿¡æ¯
      if: steps.backup.outputs.backup_created == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: deployment-backup-${{ steps.backup.outputs.backup_version }}
        path: |
          deployment-backup.json
          service_info.json
        retention-days: 30

  deploy-new-version:
    name: ğŸš€ éƒ¨ç½²æ–°ç‰ˆæœ¬
    runs-on: ubuntu-latest
    needs: pre-deployment-backup
    
    outputs:
      deployment_success: ${{ steps.deploy.outputs.deployment_success }}
      new_service_url: ${{ steps.deploy.outputs.new_service_url }}
      deployment_time: ${{ steps.deploy.outputs.deployment_time }}
      
    steps:
    - name: ğŸ”„ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: ğŸ è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        pip install --upgrade pip
        
        # æ ¹æ“šæœå‹™é¡å‹å®‰è£ä¾è³´
        if [[ "${{ env.SERVICE_NAME }}" == *"telegram"* ]]; then
          pip install -r requirements-telegram.txt
        else
          pip install -r requirements.txt
        fi
        
    - name: ğŸ” éƒ¨ç½²å‰æª¢æŸ¥
      run: |
        echo "ğŸ” åŸ·è¡Œéƒ¨ç½²å‰æª¢æŸ¥..."
        
        # èªæ³•æª¢æŸ¥
        if [[ "${{ env.SERVICE_NAME }}" == *"telegram"* ]]; then
          python -m py_compile main.py
          python -m py_compile telegram_app.py
        else
          python -m py_compile app.py
        fi
        
        python -m py_compile config.py
        echo "âœ… èªæ³•æª¢æŸ¥é€šé"
        
        # æª¢æŸ¥å¿…è¦æ–‡ä»¶
        if [[ "${{ env.SERVICE_NAME }}" == *"telegram"* ]]; then
          required_files=("main.py" "telegram_app.py" "requirements-telegram.txt")
        else
          required_files=("app.py" "requirements.txt")
        fi
        
        for file in "${required_files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
          else
            echo "âŒ $file ç¼ºå¤±"
            exit 1
          fi
        done
        
    - name: ğŸ› ï¸ å®‰è£ Zeabur CLI
      run: |
        echo "ğŸ“¦ å®‰è£ Zeabur CLI..."
        npm install -g @zeabur/cli@latest
        zeabur --version
        
    - name: ğŸ” é…ç½® Zeabur èªè­‰
      run: |
        echo "ğŸ” é…ç½® Zeabur èªè­‰..."
        echo "${{ secrets.ZEABUR_TOKEN }}" | zeabur auth login --token
        
    - name: ğŸ“ å‰µå»ºéƒ¨ç½²é…ç½®
      run: |
        echo "ğŸ“ å‰µå»ºéƒ¨ç½²é…ç½®..."
        
        # æ ¹æ“šæœå‹™é¡å‹å‰µå»ºé…ç½®
        if [[ "${{ env.SERVICE_NAME }}" == *"telegram"* ]]; then
          cat > zeabur.json << EOF
        {
          "name": "${{ env.SERVICE_NAME }}",
          "build": {
            "command": "pip install -r requirements-telegram.txt"
          },
          "start": {
            "command": "python main.py"
          },
          "environment": {
            "PORT": "5003",
            "PYTHON_VERSION": "3.9",
            "FLASK_ENV": "${{ env.ENVIRONMENT }}",
            "PYTHONUNBUFFERED": "1",
            "SERVICE_TYPE": "telegram-bot"
          },
          "region": "hkg",
          "restart": "always"
        }
        EOF
        else
          cat > zeabur.json << EOF
        {
          "name": "${{ env.SERVICE_NAME }}",
          "build": {
            "command": "pip install -r requirements.txt"
          },
          "start": {
            "command": "python app.py"
          },
          "environment": {
            "PORT": "5002",
            "PYTHON_VERSION": "3.9",
            "FLASK_ENV": "${{ env.ENVIRONMENT }}",
            "PYTHONUNBUFFERED": "1",
            "SERVICE_TYPE": "line-bot"
          },
          "region": "hkg",
          "restart": "always"
        }
        EOF
        fi
        
        echo "âœ… éƒ¨ç½²é…ç½®å·²å‰µå»º"
        cat zeabur.json
        
    - name: ğŸš€ åŸ·è¡Œéƒ¨ç½²
      id: deploy
      run: |
        echo "ğŸš€ é–‹å§‹éƒ¨ç½²æ–°ç‰ˆæœ¬..."
        
        DEPLOY_START_TIME=$(date -u +%s)
        
        # åŸ·è¡Œéƒ¨ç½²
        if zeabur deploy --name="${{ env.SERVICE_NAME }}" --timeout=600; then
          DEPLOY_END_TIME=$(date -u +%s)
          DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))
          
          echo "deployment_success=true" >> $GITHUB_OUTPUT
          echo "deployment_time=${DEPLOY_DURATION}s" >> $GITHUB_OUTPUT
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼Œè€—æ™‚: ${DEPLOY_DURATION}ç§’"
          
          # ç²å–æ–°çš„æœå‹™ URL
          NEW_SERVICE_URL="https://${{ env.SERVICE_NAME }}.zeabur.app"
          echo "new_service_url=$NEW_SERVICE_URL" >> $GITHUB_OUTPUT
          echo "ğŸŒ æ–°æœå‹™ URL: $NEW_SERVICE_URL"
        else
          echo "deployment_success=false" >> $GITHUB_OUTPUT
          echo "âŒ éƒ¨ç½²å¤±æ•—"
          exit 1
        fi
        
    - name: ğŸ”§ è¨­ç½®ç’°å¢ƒè®Šæ•¸
      run: |
        echo "ğŸ”§ è¨­ç½®ç’°å¢ƒè®Šæ•¸..."
        
        # æ ¹æ“šæœå‹™é¡å‹è¨­ç½®ä¸åŒçš„ç’°å¢ƒè®Šæ•¸
        if [[ "${{ env.SERVICE_NAME }}" == *"telegram"* ]]; then
          env_vars=(
            "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}"
            "PORT=5003"
          )
        else
          env_vars=(
            "LINE_CHANNEL_ACCESS_TOKEN=${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}"
            "LINE_CHANNEL_SECRET=${{ secrets.LINE_CHANNEL_SECRET }}"
            "PORT=5002"
          )
        fi
        
        # å…±ç”¨ç’°å¢ƒè®Šæ•¸
        env_vars+=(
          "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}"
          "GOOGLE_API_KEY_FALLBACK=${{ secrets.GOOGLE_API_KEY_FALLBACK }}"
          "NOTION_API_KEY=${{ secrets.NOTION_API_KEY }}"
          "NOTION_DATABASE_ID=${{ secrets.NOTION_DATABASE_ID }}"
          "FLASK_ENV=${{ env.ENVIRONMENT }}"
          "PYTHONUNBUFFERED=1"
        )
        
        # è¨­ç½®ç’°å¢ƒè®Šæ•¸
        for env_var in "${env_vars[@]}"; do
          key=$(echo "$env_var" | cut -d'=' -f1)
          value=$(echo "$env_var" | cut -d'=' -f2-)
          
          if [ -n "$value" ] && [ "$value" != "" ]; then
            if zeabur variable create --name="${{ env.SERVICE_NAME }}" -k "$key=$value" -y; then
              echo "âœ… $key è¨­ç½®æˆåŠŸ"
            else
              echo "âš ï¸ $key è¨­ç½®å¤±æ•—"
            fi
          fi
        done

  health-check-and-validation:
    name: ğŸ¥ å¥åº·æª¢æŸ¥èˆ‡é©—è­‰
    runs-on: ubuntu-latest
    needs: [pre-deployment-backup, deploy-new-version]
    if: needs.deploy-new-version.outputs.deployment_success == 'true'
    
    outputs:
      health_check_passed: ${{ steps.health-check.outputs.health_check_passed }}
      validation_passed: ${{ steps.validation.outputs.validation_passed }}
      should_rollback: ${{ steps.decision.outputs.should_rollback }}
      
    steps:
    - name: ğŸ¥ åŸ·è¡Œå¥åº·æª¢æŸ¥
      id: health-check
      run: |
        echo "ğŸ¥ åŸ·è¡Œæ–°ç‰ˆæœ¬å¥åº·æª¢æŸ¥..."
        
        NEW_SERVICE_URL="${{ needs.deploy-new-version.outputs.new_service_url }}"
        TIMEOUT_SECONDS="${{ env.HEALTH_CHECK_TIMEOUT }}"
        
        echo "ğŸŒ æª¢æŸ¥æœå‹™: $NEW_SERVICE_URL"
        echo "â±ï¸ è¶…æ™‚è¨­ç½®: ${TIMEOUT_SECONDS}ç§’"
        
        # ç­‰å¾…æœå‹™å•Ÿå‹•
        echo "â³ ç­‰å¾…æœå‹™å•Ÿå‹• (60ç§’)..."
        sleep 60
        
        # å¥åº·æª¢æŸ¥å¾ªç’°
        health_passed=false
        start_time=$(date +%s)
        
        while true; do
          current_time=$(date +%s)
          elapsed_time=$((current_time - start_time))
          
          if [ $elapsed_time -ge $TIMEOUT_SECONDS ]; then
            echo "â° å¥åº·æª¢æŸ¥è¶…æ™‚ (${TIMEOUT_SECONDS}ç§’)"
            break
          fi
          
          echo "ğŸ” å¥åº·æª¢æŸ¥å˜—è©¦ (å·²é‹è¡Œ: ${elapsed_time}ç§’/${TIMEOUT_SECONDS}ç§’)..."
          
          if curl -f -s "$NEW_SERVICE_URL/health" > /dev/null; then
            echo "âœ… å¥åº·æª¢æŸ¥é€šé"
            health_passed=true
            break
          fi
          
          echo "â³ ç­‰å¾… 15 ç§’å¾Œé‡è©¦..."
          sleep 15
        done
        
        echo "health_check_passed=$health_passed" >> $GITHUB_OUTPUT
        
        if [ "$health_passed" = "false" ]; then
          echo "âŒ å¥åº·æª¢æŸ¥æœ€çµ‚å¤±æ•—"
        fi
        
    - name: ğŸ§ª åŠŸèƒ½é©—è­‰æ¸¬è©¦
      id: validation
      if: steps.health-check.outputs.health_check_passed == 'true'
      run: |
        echo "ğŸ§ª åŸ·è¡ŒåŠŸèƒ½é©—è­‰æ¸¬è©¦..."
        
        NEW_SERVICE_URL="${{ needs.deploy-new-version.outputs.new_service_url }}"
        validation_passed=true
        
        # æ¸¬è©¦åŸºæœ¬ç«¯é»
        echo "ğŸ” æ¸¬è©¦åŸºæœ¬ç«¯é»..."
        
        # å¥åº·æª¢æŸ¥ç«¯é»
        if curl -f -s "$NEW_SERVICE_URL/health" > /dev/null; then
          echo "âœ… /health ç«¯é»æ­£å¸¸"
        else
          echo "âŒ /health ç«¯é»å¤±æ•—"
          validation_passed=false
        fi
        
        # æ¸¬è©¦ç«¯é»
        if curl -f -s "$NEW_SERVICE_URL/test" > /dev/null; then
          echo "âœ… /test ç«¯é»æ­£å¸¸"
        else
          echo "âŒ /test ç«¯é»å¤±æ•—"
          validation_passed=false
        fi
        
        # æ ¹æ“šæœå‹™é¡å‹æ¸¬è©¦ç‰¹å®šç«¯é»
        if [[ "${{ env.SERVICE_NAME }}" == *"telegram"* ]]; then
          # Telegram webhook ç«¯é»
          if curl -f -s "$NEW_SERVICE_URL/telegram-webhook" > /dev/null 2>&1; then
            echo "âœ… /telegram-webhook ç«¯é»å¯è¨ªå•"
          else
            echo "âš ï¸ /telegram-webhook ç«¯é»æ¸¬è©¦å¤±æ•— (å¯èƒ½éœ€è¦ POST)"
          fi
        else
          # LINE callback ç«¯é»
          if curl -f -s "$NEW_SERVICE_URL/callback" > /dev/null 2>&1; then
            echo "âœ… /callback ç«¯é»å¯è¨ªå•"
          else
            echo "âš ï¸ /callback ç«¯é»æ¸¬è©¦å¤±æ•— (å¯èƒ½éœ€è¦ POST)"
          fi
        fi
        
        # æ¸¬è©¦ API éŸ¿æ‡‰æ ¼å¼
        echo "ğŸ” æ¸¬è©¦ API éŸ¿æ‡‰æ ¼å¼..."
        health_response=$(curl -s "$NEW_SERVICE_URL/health")
        
        if echo "$health_response" | jq . > /dev/null 2>&1; then
          echo "âœ… API éŸ¿æ‡‰æ ¼å¼æ­£ç¢º (JSON)"
        else
          echo "âš ï¸ API éŸ¿æ‡‰æ ¼å¼ç•°å¸¸"
          echo "éŸ¿æ‡‰å…§å®¹: $health_response"
        fi
        
        echo "validation_passed=$validation_passed" >> $GITHUB_OUTPUT
        
        if [ "$validation_passed" = "true" ]; then
          echo "âœ… åŠŸèƒ½é©—è­‰æ¸¬è©¦é€šé"
        else
          echo "âŒ åŠŸèƒ½é©—è­‰æ¸¬è©¦å¤±æ•—"
        fi
        
    - name: ğŸ¯ å›æ»¾æ±ºç­–
      id: decision
      run: |
        echo "ğŸ¯ åˆ†ææ˜¯å¦éœ€è¦å›æ»¾..."
        
        health_passed="${{ steps.health-check.outputs.health_check_passed }}"
        validation_passed="${{ steps.validation.outputs.validation_passed }}"
        enable_rollback="${{ github.event.inputs.enable_rollback }}"
        backup_exists="${{ needs.pre-deployment-backup.outputs.backup_created }}"
        
        should_rollback=false
        
        echo "ğŸ“‹ æ±ºç­–åƒæ•¸:"
        echo "- å¥åº·æª¢æŸ¥: $health_passed"
        echo "- åŠŸèƒ½é©—è­‰: $validation_passed"
        echo "- å•Ÿç”¨å›æ»¾: $enable_rollback"
        echo "- å‚™ä»½å­˜åœ¨: $backup_exists"
        
        if [ "$enable_rollback" = "true" ] && [ "$backup_exists" = "true" ]; then
          if [ "$health_passed" = "false" ] || [ "$validation_passed" = "false" ]; then
            should_rollback=true
            echo "âŒ éƒ¨ç½²é©—è­‰å¤±æ•—ï¼Œå»ºè­°å›æ»¾"
          else
            echo "âœ… éƒ¨ç½²é©—è­‰é€šéï¼Œç„¡éœ€å›æ»¾"
          fi
        else
          echo "â­ï¸ å›æ»¾æœªå•Ÿç”¨æˆ–ç„¡å‚™ä»½ï¼Œç¹¼çºŒä½¿ç”¨æ–°ç‰ˆæœ¬"
        fi
        
        echo "should_rollback=$should_rollback" >> $GITHUB_OUTPUT

  rollback-if-needed:
    name: ğŸ”„ è‡ªå‹•å›æ»¾
    runs-on: ubuntu-latest
    needs: [pre-deployment-backup, deploy-new-version, health-check-and-validation]
    if: needs.health-check-and-validation.outputs.should_rollback == 'true'
    
    steps:
    - name: ğŸ“¥ ä¸‹è¼‰å‚™ä»½ä¿¡æ¯
      uses: actions/download-artifact@v3
      with:
        name: deployment-backup-${{ needs.pre-deployment-backup.outputs.backup_version }}
        
    - name: ğŸ› ï¸ å®‰è£ Zeabur CLI
      run: |
        echo "ğŸ“¦ å®‰è£ Zeabur CLI..."
        npm install -g @zeabur/cli@latest
        zeabur --version
        
    - name: ğŸ” é…ç½® Zeabur èªè­‰
      run: |
        echo "ğŸ” é…ç½® Zeabur èªè­‰..."
        echo "${{ secrets.ZEABUR_TOKEN }}" | zeabur auth login --token
        
    - name: ğŸ“Š åˆ†æå›æ»¾é¸é …
      id: rollback-analysis
      run: |
        echo "ğŸ“Š åˆ†æå›æ»¾é¸é …..."
        
        if [ -f "deployment-backup.json" ]; then
          echo "ğŸ“‹ å‚™ä»½ä¿¡æ¯:"
          cat deployment-backup.json
          
          BACKUP_HEALTHY=$(jq -r '.healthy_before_deploy' deployment-backup.json)
          ORIGINAL_URL=$(jq -r '.original_url' deployment-backup.json)
          
          echo "backup_healthy=$BACKUP_HEALTHY" >> $GITHUB_OUTPUT
          echo "original_url=$ORIGINAL_URL" >> $GITHUB_OUTPUT
          
          if [ "$BACKUP_HEALTHY" = "true" ]; then
            echo "âœ… å‚™ä»½ç‰ˆæœ¬ä¹‹å‰æ˜¯å¥åº·çš„ï¼Œå¯ä»¥å®‰å…¨å›æ»¾"
            echo "can_rollback=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ å‚™ä»½ç‰ˆæœ¬ä¹‹å‰å°±ä¸å¥åº·ï¼Œå›æ»¾å¯èƒ½ç„¡æ•ˆ"
            echo "can_rollback=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ æ‰¾ä¸åˆ°å‚™ä»½ä¿¡æ¯"
          echo "can_rollback=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ”„ åŸ·è¡Œå›æ»¾
      if: steps.rollback-analysis.outputs.can_rollback == 'true'
      run: |
        echo "ğŸ”„ åŸ·è¡Œè‡ªå‹•å›æ»¾..."
        
        case "${{ env.ROLLBACK_STRATEGY }}" in
          "previous-version")
            echo "ğŸ“‹ å›æ»¾åˆ°å‰ä¸€ç‰ˆæœ¬..."
            
            # é€™è£¡éœ€è¦å¯¦éš›çš„å›æ»¾é‚è¼¯
            # ç”±æ–¼ Zeabur çš„é™åˆ¶ï¼Œæˆ‘å€‘å¯èƒ½éœ€è¦ï¼š
            # 1. é‡æ–°éƒ¨ç½²èˆŠç‰ˆæœ¬ä»£ç¢¼
            # 2. æˆ–è€…ä½¿ç”¨æœå‹™å›æ»¾åŠŸèƒ½ (å¦‚æœæ”¯æŒ)
            
            echo "âš ï¸ è‡ªå‹•å›æ»¾åŠŸèƒ½éœ€è¦é€²ä¸€æ­¥å¯¦ç¾"
            echo "è«‹æ‰‹å‹•å‰å¾€ Zeabur Dashboard åŸ·è¡Œå›æ»¾"
            ;;
            
          "stable-backup")
            echo "ğŸ“‹ å›æ»¾åˆ°ç©©å®šå‚™ä»½ç‰ˆæœ¬..."
            echo "âš ï¸ ç©©å®šå‚™ä»½å›æ»¾åŠŸèƒ½éœ€è¦é€²ä¸€æ­¥å¯¦ç¾"
            ;;
            
          "manual-intervention")
            echo "ğŸ“‹ éœ€è¦æ‰‹å‹•å¹²é ..."
            echo "éƒ¨ç½²å¤±æ•—ï¼Œç­‰å¾…æ‰‹å‹•è™•ç†"
            exit 1
            ;;
        esac
        
    - name: ğŸ¥ å›æ»¾å¾Œé©—è­‰
      if: steps.rollback-analysis.outputs.can_rollback == 'true'
      run: |
        echo "ğŸ¥ é©—è­‰å›æ»¾æ•ˆæœ..."
        
        ORIGINAL_URL="${{ steps.rollback-analysis.outputs.original_url }}"
        
        if [ -n "$ORIGINAL_URL" ]; then
          # ç­‰å¾…å›æ»¾ç”Ÿæ•ˆ
          echo "â³ ç­‰å¾…å›æ»¾ç”Ÿæ•ˆ..."
          sleep 30
          
          # é©—è­‰åŸå§‹æœå‹™æ˜¯å¦æ¢å¾©
          for i in {1..5}; do
            if curl -f -s "$ORIGINAL_URL/health" > /dev/null; then
              echo "âœ… å›æ»¾æˆåŠŸï¼Œæœå‹™æ¢å¾©æ­£å¸¸"
              break
            fi
            
            if [ $i -eq 5 ]; then
              echo "âŒ å›æ»¾å¾Œæœå‹™ä»ç„¶ç•°å¸¸"
            fi
            
            echo "â³ ç­‰å¾… 10 ç§’å¾Œé‡è©¦..."
            sleep 10
          done
        else
          echo "âš ï¸ ç„¡æ³•é©—è­‰å›æ»¾æ•ˆæœï¼šç¼ºå°‘åŸå§‹ URL"
        fi

  cleanup-and-notify:
    name: ğŸ§¹ æ¸…ç†å’Œé€šçŸ¥
    runs-on: ubuntu-latest
    needs: [pre-deployment-backup, deploy-new-version, health-check-and-validation, rollback-if-needed]
    if: always()
    
    steps:
    - name: ğŸ“Š ç”Ÿæˆæœ€çµ‚å ±å‘Š
      run: |
        echo "ğŸ“Š **æ™ºèƒ½éƒ¨ç½²èˆ‡å›æ»¾æµç¨‹å®Œæˆå ±å‘Š**"
        echo ""
        
        BACKUP_STATUS="${{ needs.pre-deployment-backup.result }}"
        DEPLOY_STATUS="${{ needs.deploy-new-version.result }}"
        HEALTH_STATUS="${{ needs.health-check-and-validation.result }}"
        ROLLBACK_STATUS="${{ needs.rollback-if-needed.result }}"
        
        echo "ğŸ¯ **éƒ¨ç½²ç›®æ¨™:**"
        echo "- æœå‹™åç¨±: ${{ env.SERVICE_NAME }}"
        echo "- ç›®æ¨™ç’°å¢ƒ: ${{ env.ENVIRONMENT }}"
        echo "- å›æ»¾ç­–ç•¥: ${{ env.ROLLBACK_STRATEGY }}"
        echo ""
        
        echo "ğŸ“‹ **åŸ·è¡Œçµæœ:**"
        
        if [ "$BACKUP_STATUS" = "success" ]; then
          echo "âœ… é éƒ¨ç½²å‚™ä»½: æˆåŠŸ"
          if [ "${{ needs.pre-deployment-backup.outputs.backup_created }}" = "true" ]; then
            echo "   ğŸ“¦ å‚™ä»½ç‰ˆæœ¬: ${{ needs.pre-deployment-backup.outputs.backup_version }}"
          fi
        else
          echo "âš ï¸ é éƒ¨ç½²å‚™ä»½: å¤±æ•—æˆ–è·³é"
        fi
        
        if [ "$DEPLOY_STATUS" = "success" ]; then
          echo "âœ… æ–°ç‰ˆæœ¬éƒ¨ç½²: æˆåŠŸ"
          echo "   ğŸŒ æœå‹™ URL: ${{ needs.deploy-new-version.outputs.new_service_url }}"
          echo "   â±ï¸ éƒ¨ç½²æ™‚é–“: ${{ needs.deploy-new-version.outputs.deployment_time }}"
        else
          echo "âŒ æ–°ç‰ˆæœ¬éƒ¨ç½²: å¤±æ•—"
        fi
        
        if [ "$HEALTH_STATUS" = "success" ]; then
          health_passed="${{ needs.health-check-and-validation.outputs.health_check_passed }}"
          validation_passed="${{ needs.health-check-and-validation.outputs.validation_passed }}"
          
          if [ "$health_passed" = "true" ] && [ "$validation_passed" = "true" ]; then
            echo "âœ… å¥åº·æª¢æŸ¥èˆ‡é©—è­‰: å…¨éƒ¨é€šé"
          else
            echo "âš ï¸ å¥åº·æª¢æŸ¥èˆ‡é©—è­‰: éƒ¨åˆ†å¤±æ•—"
            echo "   - å¥åº·æª¢æŸ¥: $health_passed"
            echo "   - åŠŸèƒ½é©—è­‰: $validation_passed"
          fi
        else
          echo "âŒ å¥åº·æª¢æŸ¥èˆ‡é©—è­‰: å¤±æ•—"
        fi
        
        if [ "${{ needs.health-check-and-validation.outputs.should_rollback }}" = "true" ]; then
          if [ "$ROLLBACK_STATUS" = "success" ]; then
            echo "âœ… è‡ªå‹•å›æ»¾: åŸ·è¡ŒæˆåŠŸ"
          elif [ "$ROLLBACK_STATUS" = "failure" ]; then
            echo "âŒ è‡ªå‹•å›æ»¾: åŸ·è¡Œå¤±æ•—"
          else
            echo "â­ï¸ è‡ªå‹•å›æ»¾: å·²è·³é"
          fi
        else
          echo "â­ï¸ è‡ªå‹•å›æ»¾: æœªè§¸ç™¼"
        fi
        
        echo ""
        echo "ğŸ¯ **æœ€çµ‚ç‹€æ…‹:**"
        
        if [ "$DEPLOY_STATUS" = "success" ] && [ "${{ needs.health-check-and-validation.outputs.health_check_passed }}" = "true" ] && [ "${{ needs.health-check-and-validation.outputs.validation_passed }}" = "true" ]; then
          echo "ğŸ‰ **éƒ¨ç½²æˆåŠŸï¼æ–°ç‰ˆæœ¬é‹è¡Œæ­£å¸¸**"
        elif [ "${{ needs.health-check-and-validation.outputs.should_rollback }}" = "true" ] && [ "$ROLLBACK_STATUS" = "success" ]; then
          echo "ğŸ”„ **å·²å›æ»¾åˆ°ç©©å®šç‰ˆæœ¬**"
        else
          echo "âš ï¸ **éƒ¨ç½²å­˜åœ¨å•é¡Œï¼Œéœ€è¦æ‰‹å‹•æª¢æŸ¥**"
        fi
        
        echo ""
        echo "ğŸ“‹ **å¾ŒçºŒæ­¥é©Ÿ:**"
        echo "1. æª¢æŸ¥æœå‹™ç‹€æ…‹å’Œæ—¥èªŒ"
        echo "2. é©—è­‰æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ"
        echo "3. æ›´æ–°ç›£æ§å’Œè­¦å ±è¨­ç½®"
        
        if [[ "${{ env.SERVICE_NAME }}" == *"telegram"* ]]; then
          echo "4. ç¢ºèª Telegram Bot Webhook è¨­ç½®"
        else
          echo "4. ç¢ºèª LINE Bot Webhook è¨­ç½®"
        fi
        
        echo ""
        echo "ğŸ”— **ç›¸é—œé€£çµ:**"
        echo "- [Zeabur Dashboard](https://dash.zeabur.com/)"
        echo "- [æŸ¥çœ‹éƒ¨ç½²æ—¥èªŒ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
        
        if [ "${{ needs.deploy-new-version.outputs.deployment_success }}" = "true" ]; then
          echo "- [æ–°ç‰ˆæœ¬æœå‹™](${{ needs.deploy-new-version.outputs.new_service_url }})"
        fi