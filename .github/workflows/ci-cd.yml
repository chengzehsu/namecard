name: åç‰‡ç®¡ç† LINE Bot CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [3.9, 3.10.x, 3.11]
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: å®‰è£ç³»çµ±ä¾è³´
      run: |
        sudo apt-get update
        sudo apt-get install -y libmagic1
        
    - name: å®‰è£ Python ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8 black isort
        
    - name: ä»£ç¢¼å“è³ªæª¢æŸ¥ - flake8
      run: |
        # æª¢æŸ¥ Python èªæ³•éŒ¯èª¤å’Œæœªå®šç¾©åç¨± (æ’é™¤è™›æ“¬ç’°å¢ƒå’Œä¸ç›¸é—œç›®éŒ„)
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=.venv,venv,env,.git,.github,__pycache__,.pytest_cache,.tox
        # æª¢æŸ¥ä»£ç¢¼è¤‡é›œåº¦å’Œé¢¨æ ¼
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=.venv,venv,env,.git,.github,__pycache__,.pytest_cache,.tox
        
    - name: ä»£ç¢¼æ ¼å¼æª¢æŸ¥ - black
      run: |
        black --check --diff . --exclude="\.venv|venv|env|__pycache__|\.git"
        
    - name: Import æ’åºæª¢æŸ¥ - isort
      run: |
        isort --check-only --diff . --skip-glob="*.venv/*" --skip-glob="*venv/*" --skip-glob="*env/*" --skip-glob="*__pycache__/*"
        
    - name: é‹è¡Œæ¸¬è©¦
      env:
        # æ¸¬è©¦ç’°å¢ƒè®Šæ•¸ (ä½¿ç”¨æ¨¡æ“¬å€¼)
        LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN || 'test_token' }}
        LINE_CHANNEL_SECRET: ${{ secrets.LINE_CHANNEL_SECRET || 'test_secret' }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY || 'test_key' }}
        NOTION_API_KEY: ${{ secrets.NOTION_API_KEY || 'test_notion_key' }}
        NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID || 'test_db_id' }}
      run: |
        # é‹è¡ŒåŸºæœ¬é…ç½®æ¸¬è©¦
        python -c "import config; print('âœ… Config module loads successfully')"
        
        # é‹è¡Œç¾æœ‰æ¸¬è©¦æ–‡ä»¶
        if [ -f "test_card.py" ]; then
          python test_card.py
        fi
        
        if [ -f "test_new_webhook.py" ]; then
          python test_new_webhook.py
        fi
        
        # æª¢æŸ¥ä¸»è¦æ¨¡çµ„æ˜¯å¦å¯ä»¥æ­£å¸¸å°å…¥
        python -c "
        try:
            from name_card_processor import NameCardProcessor
            print('âœ… NameCardProcessor æ¨¡çµ„æ­£å¸¸')
        except Exception as e:
            print(f'âš ï¸ NameCardProcessor éœ€è¦ API key: {e}')
            
        try:
            from notion_manager import NotionManager
            print('âœ… NotionManager æ¨¡çµ„æ­£å¸¸')
        except Exception as e:
            print(f'âš ï¸ NotionManager éœ€è¦ API key: {e}')
            
        from batch_manager import BatchManager
        print('âœ… BatchManager æ¨¡çµ„æ­£å¸¸')
        
        print('âœ… æ‰€æœ‰æ ¸å¿ƒæ¨¡çµ„æª¢æŸ¥å®Œæˆ')
        "
        
    - name: æ‡‰ç”¨å¥åº·æª¢æŸ¥
      env:
        LINE_CHANNEL_ACCESS_TOKEN: 'test_token'
        LINE_CHANNEL_SECRET: 'test_secret' 
        GOOGLE_API_KEY: 'test_key'
        NOTION_API_KEY: 'test_notion_key'
        NOTION_DATABASE_ID: 'test_db_id'
      run: |
        # æª¢æŸ¥ Flask æ‡‰ç”¨æ˜¯å¦å¯ä»¥å•Ÿå‹• (ä¸éœ€è¦å¯¦éš› API keys)
        timeout 10s python -c "
        import sys
        sys.path.append('.')
        try:
            from app import app
            print('âœ… Flask æ‡‰ç”¨å¯ä»¥æ­£å¸¸åˆå§‹åŒ–')
        except Exception as e:
            print(f'âš ï¸ Flask æ‡‰ç”¨åˆå§‹åŒ–éœ€è¦æœ‰æ•ˆçš„ API keys: {e}')
        " || echo "âœ… æ‡‰ç”¨æª¢æŸ¥å®Œæˆ (å¯èƒ½éœ€è¦ API keys)"

  security-scan:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: è¨­ç½® Python
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
        
    - name: å®‰è£å®‰å…¨æƒæå·¥å…·
      run: |
        pip install bandit safety
        
    - name: å®‰å…¨æ¼æ´æƒæ - bandit
      run: |
        bandit -r . -f txt || true
        
    - name: ä¾è³´å®‰å…¨æª¢æŸ¥ - safety
      run: |
        pip install -r requirements.txt
        safety check || true

  build-check:
    runs-on: ubuntu-latest
    needs: [test, security-scan]
    
    steps:
    - name: Checkout ä»£ç¢¼
      uses: actions/checkout@v4
      
    - name: æª¢æŸ¥éƒ¨ç½²æ–‡ä»¶
      run: |
        echo "ğŸ“‹ æª¢æŸ¥éƒ¨ç½²ç›¸é—œæ–‡ä»¶..."
        
        if [ -f "requirements.txt" ]; then
          echo "âœ… requirements.txt å­˜åœ¨"
          echo "ğŸ“¦ ä¾è³´å¥—ä»¶æ•¸é‡: $(wc -l < requirements.txt)"
        fi
        
        if [ -f "Procfile" ]; then
          echo "âœ… Procfile å­˜åœ¨ (Heroku éƒ¨ç½²)"
          cat Procfile
        fi
        
        if [ -f "railway_app.py" ]; then
          echo "âœ… railway_app.py å­˜åœ¨ (Railway éƒ¨ç½²)"
        fi
        
        if [ -f "deploy.sh" ]; then
          echo "âœ… deploy.sh å­˜åœ¨"
        fi
        
        echo "âœ… å»ºæ§‹æª¢æŸ¥å®Œæˆ"

  notify-success:
    runs-on: ubuntu-latest
    needs: [test, security-scan, build-check]
    if: success()
    
    steps:
    - name: æˆåŠŸé€šçŸ¥
      run: |
        echo "ğŸ‰ CI/CD Pipeline æˆåŠŸå®Œæˆï¼"
        echo "âœ… æ‰€æœ‰æ¸¬è©¦é€šé"
        echo "âœ… å®‰å…¨æƒæå®Œæˆ" 
        echo "âœ… å»ºæ§‹æª¢æŸ¥é€šé"
        echo "ğŸš€ æº–å‚™éƒ¨ç½²"