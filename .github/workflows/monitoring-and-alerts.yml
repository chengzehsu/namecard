name: ðŸ“Š éƒ¨ç½²ç›£æŽ§èˆ‡è­¦å ±ç³»çµ±

on:
  schedule:
    # æ¯ 5 åˆ†é˜åŸ·è¡Œä¸€æ¬¡å¥åº·æª¢æŸ¥
    - cron: '*/5 * * * *'
  workflow_dispatch:
    inputs:
      service_name:
        description: 'è¦ç›£æŽ§çš„æœå‹™'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - namecard-telegram-bot
        - namecard-line-bot
      check_type:
        description: 'æª¢æŸ¥é¡žåž‹'
        required: false
        default: 'comprehensive'
        type: choice
        options:
        - comprehensive
        - health-only
        - performance
        - api-status
      alert_threshold:
        description: 'è­¦å ±é–¾å€¼ (å¤±æ•—æ¬¡æ•¸)'
        required: false
        default: '3'
        type: string

env:
  SERVICE_TO_CHECK: ${{ github.event.inputs.service_name || 'all' }}
  CHECK_TYPE: ${{ github.event.inputs.check_type || 'comprehensive' }}
  ALERT_THRESHOLD: ${{ github.event.inputs.alert_threshold || '3' }}

jobs:
  service-discovery:
    name: ðŸ” æœå‹™ç™¼ç¾
    runs-on: ubuntu-latest
    
    outputs:
      services: ${{ steps.discover.outputs.services }}
      telegram_url: ${{ steps.discover.outputs.telegram_url }}
      line_url: ${{ steps.discover.outputs.line_url }}
      
    steps:
    - name: ðŸ› ï¸ å®‰è£ Zeabur CLI
      run: |
        echo "ðŸ“¦ å®‰è£ Zeabur CLI..."
        npm install -g @zeabur/cli@latest
        zeabur --version
        
    - name: ðŸ” é…ç½® Zeabur èªè­‰
      run: |
        echo "ðŸ” é…ç½® Zeabur èªè­‰..."
        echo "${{ secrets.ZEABUR_TOKEN }}" | zeabur auth login --token
        
    - name: ðŸ” ç™¼ç¾å¯ç”¨æœå‹™
      id: discover
      run: |
        echo "ðŸ” ç™¼ç¾ Zeabur ä¸Šçš„æœå‹™..."
        
        # ç²å–æœå‹™åˆ—è¡¨
        zeabur service list > services_list.txt || {
          echo "âš ï¸ ç„¡æ³•ç²å–æœå‹™åˆ—è¡¨ï¼Œä½¿ç”¨é è¨­é…ç½®"
          echo "services=[]" >> $GITHUB_OUTPUT
          exit 0
        }
        
        echo "ðŸ“‹ æœå‹™åˆ—è¡¨:"
        cat services_list.txt
        
        # è§£æžæœå‹™ URL
        telegram_url=""
        line_url=""
        services_array="["
        
        # æŸ¥æ‰¾ Telegram Bot æœå‹™
        if grep -q "namecard-telegram-bot" services_list.txt; then
          telegram_url="https://namecard-telegram-bot.zeabur.app"
          services_array="${services_array}\"telegram\","
          echo "âœ… æ‰¾åˆ° Telegram Bot æœå‹™: $telegram_url"
        fi
        
        # æŸ¥æ‰¾ LINE Bot æœå‹™
        if grep -q "namecard-line-bot" services_list.txt; then
          line_url="https://namecard-line-bot.zeabur.app"
          services_array="${services_array}\"line\","
          echo "âœ… æ‰¾åˆ° LINE Bot æœå‹™: $line_url"
        fi
        
        # æª¢æŸ¥ namecard-app (é€šç”¨æœå‹™)
        if grep -q "namecard-app" services_list.txt; then
          # æª¢æŸ¥ç•¶å‰é…ç½®
          app_url="https://namecard-app.zeabur.app"
          
          # ç°¡å–®æª¢æŸ¥æœå‹™é¡žåž‹
          if curl -s "$app_url/health" | grep -q "telegram" 2>/dev/null; then
            telegram_url="$app_url"
            services_array="${services_array}\"telegram\","
            echo "âœ… namecard-app é…ç½®ç‚º Telegram Bot: $app_url"
          elif curl -s "$app_url/health" | grep -q "line" 2>/dev/null; then
            line_url="$app_url"
            services_array="${services_array}\"line\","
            echo "âœ… namecard-app é…ç½®ç‚º LINE Bot: $app_url"
          else
            # å‡è¨­ç‚º Telegram Bot (ç•¶å‰é…ç½®)
            telegram_url="$app_url"
            services_array="${services_array}\"telegram\","
            echo "âœ… namecard-app å‡è¨­ç‚º Telegram Bot: $app_url"
          fi
        fi
        
        # å®Œæˆ JSON é™£åˆ—
        services_array="${services_array%,}]"
        
        echo "services=$services_array" >> $GITHUB_OUTPUT
        echo "telegram_url=$telegram_url" >> $GITHUB_OUTPUT
        echo "line_url=$line_url" >> $GITHUB_OUTPUT
        
        echo ""
        echo "ðŸ“Š ç™¼ç¾çš„æœå‹™:"
        echo "- Telegram Bot: $telegram_url"
        echo "- LINE Bot: $line_url"
        echo "- æœå‹™é™£åˆ—: $services_array"

  telegram-bot-monitoring:
    name: ðŸ“± Telegram Bot ç›£æŽ§
    runs-on: ubuntu-latest
    needs: service-discovery
    if: contains(needs.service-discovery.outputs.services, 'telegram') && (github.event.inputs.service_name == 'all' || github.event.inputs.service_name == 'namecard-telegram-bot')
    
    outputs:
      status: ${{ steps.monitor.outputs.status }}
      response_time: ${{ steps.monitor.outputs.response_time }}
      error_count: ${{ steps.monitor.outputs.error_count }}
      
    steps:
    - name: ðŸ“± ç›£æŽ§ Telegram Bot
      id: monitor
      run: |
        echo "ðŸ“± é–‹å§‹ç›£æŽ§ Telegram Bot..."
        
        TELEGRAM_URL="${{ needs.service-discovery.outputs.telegram_url }}"
        
        if [ -z "$TELEGRAM_URL" ]; then
          echo "âš ï¸ Telegram Bot URL æœªæ‰¾åˆ°"
          echo "status=unknown" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "ðŸŒ ç›£æŽ§æœå‹™: $TELEGRAM_URL"
        
        # å¥åº·æª¢æŸ¥
        health_status="unknown"
        response_time=0
        error_count=0
        
        start_time=$(date +%s%3N)
        
        if curl -f -s "$TELEGRAM_URL/health" > health_response.json; then
          end_time=$(date +%s%3N)
          response_time=$((end_time - start_time))
          health_status="healthy"
          
          echo "âœ… å¥åº·æª¢æŸ¥é€šéŽ"
          echo "â±ï¸ éŸ¿æ‡‰æ™‚é–“: ${response_time}ms"
          
          # è§£æžå¥åº·æª¢æŸ¥éŸ¿æ‡‰
          if [ -f "health_response.json" ]; then
            echo "ðŸ“‹ å¥åº·æª¢æŸ¥éŸ¿æ‡‰:"
            cat health_response.json
            
            # æª¢æŸ¥ç‰¹å®šæ¬„ä½
            if jq -e '.status' health_response.json >/dev/null 2>&1; then
              status_field=$(jq -r '.status' health_response.json)
              echo "ç‹€æ…‹æ¬„ä½: $status_field"
            fi
          fi
        else
          health_status="unhealthy"
          error_count=1
          echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—"
        fi
        
        # ç¶œåˆæª¢æŸ¥ (å¦‚æžœå•Ÿç”¨)
        if [ "${{ env.CHECK_TYPE }}" = "comprehensive" ]; then
          echo "ðŸ” åŸ·è¡Œç¶œåˆæª¢æŸ¥..."
          
          # æ¸¬è©¦ç«¯é»žæª¢æŸ¥
          if curl -f -s "$TELEGRAM_URL/test" > /dev/null; then
            echo "âœ… /test ç«¯é»žæ­£å¸¸"
          else
            echo "âš ï¸ /test ç«¯é»žç•°å¸¸"
            error_count=$((error_count + 1))
          fi
          
          # Webhook ç«¯é»žæª¢æŸ¥
          webhook_status=$(curl -s -o /dev/null -w "%{http_code}" "$TELEGRAM_URL/telegram-webhook")
          if [ "$webhook_status" = "405" ] || [ "$webhook_status" = "200" ]; then
            echo "âœ… /telegram-webhook ç«¯é»žå¯è¨ªå• (HTTP $webhook_status)"
          else
            echo "âš ï¸ /telegram-webhook ç«¯é»žç•°å¸¸ (HTTP $webhook_status)"
            error_count=$((error_count + 1))
          fi
        fi
        
        # æ•ˆèƒ½æª¢æŸ¥ (å¦‚æžœå•Ÿç”¨)
        if [ "${{ env.CHECK_TYPE }}" = "performance" ] || [ "${{ env.CHECK_TYPE }}" = "comprehensive" ]; then
          echo "ðŸ“Š åŸ·è¡Œæ•ˆèƒ½æª¢æŸ¥..."
          
          # å¤šæ¬¡è«‹æ±‚æ¸¬è©¦å¹³å‡éŸ¿æ‡‰æ™‚é–“
          total_time=0
          successful_requests=0
          
          for i in {1..5}; do
            start=$(date +%s%3N)
            if curl -f -s "$TELEGRAM_URL/health" > /dev/null; then
              end=$(date +%s%3N)
              req_time=$((end - start))
              total_time=$((total_time + req_time))
              successful_requests=$((successful_requests + 1))
            fi
          done
          
          if [ $successful_requests -gt 0 ]; then
            avg_response_time=$((total_time / successful_requests))
            echo "ðŸ“Š å¹³å‡éŸ¿æ‡‰æ™‚é–“: ${avg_response_time}ms (${successful_requests}/5 æˆåŠŸ)"
            
            # éŸ¿æ‡‰æ™‚é–“è­¦å ±
            if [ $avg_response_time -gt 3000 ]; then
              echo "âš ï¸ éŸ¿æ‡‰æ™‚é–“éŽæ…¢: ${avg_response_time}ms > 3000ms"
              error_count=$((error_count + 1))
            fi
          else
            echo "âŒ æ‰€æœ‰æ•ˆèƒ½æ¸¬è©¦è«‹æ±‚å¤±æ•—"
            error_count=$((error_count + 1))
          fi
        fi
        
        echo "status=$health_status" >> $GITHUB_OUTPUT
        echo "response_time=$response_time" >> $GITHUB_OUTPUT
        echo "error_count=$error_count" >> $GITHUB_OUTPUT
        
        echo ""
        echo "ðŸ“Š Telegram Bot ç›£æŽ§çµæžœ:"
        echo "- ç‹€æ…‹: $health_status"
        echo "- éŸ¿æ‡‰æ™‚é–“: ${response_time}ms"
        echo "- éŒ¯èª¤è¨ˆæ•¸: $error_count"

  line-bot-monitoring:
    name: ðŸ“ž LINE Bot ç›£æŽ§
    runs-on: ubuntu-latest
    needs: service-discovery
    if: contains(needs.service-discovery.outputs.services, 'line') && (github.event.inputs.service_name == 'all' || github.event.inputs.service_name == 'namecard-line-bot')
    
    outputs:
      status: ${{ steps.monitor.outputs.status }}
      response_time: ${{ steps.monitor.outputs.response_time }}
      error_count: ${{ steps.monitor.outputs.error_count }}
      
    steps:
    - name: ðŸ“ž ç›£æŽ§ LINE Bot
      id: monitor
      run: |
        echo "ðŸ“ž é–‹å§‹ç›£æŽ§ LINE Bot..."
        
        LINE_URL="${{ needs.service-discovery.outputs.line_url }}"
        
        if [ -z "$LINE_URL" ]; then
          echo "âš ï¸ LINE Bot URL æœªæ‰¾åˆ°"
          echo "status=unknown" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        echo "ðŸŒ ç›£æŽ§æœå‹™: $LINE_URL"
        
        # å¥åº·æª¢æŸ¥ (èˆ‡ Telegram Bot é¡žä¼¼çš„é‚è¼¯)
        health_status="unknown"
        response_time=0
        error_count=0
        
        start_time=$(date +%s%3N)
        
        if curl -f -s "$LINE_URL/health" > health_response.json; then
          end_time=$(date +%s%3N)
          response_time=$((end_time - start_time))
          health_status="healthy"
          
          echo "âœ… å¥åº·æª¢æŸ¥é€šéŽ"
          echo "â±ï¸ éŸ¿æ‡‰æ™‚é–“: ${response_time}ms"
        else
          health_status="unhealthy"
          error_count=1
          echo "âŒ å¥åº·æª¢æŸ¥å¤±æ•—"
        fi
        
        # ç¶œåˆæª¢æŸ¥
        if [ "${{ env.CHECK_TYPE }}" = "comprehensive" ]; then
          # æ¸¬è©¦ç«¯é»žæª¢æŸ¥
          if curl -f -s "$LINE_URL/test" > /dev/null; then
            echo "âœ… /test ç«¯é»žæ­£å¸¸"
          else
            echo "âš ï¸ /test ç«¯é»žç•°å¸¸"
            error_count=$((error_count + 1))
          fi
          
          # Callback ç«¯é»žæª¢æŸ¥
          callback_status=$(curl -s -o /dev/null -w "%{http_code}" "$LINE_URL/callback")
          if [ "$callback_status" = "405" ] || [ "$callback_status" = "200" ]; then
            echo "âœ… /callback ç«¯é»žå¯è¨ªå• (HTTP $callback_status)"
          else
            echo "âš ï¸ /callback ç«¯é»žç•°å¸¸ (HTTP $callback_status)"
            error_count=$((error_count + 1))
          fi
        fi
        
        echo "status=$health_status" >> $GITHUB_OUTPUT
        echo "response_time=$response_time" >> $GITHUB_OUTPUT
        echo "error_count=$error_count" >> $GITHUB_OUTPUT
        
        echo ""
        echo "ðŸ“Š LINE Bot ç›£æŽ§çµæžœ:"
        echo "- ç‹€æ…‹: $health_status"
        echo "- éŸ¿æ‡‰æ™‚é–“: ${response_time}ms"
        echo "- éŒ¯èª¤è¨ˆæ•¸: $error_count"

  api-status-monitoring:
    name: ðŸ”— API ç‹€æ…‹ç›£æŽ§
    runs-on: ubuntu-latest
    needs: [service-discovery, telegram-bot-monitoring, line-bot-monitoring]
    if: always() && (github.event.inputs.check_type == 'api-status' || github.event.inputs.check_type == 'comprehensive')
    
    outputs:
      google_api_status: ${{ steps.api-check.outputs.google_api_status }}
      notion_api_status: ${{ steps.api-check.outputs.notion_api_status }}
      
    steps:
    - name: ðŸ”— æª¢æŸ¥å¤–éƒ¨ API ç‹€æ…‹
      id: api-check
      run: |
        echo "ðŸ”— æª¢æŸ¥å¤–éƒ¨ API æœå‹™ç‹€æ…‹..."
        
        google_api_status="unknown"
        notion_api_status="unknown"
        
        # Google AI API ç‹€æ…‹æª¢æŸ¥
        echo "ðŸ¤– æª¢æŸ¥ Google AI API..."
        if curl -f -s "https://generativelanguage.googleapis.com/v1/models?key=test" > /dev/null 2>&1; then
          google_api_status="reachable"
          echo "âœ… Google AI API å¯é”"
        else
          # æª¢æŸ¥æ˜¯å¦ç‚º API key å•é¡Œ (æ­£å¸¸æƒ…æ³)
          response=$(curl -s "https://generativelanguage.googleapis.com/v1/models?key=invalid" 2>&1)
          if echo "$response" | grep -q "API_KEY_INVALID" 2>/dev/null; then
            google_api_status="reachable"
            echo "âœ… Google AI API å¯é” (API key é©—è­‰æ­£å¸¸)"
          else
            google_api_status="unreachable"
            echo "âŒ Google AI API ä¸å¯é”"
          fi
        fi
        
        # Notion API ç‹€æ…‹æª¢æŸ¥
        echo "ðŸ“ æª¢æŸ¥ Notion API..."
        if curl -f -s "https://api.notion.com/v1/users/me" -H "Authorization: Bearer invalid" > /dev/null 2>&1; then
          notion_api_status="reachable"
          echo "âœ… Notion API å¯é”"
        else
          response=$(curl -s "https://api.notion.com/v1/users/me" -H "Authorization: Bearer invalid" 2>&1)
          if echo "$response" | grep -q "unauthorized" 2>/dev/null; then
            notion_api_status="reachable"
            echo "âœ… Notion API å¯é” (èªè­‰é©—è­‰æ­£å¸¸)"
          else
            notion_api_status="unreachable"
            echo "âŒ Notion API ä¸å¯é”"
          fi
        fi
        
        echo "google_api_status=$google_api_status" >> $GITHUB_OUTPUT
        echo "notion_api_status=$notion_api_status" >> $GITHUB_OUTPUT
        
        echo ""
        echo "ðŸ“Š API ç‹€æ…‹ç›£æŽ§çµæžœ:"
        echo "- Google AI API: $google_api_status"
        echo "- Notion API: $notion_api_status"

  alert-evaluation:
    name: ðŸš¨ è­¦å ±è©•ä¼°
    runs-on: ubuntu-latest
    needs: [service-discovery, telegram-bot-monitoring, line-bot-monitoring, api-status-monitoring]
    if: always()
    
    outputs:
      should_alert: ${{ steps.evaluate.outputs.should_alert }}
      alert_level: ${{ steps.evaluate.outputs.alert_level }}
      alert_message: ${{ steps.evaluate.outputs.alert_message }}
      
    steps:
    - name: ðŸš¨ è©•ä¼°è­¦å ±æ¢ä»¶
      id: evaluate
      run: |
        echo "ðŸš¨ è©•ä¼°è­¦å ±æ¢ä»¶..."
        
        should_alert=false
        alert_level="info"
        alert_messages=()
        
        # è©•ä¼° Telegram Bot ç‹€æ…‹
        telegram_status="${{ needs.telegram-bot-monitoring.outputs.status }}"
        telegram_errors="${{ needs.telegram-bot-monitoring.outputs.error_count }}"
        telegram_response_time="${{ needs.telegram-bot-monitoring.outputs.response_time }}"
        
        if [ "$telegram_status" = "unhealthy" ]; then
          should_alert=true
          alert_level="critical"
          alert_messages+=("âŒ Telegram Bot å¥åº·æª¢æŸ¥å¤±æ•—")
        elif [ "$telegram_errors" -gt "${{ env.ALERT_THRESHOLD }}" ]; then
          should_alert=true
          alert_level="warning"
          alert_messages+=("âš ï¸ Telegram Bot éŒ¯èª¤éŽå¤š: $telegram_errors")
        elif [ "$telegram_response_time" -gt 3000 ] && [ "$telegram_response_time" -gt 0 ]; then
          should_alert=true
          alert_level="warning"
          alert_messages+=("âš ï¸ Telegram Bot éŸ¿æ‡‰æ™‚é–“éŽæ…¢: ${telegram_response_time}ms")
        fi
        
        # è©•ä¼° LINE Bot ç‹€æ…‹
        line_status="${{ needs.line-bot-monitoring.outputs.status }}"
        line_errors="${{ needs.line-bot-monitoring.outputs.error_count }}"
        line_response_time="${{ needs.line-bot-monitoring.outputs.response_time }}"
        
        if [ "$line_status" = "unhealthy" ]; then
          should_alert=true
          alert_level="critical"
          alert_messages+=("âŒ LINE Bot å¥åº·æª¢æŸ¥å¤±æ•—")
        elif [ "$line_errors" -gt "${{ env.ALERT_THRESHOLD }}" ]; then
          should_alert=true
          alert_level="warning"
          alert_messages+=("âš ï¸ LINE Bot éŒ¯èª¤éŽå¤š: $line_errors")
        fi
        
        # è©•ä¼° API ç‹€æ…‹
        google_api_status="${{ needs.api-status-monitoring.outputs.google_api_status }}"
        notion_api_status="${{ needs.api-status-monitoring.outputs.notion_api_status }}"
        
        if [ "$google_api_status" = "unreachable" ]; then
          should_alert=true
          alert_level="critical"
          alert_messages+=("âŒ Google AI API ä¸å¯é”")
        fi
        
        if [ "$notion_api_status" = "unreachable" ]; then
          should_alert=true
          alert_level="critical"
          alert_messages+=("âŒ Notion API ä¸å¯é”")
        fi
        
        # å»ºæ§‹è­¦å ±è¨Šæ¯
        if [ ${#alert_messages[@]} -gt 0 ]; then
          alert_message=$(IFS=$'\n'; echo "${alert_messages[*]}")
        else
          alert_message="âœ… æ‰€æœ‰æœå‹™é‹è¡Œæ­£å¸¸"
        fi
        
        echo "should_alert=$should_alert" >> $GITHUB_OUTPUT
        echo "alert_level=$alert_level" >> $GITHUB_OUTPUT
        echo "alert_message<<EOF" >> $GITHUB_OUTPUT
        echo "$alert_message" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        echo ""
        echo "ðŸš¨ è­¦å ±è©•ä¼°çµæžœ:"
        echo "- éœ€è¦è­¦å ±: $should_alert"
        echo "- è­¦å ±ç´šåˆ¥: $alert_level"
        echo "- è­¦å ±è¨Šæ¯:"
        echo "$alert_message"

  send-alerts:
    name: ðŸ“¢ ç™¼é€è­¦å ±
    runs-on: ubuntu-latest
    needs: [service-discovery, telegram-bot-monitoring, line-bot-monitoring, api-status-monitoring, alert-evaluation]
    if: needs.alert-evaluation.outputs.should_alert == 'true'
    
    steps:
    - name: ðŸ“¢ ç™¼é€ GitHub Issue è­¦å ±
      if: needs.alert-evaluation.outputs.alert_level == 'critical'
      uses: actions-ecosystem/action-create-issue@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        title: "ðŸš¨ ç³»çµ±ç›£æŽ§è­¦å ± - ${{ needs.alert-evaluation.outputs.alert_level }}"
        body: |
          ## ðŸš¨ ç³»çµ±ç›£æŽ§æª¢æ¸¬åˆ°å•é¡Œ
          
          **è­¦å ±ç´šåˆ¥**: ${{ needs.alert-evaluation.outputs.alert_level }}
          **æª¢æ¸¬æ™‚é–“**: ${{ github.event.schedule || github.run_id }}
          
          ### ðŸ“Š æœå‹™ç‹€æ…‹
          
          **Telegram Bot**:
          - ç‹€æ…‹: ${{ needs.telegram-bot-monitoring.outputs.status || 'æœªæª¢æŸ¥' }}
          - éŸ¿æ‡‰æ™‚é–“: ${{ needs.telegram-bot-monitoring.outputs.response_time || 'N/A' }}ms
          - éŒ¯èª¤è¨ˆæ•¸: ${{ needs.telegram-bot-monitoring.outputs.error_count || '0' }}
          
          **LINE Bot**:
          - ç‹€æ…‹: ${{ needs.line-bot-monitoring.outputs.status || 'æœªæª¢æŸ¥' }}
          - éŸ¿æ‡‰æ™‚é–“: ${{ needs.line-bot-monitoring.outputs.response_time || 'N/A' }}ms
          - éŒ¯èª¤è¨ˆæ•¸: ${{ needs.line-bot-monitoring.outputs.error_count || '0' }}
          
          **å¤–éƒ¨ API**:
          - Google AI API: ${{ needs.api-status-monitoring.outputs.google_api_status || 'æœªæª¢æŸ¥' }}
          - Notion API: ${{ needs.api-status-monitoring.outputs.notion_api_status || 'æœªæª¢æŸ¥' }}
          
          ### âš ï¸ å…·é«”å•é¡Œ
          
          ${{ needs.alert-evaluation.outputs.alert_message }}
          
          ### ðŸ”§ å»ºè­°è¡Œå‹•
          
          1. æª¢æŸ¥ [Zeabur Dashboard](https://dash.zeabur.com/) æœå‹™ç‹€æ…‹
          2. æŸ¥çœ‹æ‡‰ç”¨æ—¥èªŒæŽ’æŸ¥å•é¡Œ
          3. ç¢ºèªå¤–éƒ¨ API æœå‹™å¯ç”¨æ€§
          4. å¿…è¦æ™‚åŸ·è¡Œæœå‹™é‡å•Ÿæˆ–å›žæ»¾
          
          ### ðŸ”— ç›¸é—œé€£çµ
          
          - [ç›£æŽ§å·¥ä½œæµæ—¥èªŒ](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [Zeabur Dashboard](https://dash.zeabur.com/)
          
          ---
          *æ­¤è­¦å ±ç”±è‡ªå‹•ç›£æŽ§ç³»çµ±ç”Ÿæˆ*
        labels: |
          bug
          monitoring
          ${{ needs.alert-evaluation.outputs.alert_level }}
          
    - name: ðŸ“ è¨˜éŒ„è­¦å ±åˆ° workflow ç¸½çµ
      run: |
        echo "ðŸ“ è¨˜éŒ„è­¦å ±ä¿¡æ¯..."
        
        echo "## ðŸš¨ ç›£æŽ§è­¦å ±å ±å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**è­¦å ±ç´šåˆ¥**: ${{ needs.alert-evaluation.outputs.alert_level }}" >> $GITHUB_STEP_SUMMARY
        echo "**æª¢æ¸¬æ™‚é–“**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š æœå‹™ç‹€æ…‹ç¸½è¦½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Telegram Bot ç‹€æ…‹
        if [ "${{ needs.telegram-bot-monitoring.outputs.status }}" != "" ]; then
          echo "**ðŸ“± Telegram Bot**: ${{ needs.telegram-bot-monitoring.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- éŸ¿æ‡‰æ™‚é–“: ${{ needs.telegram-bot-monitoring.outputs.response_time }}ms" >> $GITHUB_STEP_SUMMARY
          echo "- éŒ¯èª¤è¨ˆæ•¸: ${{ needs.telegram-bot-monitoring.outputs.error_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # LINE Bot ç‹€æ…‹
        if [ "${{ needs.line-bot-monitoring.outputs.status }}" != "" ]; then
          echo "**ðŸ“ž LINE Bot**: ${{ needs.line-bot-monitoring.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- éŸ¿æ‡‰æ™‚é–“: ${{ needs.line-bot-monitoring.outputs.response_time }}ms" >> $GITHUB_STEP_SUMMARY
          echo "- éŒ¯èª¤è¨ˆæ•¸: ${{ needs.line-bot-monitoring.outputs.error_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # API ç‹€æ…‹
        echo "**ðŸ”— å¤–éƒ¨ API**:" >> $GITHUB_STEP_SUMMARY
        echo "- Google AI API: ${{ needs.api-status-monitoring.outputs.google_api_status }}" >> $GITHUB_STEP_SUMMARY
        echo "- Notion API: ${{ needs.api-status-monitoring.outputs.notion_api_status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### âš ï¸ è­¦å ±è©³æƒ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "${{ needs.alert-evaluation.outputs.alert_message }}" >> $GITHUB_STEP_SUMMARY

  generate-report:
    name: ðŸ“ˆ ç”Ÿæˆç›£æŽ§å ±å‘Š
    runs-on: ubuntu-latest
    needs: [service-discovery, telegram-bot-monitoring, line-bot-monitoring, api-status-monitoring, alert-evaluation]
    if: always()
    
    steps:
    - name: ðŸ“ˆ ç”Ÿæˆç¶œåˆç›£æŽ§å ±å‘Š
      run: |
        echo "ðŸ“ˆ **ç³»çµ±ç›£æŽ§å ±å‘Š**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æª¢æŸ¥æ™‚é–“**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "**æª¢æŸ¥é¡žåž‹**: ${{ env.CHECK_TYPE }}" >> $GITHUB_STEP_SUMMARY
        echo "**ç›£æŽ§ç¯„åœ**: ${{ env.SERVICE_TO_CHECK }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æœå‹™ç‹€æ…‹ç¸½è¦½
        echo "## ðŸ“Š æœå‹™ç‹€æ…‹ç¸½è¦½" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        overall_status="âœ… æ­£å¸¸"
        
        # Telegram Bot
        telegram_status="${{ needs.telegram-bot-monitoring.outputs.status }}"
        if [ "$telegram_status" != "" ]; then
          if [ "$telegram_status" = "healthy" ]; then
            echo "- ðŸ“± **Telegram Bot**: âœ… æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ“± **Telegram Bot**: âŒ ç•°å¸¸" >> $GITHUB_STEP_SUMMARY
            overall_status="âš ï¸ æœ‰å•é¡Œ"
          fi
          echo "  - éŸ¿æ‡‰æ™‚é–“: ${{ needs.telegram-bot-monitoring.outputs.response_time }}ms" >> $GITHUB_STEP_SUMMARY
          echo "  - URL: ${{ needs.service-discovery.outputs.telegram_url }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ðŸ“± **Telegram Bot**: â­ï¸ æœªæª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        # LINE Bot
        line_status="${{ needs.line-bot-monitoring.outputs.status }}"
        if [ "$line_status" != "" ]; then
          if [ "$line_status" = "healthy" ]; then
            echo "- ðŸ“ž **LINE Bot**: âœ… æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ðŸ“ž **LINE Bot**: âŒ ç•°å¸¸" >> $GITHUB_STEP_SUMMARY
            overall_status="âš ï¸ æœ‰å•é¡Œ"
          fi
          echo "  - éŸ¿æ‡‰æ™‚é–“: ${{ needs.line-bot-monitoring.outputs.response_time }}ms" >> $GITHUB_STEP_SUMMARY
          echo "  - URL: ${{ needs.service-discovery.outputs.line_url }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ðŸ“ž **LINE Bot**: â­ï¸ æœªæª¢æŸ¥" >> $GITHUB_STEP_SUMMARY
        fi
        
        # API ç‹€æ…‹
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ”— å¤–éƒ¨ API ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        google_status="${{ needs.api-status-monitoring.outputs.google_api_status }}"
        notion_status="${{ needs.api-status-monitoring.outputs.notion_api_status }}"
        
        if [ "$google_status" = "reachable" ]; then
          echo "- ðŸ¤– **Google AI API**: âœ… å¯é”" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ðŸ¤– **Google AI API**: âŒ ä¸å¯é”" >> $GITHUB_STEP_SUMMARY
          overall_status="âš ï¸ æœ‰å•é¡Œ"
        fi
        
        if [ "$notion_status" = "reachable" ]; then
          echo "- ðŸ“ **Notion API**: âœ… å¯é”" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ðŸ“ **Notion API**: âŒ ä¸å¯é”" >> $GITHUB_STEP_SUMMARY
          overall_status="âš ï¸ æœ‰å•é¡Œ"
        fi
        
        # ç¸½é«”ç‹€æ…‹
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸŽ¯ ç¸½é«”ç‹€æ…‹" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ç³»çµ±ç‹€æ…‹**: $overall_status" >> $GITHUB_STEP_SUMMARY
        
        # è­¦å ±ç‹€æ…‹
        if [ "${{ needs.alert-evaluation.outputs.should_alert }}" = "true" ]; then
          echo "**è­¦å ±ç‹€æ…‹**: ðŸš¨ æœ‰è­¦å ± (${{ needs.alert-evaluation.outputs.alert_level }})" >> $GITHUB_STEP_SUMMARY
        else
          echo "**è­¦å ±ç‹€æ…‹**: âœ… æ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*æ­¤å ±å‘Šç”±è‡ªå‹•ç›£æŽ§ç³»çµ±ç”Ÿæˆæ–¼ $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> $GITHUB_STEP_SUMMARY